<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¼Šå¯ Yike | æƒ…ä¾£å°çª</title>
    
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', '"PingFang SC"', 'sans-serif'] },
                    colors: {
                        // è«å…°è¿ªè‰²ç³» (æ¸©æš–å’Œè°)
                        bg: '#FDFBF7',
                        card: '#FFFFFF',
                        primary: '#D4A5A5',      // è±†æ²™ç²‰
                        primaryLight: '#E8CFC8',
                        secondary: '#A8B5B8',    // ç°è“
                        secondaryLight: '#C5D6D8',
                        accent: '#B8C9BC',       // ç°ç»¿
                        accentLight: '#D4E4DE',
                        yellow: '#E8DCCA',       // å¥¶é»„
                        yellowLight: '#F5EFE0',
                        text: '#5C5552',
                        textLight: '#9E9591',
                        textLighter: '#C4BEB9',
                        danger: '#D98181',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-soft': 'pulse 3s ease-in-out infinite',
                        'bounce-subtle': 'bounce-subtle 2s ease infinite',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'pulse-soft': { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                        'bounce-subtle': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-3px)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                    }
                }
            }
        }
    </script>
    
    <!-- æ ¸å¿ƒä¾èµ–åº“ (å›½å†… CDN) -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.staticfile.net/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.staticfile.net/peerjs/1.5.2/peerjs.min.js"></script>

    <style>
        body { background: #E5E7EB; display: flex; justify-content: center; margin: 0; min-height: 100vh; }
        #app { width: 100%; max-width: 420px; height: 100dvh; background: #FDFBF7; position: relative; overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.08); }
        .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.6); }
        .glass-dark { background: rgba(255,255,255,0.5); backdrop-filter: blur(8px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å½•éŸ³åŠ¨ç”» */
        .recording-wave { animation: wave 1s ease-in-out infinite; }
        .recording-wave:nth-child(2) { animation-delay: 0.2s; }
        .recording-wave:nth-child(3) { animation-delay: 0.4s; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
        
        /* åˆ é™¤æ»‘åŠ¨ */
        .delete-btn { transition: transform 0.2s; }
        .delete-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="app">
        <div id="root"></div>
    </div>

    <!-- ä¸šåŠ¡é€»è¾‘ -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- å·¥å…·å‡½æ•° ---
        const generateId = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        const formatTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        };
        const formatDateOnly = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        };
        const getDays = (ts) => {
            if (!ts) return 0;
            const start = new Date(ts);
            const now = new Date();
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            return Math.floor((now - start) / (1000 * 60 * 60 * 24));
        };

        // --- å›¾æ ‡åº“ ---
        const Icons = {
            Heart: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Home: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Msg: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            List: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Plus: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Send: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Check: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Setting: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Mic: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            MicOff: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Trash: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Clock: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Calendar: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Close: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Play: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Delete: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Copy: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Star: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        };

        // ================= ä¸»åº”ç”¨ =================
        function App() {
            const [view, setView] = useState('loading');
            const [tab, setTab] = useState('home');
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState(null);
            
            // æ•°æ®
            const [myId, setMyId] = useState('');
            const [partnerId, setPartnerId] = useState('');
            const [anniversary, setAnniversary] = useState(null);
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            
            // è¿æ¥
            const [connStatus, setConnStatus] = useState('disconnected'); // disconnected, connecting, connected
            const [conn, setConn] = useState(null);
            const peerRef = useRef(null);
            const retryCount = useRef(0);

            // åˆå§‹åŒ–
            useEffect(() => {
                const init = async () => {
                    const savedMyId = localStorage.getItem('yike_myId');
                    const savedPartner = localStorage.getItem('yike_partnerId');
                    const savedAnniversary = localStorage.getItem('yike_anniversary');
                    
                    if (savedAnniversary) setAnniversary(Number(savedAnniversary));
                    
                    // è¯»å– IndexedDB
                    const msgs = await localforage.getItem('yike_msgs') || [];
                    const todos = await localforage.getItem('yike_todos') || [];
                    setMessages(msgs);
                    setTodos(todos);

                    if (savedMyId && savedPartner) {
                        setMyId(savedMyId);
                        setPartnerId(savedPartner);
                        setView('home');
                        initPeer(savedMyId, savedPartner);
                    } else {
                        setView('login');
                    }
                };
                
                setTimeout(init, 600);
            }, []);

            // è¿æ¥é€»è¾‘ (æ”¹è¿›ç‰ˆ)
            const initPeer = useCallback((id, pid, mode = 'connect') => {
                if (peerRef.current) {
                    try { peerRef.current.destroy(); } catch(e) {}
                }
                
                setConnStatus('connecting');
                console.log(`Connecting: ${id} -> ${pid}, Mode: ${mode}`);

                // é™åˆ¶é‡è¯•æ¬¡æ•°
                if (mode === 'connect') retryCount.current++;

                const peer = new Peer(id, {
                    debug: 0,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                });
                peerRef.current = peer;

                // 7ç§’è¶…æ—¶
                const timer = setTimeout(() => {
                    setConnStatus('disconnected');
                    if (pid && mode === 'connect' && retryCount.current < 3) {
                        console.log('Timeout, retrying...');
                        setTimeout(() => initPeer(id, pid, 'connect'), 1000);
                    } else if (pid) {
                        showToast('è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                    }
                }, 7000);

                peer.on('open', (myPeerId) => {
                    console.log('Peer open:', myPeerId);
                    if (mode === 'create') {
                        setConnStatus('waiting'); // ç­‰å¾…å¯¹æ–¹è¿æ¥
                    }
                });

                peer.on('connection', (c) => {
                    // å¯¹æ–¹è¿æ¥æˆ‘
                    clearTimeout(timer);
                    setupConnection(c);
                });

                peer.on('error', (err) => {
                    console.error('Peer Error:', err);
                    clearTimeout(timer);
                    setConnStatus('disconnected');
                    
                    if (err.type === 'peer-unavailable') {
                        showToast('æš—å·æ— æ•ˆæˆ–å¯¹æ–¹ç¦»çº¿');
                    } else if (err.type === 'unavailable-id') {
                        showToast('æš—å·å·²è¢«å ç”¨ï¼Œè¯·åˆ·æ–°é‡è¯•');
                        // æ¸…é™¤æœ¬åœ°å­˜å‚¨é‡æ–°å¼€å§‹
                        localStorage.removeItem('yike_myId');
                        localStorage.removeItem('yike_partnerId');
                    } else if (err.type === 'network-disconnected') {
                        showToast('ç½‘ç»œæ–­å¼€');
                    }
                });

                // æˆ‘è¿æ¥å¯¹æ–¹
                if (mode === 'connect' && pid) {
                    const c = peer.connect(pid, { reliable: true });
                    setupConnection(c);
                }
            }, []);

            const setupConnection = (c) => {
                c.on('open', () => {
                    setConnStatus('connected');
                    setConn(c);
                    retryCount.current = 0;
                    showToast('â¤ï¸ è¿æ¥æˆåŠŸ');
                    clearTimeout(7000);
                });

                c.on('data', (data) => {
                    if (data.type === 'msg') {
                        setMessages(prev => {
                            const newMsgs = [...prev, data.payload];
                            localforage.setItem('yike_msgs', newMsgs);
                            return newMsgs;
                        });
                    } else if (data.type === 'todo') {
                        setTodos(prev => {
                            const newTodos = [...prev, data.payload];
                            localforage.setItem('yike_todos', newTodos);
                            return newTodos;
                        });
                    } else if (data.type === 'anniversary') {
                        setAnniversary(data.payload);
                    }
                    showToast('æ”¶åˆ°æ–°æ¶ˆæ¯');
                });

                c.on('close', () => {
                    setConnStatus('disconnected');
                    setConn(null);
                    showToast('è¿æ¥å·²æ–­å¼€');
                });
            };

            // å‘é€æ•°æ®
            const sendData = (type, payload) => {
                if (type === 'msg') {
                    const newMsg = { ...payload, self: true };
                    setMessages(prev => {
                        const newMsgs = [...prev, newMsg];
                        localforage.setItem('yike_msgs', newMsgs);
                        return newMsgs;
                    });
                } else if (type === 'todo') {
                    const newTodo = { ...payload, self: true };
                    setTodos(prev => {
                        const newTodos = [...prev, newTodo];
                        localforage.setItem('yike_todos', newTodos);
                        return newTodos;
                    });
                } else if (type === 'anniversary') {
                    setAnniversary(payload);
                    localStorage.setItem('yike_anniversary', payload);
                }

                if (conn && conn.open) {
                    conn.send({ type, payload });
                }
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 2500);
            };

            // è§†å›¾
            if (view === 'loading') {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-bg">
                        <div className="relative mb-6">
                            <div className="w-16 h-16 rounded-full bg-primary/20 animate-pulse-soft flex items-center justify-center">
                                <Icons.Heart className="w-8 h-8 text-primary" />
                            </div>
                        </div>
                        <p className="text-textLight">æ­£åœ¨æ­å»ºå°çª...</p>
                    </div>
                );
            }

            if (view === 'login') return (
                <LoginView 
                    onCreate={(id) => {
                        setMyId(id);
                        localStorage.setItem('yike_myId', id);
                        localStorage.setItem('yike_partnerId', '');
                        setView('login');
                        initPeer(id, null, 'create');
                    }}
                    onJoin={(id, pid) => {
                        setMyId(id);
                        setPartnerId(pid);
                        localStorage.setItem('yike_myId', id);
                        localStorage.setItem('yike_partnerId', pid);
                        setView('home');
                        initPeer(id, pid, 'join');
                    }}
                    myId={myId}
                    connStatus={connStatus}
                />
            );

            const days = getDays(anniversary);
            const timelineData = [...messages.map(m => ({...m, kind: 'msg'})), ...todos.map(t => ({...t, kind: 'todo'}))].sort((a, b) => b.ts - a.ts);

            return (
                <div className="h-full flex flex-col bg-bg relative overflow-hidden">
                    {/* èƒŒæ™¯ */}
                    <div className="absolute inset-0 pointer-events-none">
                        <div className="absolute top-[-15%] right-[-10%] w-[70%] h-[70%] rounded-full bg-primary/15 blur-[80px]"></div>
                        <div className="absolute bottom-[-15%] left-[-10%] w-[70%] h-[70%] rounded-full bg-secondaryLight/30 blur-[80px]"></div>
                    </div>

                    {/* é¡¶éƒ¨ */}
                    <header className="relative z-10 px-6 pt-6 pb-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className={`w-2.5 h-2.5 rounded-full transition-all ${connStatus === 'connected' ? 'bg-accent shadow-[0_0_8px_#B8C9BC]' : connStatus === 'connecting' || connStatus === 'waiting' ? 'bg-yellow-400 animate-pulse' : 'bg-gray-300'}`}></div>
                            <span className="text-xs font-medium text-textLight">{connStatus === 'connected' ? 'TA åœ¨çº¿' : connStatus === 'connecting' ? 'å¯»æ‰¾ä¸­...' : 'ç­‰å¾…è¿æ¥'}</span>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-2 rounded-full text-textLight hover:bg-white/60 transition-colors">
                            <Icons.Setting className="w-5 h-5" />
                        </button>
                    </header>

                    {/* çºªå¿µæ—¥å¡ç‰‡ */}
                    <div className="px-6 pb-4 relative z-10">
                        <div className="glass rounded-3xl p-5 shadow-sm flex items-center justify-between">
                            <div>
                                <div className="flex items-baseline gap-1">
                                    <p className="text-xs text-textLight">ç›¸çˆ±</p>
                                    <span className="text-4xl font-extrabold text-text">{days}</span>
                                    <span className="text-lg text-textLight font-medium">å¤©</span>
                                </div>
                                {anniversary && <p className="text-xs text-textLight mt-1">å§‹äº {formatDateOnly(anniversary)}</p>}
                            </div>
                            <div className="w-14 h-14 rounded-full bg-primary/20 flex items-center justify-center text-primary animate-float">
                                <Icons.Heart className="w-7 h-7" />
                            </div>
                        </div>
                    </div>

                    {/* å†…å®¹åŒº */}
                    <main className="flex-1 overflow-y-auto hide-scrollbar px-4 pb-28 relative z-0">
                        {tab === 'home' && (
                            <div className="space-y-3 pt-2">
                                {timelineData.map((item, i) => (
                                    <div key={i} className="animate-slide-up" style={{animationDelay: `${i * 0.05}s`}}>
                                        {item.kind === 'msg' ? <MsgCard msg={item} /> : <TodoCardMini todo={item} />}
                                    </div>
                                ))}
                                {timelineData.length === 0 && (
                                    <div className="text-center mt-20">
                                        <div className="text-5xl mb-4">ğŸŒ±</div>
                                        <p className="text-textLight">å°çªè¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»ç§ä¸‹ç§å­å§</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {tab === 'msg' && (
                            <TreeHoleView 
                                messages={messages} 
                                onSend={(text) => sendData('msg', { id: generateId(), text, ts: Date.now() })} 
                            />
                        )}

                        {tab === 'todo' && (
                            <TodoView 
                                todos={todos} 
                                onAdd={(text) => sendData('todo', { id: generateId(), text, done: false, ts: Date.now() })}
                                onToggle={(todo) => sendData('todo', { ...todo, done: !todo.done })}
                                onDelete={(id) => {
                                    setTodos(prev => {
                                        const filtered = prev.filter(t => t.id !== id);
                                        localforage.setItem('yike_todos', filtered);
                                        return filtered;
                                    });
                                }}
                            />
                        )}
                    </main>

                    {/* åº•éƒ¨å¯¼èˆª */}
                    <nav className="absolute bottom-6 left-6 right-6 z-30">
                        <div className="glass rounded-full p-2.5 flex justify-between items-center shadow-lg border border-white/50">
                            <NavBtn 
                                icon={<Icons.List className="w-5 h-5"/>} 
                                active={tab === 'todo'} 
                                onClick={() => setTab('todo')}
                                color="text-secondary"
                            />
                            <NavBtn 
                                icon={<Icons.Msg className="w-5 h-5"/>} 
                                active={tab === 'msg'} 
                                onClick={() => setTab('msg')}
                                color="text-primary"
                            />
                            
                            {/* Home Button */}
                            <button 
                                onClick={() => setTab('home')} 
                                className={`w-14 h-14 -mt-5 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 ${
                                    tab === 'home' 
                                    ? 'bg-primary text-white scale-110' 
                                    : 'bg-white text-primary'
                                }`}
                            >
                                <Icons.Home className="w-6 h-6" />
                            </button>
                            
                            <div className="w-8"></div>
                            <div className="w-8"></div>
                        </div>
                    </nav>

                    {/* å¼¹çª— */}
                    {showSettings && (
                        <SettingsView 
                            anniversary={anniversary} 
                            onSave={(ts) => {
                                sendData('anniversary', ts);
                                setShowSettings(false);
                            }}
                            onClose={() => setShowSettings(false)}
                        />
                    )}

                    {/* Toast */}
                    {toast && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-5 py-2.5 rounded-full shadow-lg text-sm font-bold text-text z-50 animate-slide-up">
                            {toast}
                        </div>
                    )}
                </div>
            );
        }

        // ================= ç™»å½•ç»„ä»¶ =================
        function LoginView({ onCreate, onJoin, myId, connStatus }) {
            const [mode, setMode] = useState(null);
            const [inputCode, setInputCode] = useState('');

            const handleCopy = () => {
                navigator.clipboard.writeText(myId);
                alert('æš—å·å·²å¤åˆ¶');
            };

            // æ˜¾ç¤ºç»“æœé¡µ
            if (mode === 'create' && myId) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-bg p-6 relative">
                        {/* è£…é¥° */}
                        <div className="absolute top-20 text-6xl opacity-10">ğŸŒ¸</div>
                        
                        <h1 className="text-5xl font-extrabold text-primary mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                        <p className="text-textLight mb-8 text-sm">æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                        
                        <div className="w-full bg-white rounded-3xl p-6 text-center shadow-sm border border-primary/10 mb-6">
                            <div className="text-xs text-textLight mb-3 uppercase tracking-wider">ä¸“å±æš—å·</div>
                            <div onClick={handleCopy} className="group relative bg-yellowLight/50 p-4 rounded-xl cursor-pointer hover:bg-yellowLight transition-colors">
                                <p className="text-lg font-mono font-bold text-text break-all select-all">{myId}</p>
                                <div className="absolute top-2 right-2 text-textLighter opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Icons.Copy className="w-4 h-4" />
                                </div>
                            </div>
                            <p className="text-xs text-textLighter mt-3">ç‚¹å‡»æš—å·å³å¯å¤åˆ¶ï¼Œå‘é€ç»™ TA</p>
                        </div>
                        
                        <div className="flex items-center gap-2 text-sm text-textLight bg-white/50 px-4 py-2 rounded-full">
                            {connStatus === 'waiting' ? (
                                <>
                                    <div className="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                                    <span>ç­‰å¾… TA è¾“å…¥æš—å·...</span>
                                </>
                            ) : (
                                <span>ç­‰å¾…ç”Ÿæˆä¸­...</span>
                            )}
                        </div>
                        
                        <button onClick={() => setMode(null)} className="mt-8 text-sm text-textLighter hover:text-text transition-colors">è¿”å›</button>
                    </div>
                );
            }

            // åŠ å…¥é¡µ
            if (mode === 'join') {
                return (
                    <div className="h-full flex flex-col justify-center bg-bg p-6">
                        <h1 className="text-3xl font-bold text-text text-center mb-8">æ‰¾åˆ°å½¼æ­¤</h1>
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                            <div className="p-4 border-b border-gray-50">
                                <input 
                                    className="w-full text-center text-lg font-mono outline-none bg-transparent placeholder-textLighter"
                                    placeholder="ç²˜è´´ TA å‘æ¥çš„æš—å·"
                                    value={inputCode}
                                    onChange={e => setInputCode(e.target.value)}
                                />
                            </div>
                        </div>
                        <button 
                            onClick={() => {
                                if (!inputCode.trim()) return alert('è¯·è¾“å…¥æš—å·');
                                const id = 'yike_' + generateId();
                                onJoin(id, inputCode.trim());
                            }} 
                            className="mt-6 w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                        >
                            ç‰µæ‰‹ TA
                        </button>
                        <button onClick={() => setMode(null)} className="mt-4 text-center text-sm text-textLighter">è¿”å›</button>
                    </div>
                );
            }

            // é¦–é¡µ
            return (
                <div className="h-full flex flex-col items-center justify-center bg-bg p-6">
                    <div className="mb-2 relative">
                        <div className="w-20 h-20 rounded-full bg-primary/20 flex items-center justify-center animate-pulse-soft">
                            <Icons.Heart className="w-10 h-10 text-primary" />
                        </div>
                    </div>
                    <h1 className="text-5xl font-extrabold text-primary mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                    <p className="text-textLight mb-12 text-sm">æ­å»ºåªå±äºæˆ‘ä»¬çš„æ•°å­—å°çª</p>
                    
                    <button 
                        onClick={() => {
                            const id = 'yike_' + generateId();
                            onCreate(id);
                            setMode('create');
                        }} 
                        className="w-full py-4 bg-white text-text rounded-2xl font-bold shadow-sm mb-4 active:scale-95 transition-transform border border-gray-100"
                    >
                        åˆ›å»ºå°çª
                    </button>
                    <button 
                        onClick={() => setMode('join')} 
                        className="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                    >
                        è¾“å…¥æš—å·ç‰µæ‰‹
                    </button>
                </div>
            );
        }

        // ================= æ ‘æ´ç»„ä»¶ =================
        function TreeHoleView({ messages, onSend }) {
            const [text, setText] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [audioURL, setAudioURL] = useState(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);

            const handleSend = () => {
                if (!text.trim() && !audioURL) return;
                if (text.trim()) onSend(text);
                // è¯­éŸ³å‘é€é€»è¾‘ç±»ä¼¼...
                setText('');
                setAudioURL(null);
            };

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    
                    mediaRecorderRef.current.ondataavailable = (e) => chunksRef.current.push(e.data);
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        setAudioURL(url);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                } catch (e) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·åœ¨ HTTPS ç¯å¢ƒæˆ– localhost ä¸‹ä½¿ç”¨');
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current) {
                    mediaRecorderRef.current.stop();
                }
                setIsRecording(false);
            };

            return (
                <div className="flex flex-col h-full pb-24">
                    <div className="flex-1 overflow-y-auto hide-scrollbar space-y-3">
                        {messages.map(m => (
                            <MsgCard key={m.id} msg={m} />
                        ))}
                        {messages.length === 0 && (
                            <div className="text-center mt-20">
                                <div className="text-5xl mb-4">ğŸ“®</div>
                                <p className="text-textLight text-sm">æ ‘æ´ç©ºç©ºè¡è¡...</p>
                            </div>
                        )}
                    </div>
                    
                    <div className="fixed bottom-6 left-6 right-6 z-20">
                        {audioURL && (
                            <div className="mb-2 bg-white rounded-xl p-2 flex items-center gap-2 shadow-sm animate-slide-up">
                                <button className="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center">
                                    <Icons.Play className="w-3 h-3" />
                                </button>
                                <div className="flex-1 h-8 bg-yellowLight rounded-lg flex items-center px-2">
                                    <div className="w-full h-1 bg-primary/30 rounded-full overflow-hidden">
                                        <div className="w-1/3 h-full bg-primary animate-pulse-soft"></div>
                                    </div>
                                </div>
                                <button onClick={() => setAudioURL(null)} className="p-1 text-textLighter">
                                    <Icons.Close className="w-4 h-4" />
                                </button>
                            </div>
                        )}
                        
                        {isRecording && (
                            <div className="mb-2 flex justify-center gap-1 animate-pulse">
                                <div className="w-2 h-8 rounded-full bg-danger recording-wave"></div>
                                <div className="w-2 h-8 rounded-full bg-danger recording-wave"></div>
                                <div className="w-2 h-8 rounded-full bg-danger recording-wave"></div>
                            </div>
                        )}

                        <div className="glass rounded-full p-2 flex items-center shadow-md">
                            <button 
                                onClick={isRecording ? stopRecording : startRecording}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isRecording ? 'bg-danger text-white' : 'text-textLighter hover:bg-white'}`}
                            >
                                {isRecording ? <Icons.MicOff className="w-5 h-5" /> : <Icons.Mic className="w-5 h-5" />}
                            </button>
                            <input 
                                className="flex-1 bg-transparent px-4 py-2 outline-none text-sm"
                                placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
                                value={text}
                                onChange={e => setText(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                            />
                            <button 
                                onClick={handleSend}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${text.trim() ? 'bg-primary text-white scale-100' : 'bg-gray-100 text-gray-300 scale-90'}`}
                                disabled={!text.trim() && !audioURL}
                            >
                                <IconSend />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function IconSend() {
            return (
                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            );
        }

        // ================= å¾…åŠç»„ä»¶ =================
        function TodoView({ todos, onAdd, onToggle, onDelete }) {
            const [text, setText] = useState('');
            const [showDeleteMode, setShowDeleteMode] = useState(false);
            
            const groupedTodos = todos.reduce((acc, todo) => {
                const date = new Date(todo.ts).toLocaleDateString('zh-CN');
                if (!acc[date]) acc[date] = [];
                acc[date].push(todo);
                return acc;
            }, {});

            const handleAdd = () => {
                if (!text.trim()) return;
                onAdd(text);
                setText('');
            };

            return (
                <div className="space-y-4 pb-28">
                    {/* æ·»åŠ æ  */}
                    <div className="flex gap-2">
                        <input 
                            className="flex-1 bg-white p-3 rounded-xl outline-none text-sm shadow-sm placeholder-textLighter"
                            placeholder="æ·»åŠ å°äº‹..."
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleAdd()}
                        />
                        <button 
                            onClick={() => setShowDeleteMode(!showDeleteMode)}
                            className={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors ${showDeleteMode ? 'bg-danger/20 text-danger' : 'bg-white text-textLighter'}`}
                        >
                            <Icons.Trash className="w-5 h-5" />
                        </button>
                        <button 
                            onClick={handleAdd}
                            className="w-12 h-12 rounded-xl bg-primary text-white flex items-center justify-center active:scale-95"
                        >
                            <Icons.Plus className="w-5 h-5" />
                        </button>
                    </div>
                    
                    {/* åˆ†ç±»åˆ—è¡¨ */}
                    {Object.entries(groupedTodos).map(([date, items]) => (
                        <div key={date} className="space-y-2">
                            <div className="flex items-center gap-2 text-xs font-medium text-textLighter py-1">
                                <Icons.Clock className="w-3 h-3" />
                                {date}
                            </div>
                            {items.map(todo => (
                                <div key={todo.id} className={`flex items-center gap-3 bg-white/80 p-3 rounded-xl border border-white/50 transition-all ${showDeleteMode ? 'pr-2' : ''}`}>
                                    <button 
                                        onClick={() => onToggle(todo)}
                                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0 ${todo.done ? 'bg-accent border-accent' : 'border-textLighter/30 hover:border-primary'}`}
                                    >
                                        {todo.done && <Icons.Check className="w-3 h-3 text-white" />}
                                    </button>
                                    <span className={`flex-1 text-sm ${todo.done ? 'line-through text-textLighter' : 'text-text'}`}>{todo.text}</span>
                                    {showDeleteMode && (
                                        <button onClick={() => onDelete(todo.id)} className="p-2 text-danger/70 hover:text-danger delete-btn">
                                            <Icons.Delete className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    ))}
                    
                    {todos.length === 0 && (
                        <div className="text-center mt-16">
                            <div className="text-5xl mb-4">âœ¨</div>
                            <p className="text-textLight text-sm">è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</p>
                        </div>
                    )}
                </div>
            );
        }

        // ================= é€šç”¨ç»„ä»¶ =================
        function NavBtn({ icon, active, onClick, color }) {
            return (
                <button 
                    onClick={onClick} 
                    className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${active ? 'bg-white shadow-sm scale-105' : 'hover:bg-white/50'}`}
                >
                    <div className={active ? `text-${color}` : 'text-textLighter'}>
                        {icon}
                    </div>
                </button>
            );
        }

        function MsgCard({ msg }) {
            return (
                <div className={`flex ${msg.self ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[82%] p-3.5 rounded-2xl shadow-sm text-sm leading-relaxed ${msg.self ? 'bg-primary text-white rounded-br-sm' : 'bg-white text-text rounded-bl-sm'}`}>
                        {msg.text}
                        <div className={`text-[10px] mt-1.5 ${msg.self ? 'text-white/70' : 'text-textLighter'}`}>{formatTime(msg.ts)}</div>
                    </div>
                </div>
            );
        }

        function TodoCardMini({ todo }) {
            return (
                <div className={`flex items-center gap-2 p-2.5 rounded-lg text-xs ${todo.done ? 'bg-white/30 line-through text-textLighter' : 'bg-yellowLight/60 text-text'}`}>
                    <div className={`w-1.5 h-1.5 rounded-full ${todo.done ? 'bg-textLighter' : 'bg-primary'}`}></div>
                    <span className="flex-1 truncate">{todo.text}</span>
                    <span className="text-[10px] opacity-60">{new Date(todo.ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}</span>
                </div>
            );
        }

        // ================= è®¾ç½®ç»„ä»¶ =================
        function SettingsView({ anniversary, onSave, onClose }) {
            const [date, setDate] = useState(anniversary ? formatDateOnly(anniversary) : '');

            return (
                <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
                    <div className="bg-bg w-full max-w-[420px] sm:rounded-t-3xl sm:rounded-b-3xl p-6 animate-slide-up">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-text">å°çªè®¾ç½®</h2>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white text-textLighter flex items-center justify-center hover:bg-gray-100">
                                <Icons.Close className="w-4 h-4" />
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            <div className="space-y-2">
                                <label className="flex items-center gap-2 text-sm font-bold text-text">
                                    <Icons.Calendar className="w-4 h-4 text-primary" />
                                    çºªå¿µæ—¥
                                </label>
                                <input 
                                    type="date" 
                                    className="w-full p-4 rounded-xl bg-white border border-gray-100 outline-none text-text shadow-sm"
                                    value={date}
                                    onChange={e => setDate(e.target.value)}
                                />
                                <p className="text-xs text-textLighter">è®¾ç½®æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©ï¼Œé¦–é¡µä¼šæ˜¾ç¤ºç›¸çˆ±å¤©æ•°</p>
                            </div>
                            
                            <button 
                                onClick={() => onSave(date ? new Date(date).getTime() : Date.now())}
                                className="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                            >
                                ä¿å­˜è®¾ç½®
                            </button>
                            
                            <div className="pt-4 border-t border-gray-100">
                                <button 
                                    onClick={() => {
                                        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                                            localforage.clear().then(() => {
                                                localStorage.clear();
                                                window.location.reload();
                                            });
                                        }
                                    }} 
                                    className="w-full py-3 text-sm text-danger hover:bg-danger/5 rounded-xl transition-colors"
                                >
                                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // æ¸²æŸ“
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
