<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>伊可 Yike - 情侣小窝</title>
    
    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">

    <!-- Tailwind (使用 CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Nunito', 'sans-serif'] }, colors: { yike: { bg: '#FDFBF7', pink: '#E8CFC8', blue: '#D4E4E6', text: '#4A403A', gray: '#9CA3AF' } } } }
        }
    </script>
    <style>
        body { background: #FDFBF7; margin: 0; overflow: hidden; font-family: 'Nunito', sans-serif; }
        /* 动画 */
        .anim-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .anim-slide { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>

    <!-- 依赖库 (按顺序加载) -->
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- LocalForage -->
    <script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- 根容器 -->
    <div id="root"></div>

    <!-- React 逻辑 -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 简单的 ID 生成
        const uid = () => Math.random().toString(36).substr(2, 6);
        const time = (ts) => new Date(ts).toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});

        // 图标
        const Icon = {
            Heart: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Send: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/></svg>,
            Home: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>,
            Msg: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            List: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
        };

        function App() {
            // 状态
            const [page, setPage] = useState('init'); // init, login, home
            const [tab, setTab] = useState('msg'); // msg, todo
            const [msgs, setMsgs] = useState([]);
            const [todos, setTodos] = useState([]);
            const [me, setMe] = useState('');
            const [partner, setPartner] = useState('');
            const [conn, setConn] = useState(null);
            const [status, setStatus] = useState('disconnected'); // connected, disconnected
            
            // 登录表单
            const [inputCode, setInputCode] = useState('');
            const [myCode, setMyCode] = useState('');

            // 初始化
            useEffect(() => {
                const init = async () => {
                    // 读取缓存
                    const savedMe = localStorage.getItem('y_me');
                    const savedPartner = localStorage.getItem('y_partner');
                    
                    // 读取 IndexedDB 数据
                    const m = await localforage.getItem('y_msgs') || [];
                    const t = await localforage.getItem('y_todos') || [];
                    setMsgs(m);
                    setTodos(t);

                    if (savedMe && savedPartner) {
                        setMe(savedMe);
                        setPartner(savedPartner);
                        setPage('home');
                        connectPeer(savedMe, savedPartner);
                    } else {
                        setPage('login');
                    }
                };
                // 稍微延迟，确保库加载完成
                setTimeout(init, 500);
            }, []);

            // P2P 连接逻辑
            const connectPeer = (myId, partnerId) => {
                setStatus('connecting');
                try {
                    const peer = new Peer(myId);
                    
                    // 超时保护：10秒没连上就算失败
                    const timer = setTimeout(() => {
                        setStatus('disconnected');
                        alert("连接超时，请检查网络或重新生成暗号");
                    }, 10000);

                    peer.on('open', () => {
                        const conn = peer.connect(partnerId);
                        conn.on('open', () => {
                            setStatus('connected');
                            setConn(conn);
                            clearTimeout(timer);
                        });
                        conn.on('data', (data) => {
                            if(data.t === 'msg') setMsgs(p => [...p, data.d]);
                            if(data.t === 'todo') setTodos(p => [...p, data.d]);
                        });
                        setConn(conn);
                    });
                    
                    peer.on('error', (err) => {
                        console.error(err);
                        clearTimeout(timer);
                        setStatus('disconnected');
                    });

                } catch(e) {
                    console.error(e);
                    setStatus('disconnected');
                }
            };

            // 发送数据
            const send = (t, d) => {
                // 本地更新
                if(t === 'msg') {
                    setMsgs(p => [...p, {...d, self: true}]);
                    localforage.setItem('y_msgs', [...msgs, {...d, self: true}]);
                }
                if(t === 'todo') {
                    setTodos(p => [...p, {...d, self: true}]);
                    localforage.setItem('y_todos', [...todos, {...d, self: true}]);
                }
                // 发送给对方
                if(conn && conn.open) {
                    conn.send({t, d});
                }
            };

            // --- 页面渲染 ---

            if (page === 'init') return <div className="h-screen flex items-center justify-center text-gray-400">加载资源中...</div>;

            // 登录页
            if (page === 'login') {
                return (
                    <div className="h-screen flex flex-col items-center p-8 pt-20 bg-[#FDFBF7] relative">
                        {/* 背景装饰 */}
                        <div className="absolute top-[-20%] left-[-20%] w-[150%] h-[150%] bg-gradient-to-br from-[#E8CFC8] to-[#D4E4E6] rounded-full blur-[100px] opacity-30 pointer-events-none"></div>
                        
                        <h1 className="text-5xl font-bold text-[#4A403A] mb-2 anim-pop" style={{fontFamily: 'Nunito'}}>Yike</h1>
                        <p className="text-gray-500 mb-12 text-sm">情侣的数字秘密小窝</p>

                        {!myCode ? (
                            <div className="w-full space-y-4 anim-slide">
                                <button onClick={() => {
                                    const code = 'yike_' + uid();
                                    setMyCode(code);
                                }} className="w-full py-4 bg-white shadow-lg rounded-2xl font-bold text-[#4A403A] active:scale-95 transition-transform">创建小窝 (生成暗号)</button>
                                <button onClick={() => setMyCode('JOIN_MODE')} className="w-full py-4 bg-[#E8CFC8] text-white shadow-lg rounded-2xl font-bold active:scale-95 transition-transform">输入暗号来找 TA</button>
                            </div>
                        ) : myCode === 'JOIN_MODE' ? (
                            <div className="w-full space-y-4 anim-slide">
                                <input value={inputCode} onChange={e=>setInputCode(e.target.value)} placeholder="输入对方暗号" className="w-full p-4 bg-white rounded-2xl outline-none text-center font-mono text-lg" />
                                <button onClick={() => {
                                    if(!inputCode) return alert('请输入暗号');
                                    localStorage.setItem('y_me', 'yike_' + uid());
                                    localStorage.setItem('y_partner', inputCode);
                                    window.location.reload();
                                }} className="w-full py-4 bg-[#E8CFC8] text-white shadow-lg rounded-2xl font-bold active:scale-95">牵手</button>
                                <button onClick={() => setMyCode('')} className="text-gray-400 text-sm mt-2">返回</button>
                            </div>
                        ) : (
                            <div className="w-full text-center anim-slide">
                                <div className="bg-white/80 p-6 rounded-2xl mb-6 shadow-sm backdrop-blur">
                                    <p className="text-xs text-gray-400 mb-2">分享给 TA 的暗号 (点击复制)</p>
                                    <div onClick={() => {navigator.clipboard.writeText(myCode); alert('已复制')}} className="text-xl font-mono font-bold text-[#E8CFC8] select-all cursor-pointer">{myCode}</div>
                                </div>
                                <p className="text-sm text-gray-500 animate-pulse">等待 TA 输入暗号连接...</p>
                                <button onClick={() => {
                                    localStorage.setItem('y_me', myCode);
                                    localStorage.setItem('y_partner', '');
                                    alert("已保存为本地记录，下次打开将直接进入。TA 连接时会自动绑定。");
                                    setPage('home');
                                    connectPeer(myCode, '');
                                }} className="mt-8 text-xs text-gray-400 underline">先跳过，自己先用用</button>
                            </div>
                        )}
                    </div>
                );
            }

            // 首页
            const days = Math.floor((Date.now() - localStorage.getItem('y_start') * 1 || Date.now()) / 86400000);

            return (
                <div className="h-screen flex flex-col relative bg-[#FDFBF7]">
                    {/* 背景 */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-[#E8CFC8] rounded-full blur-[80px] opacity-20"></div>
                        <div className="absolute bottom-0 left-0 w-64 h-64 bg-[#D4E4E6] rounded-full blur-[80px] opacity-20"></div>
                    </div>

                    {/* 顶部状态栏 */}
                    <header className="p-6 flex justify-between items-end relative z-10">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <div className={`w-2 h-2 rounded-full ${status === 'connected' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                                <span className="text-xs text-gray-400">{status === 'connected' ? '在线' : '等待连接'}</span>
                            </div>
                            <div className="text-2xl font-bold text-[#4A403A]" style={{fontFamily: 'Nunito'}}>
                                Day <span className="text-[#E8CFC8]">{days}</span>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-gray-400">在一起</div>
                        </div>
                    </header>

                    {/* 内容区 */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 pb-24 relative z-0">
                        {/* 树洞 Tab */}
                        {tab === 'msg' && (
                            <div className="space-y-4">
                                {msgs.map(m => (
                                    <div key={m.id} className={`flex ${m.self ? 'justify-end' : 'justify-start'} anim-slide`}>
                                        <div className={`max-w-[80%] p-3 rounded-2xl text-sm ${m.self ? 'bg-[#E8CFC8] text-white rounded-br-none' : 'bg-white text-gray-700 rounded-bl-none shadow-sm'}`}>
                                            {m.text}
                                            <div className={`text-[10px] mt-1 opacity-60 text-right`}>{time(m.ts)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 待办 Tab */}
                        {tab === 'todo' && (
                            <div className="space-y-3">
                                {todos.map((t, i) => (
                                    <div key={i} className="bg-white p-3 rounded-xl flex items-center gap-3 shadow-sm anim-slide">
                                        <div className={`w-5 h-5 rounded-full border ${t.done ? 'bg-[#D4E4E6] border-[#D4E4E6]' : 'border-gray-300'}`}></div>
                                        <span className={`flex-1 text-sm ${t.done ? 'line-through text-gray-400' : 'text-gray-700'}`}>{t.text}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 输入区域 (仅树洞) */}
                    {tab === 'msg' && (
                        <div className="fixed bottom-24 left-4 right-4 z-20">
                            <div className="bg-white/80 backdrop-blur p-2 rounded-full flex items-center shadow-lg">
                                <input id="msgInput" className="flex-1 bg-transparent px-4 py-2 outline-none text-sm" placeholder="说点什么..." onKeyDown={e => {
                                    if(e.key === 'Enter') {
                                        const val = e.target.value;
                                        if(!val) return;
                                        send('msg', {id: Date.now(), text: val, ts: Date.now()});
                                        e.target.value = '';
                                    }
                                }}/>
                                <button className="w-10 h-10 rounded-full bg-[#E8CFC8] text-white flex items-center justify-center active:scale-90 transition-transform" onClick={() => {
                                    const input = document.getElementById('msgInput');
                                    const val = input.value;
                                    if(!val) return;
                                    send('msg', {id: Date.now(), text: val, ts: Date.now()});
                                    input.value = '';
                                }}>
                                    <Icon.Send />
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 待办添加区 (仅待办) */}
                    {tab === 'todo' && (
                        <div className="fixed bottom-24 left-4 right-4 z-20 flex gap-2">
                             <input id="todoInput" className="flex-1 bg-white p-3 rounded-xl outline-none text-sm shadow-sm" placeholder="添加任务..." onKeyDown={e => {
                                    if(e.key === 'Enter') {
                                        const val = e.target.value;
                                        if(!val) return;
                                        send('todo', {text: val, done: false});
                                        e.target.value = '';
                                    }
                                }}/>
                             <button className="bg-[#D4E4E6] p-3 rounded-xl text-white active:scale-90" onClick={() => {
                                 const input = document.getElementById('todoInput');
                                 if(!input.value) return;
                                 send('todo', {text: input.value, done: false});
                                 input.value = '';
                             }}>+</button>
                        </div>
                    )}

                    {/* 底部导航 */}
                    <nav className="absolute bottom-6 left-6 right-6 z-30">
                        <div className="bg-white/60 backdrop-blur-md p-2 rounded-full flex justify-between items-center shadow-xl border border-white/50">
                            <button onClick={() => setTab('msg')} className={`flex-1 py-3 rounded-full flex justify-center ${tab==='msg'?'bg-white shadow-sm text-[#E8CFC8]':'text-gray-400'}`}>
                                <Icon.Msg />
                            </button>
                            <button className="w-12 h-12 rounded-full bg-[#FDFBF7] flex items-center justify-center shadow-md -mt-2 border border-white">
                                <div className="w-2 h-2 rounded-full bg-[#E8CFC8]"></div>
                            </button>
                            <button onClick={() => setTab('todo')} className={`flex-1 py-3 rounded-full flex justify-center ${tab==='todo'?'bg-white shadow-sm text-[#D4E4E6]':'text-gray-400'}`}>
                                <Icon.List />
                            </button>
                        </div>
                    </nav>
                </div>
            );
        }

        // 渲染
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
