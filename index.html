<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šå¯ - æˆ‘ä»¬çš„æ•°å­—å°çª</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FDFBF7',
                        theme: '#E8CFC8',
                        aux: '#D4E4E6',
                        text: '#4A403A',
                        subText: '#9CA3AF',
                        pink: '#FFB7B2'
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['ZCOOL KuaiLe', 'cursive'],
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ping-once': 'ping 1s cubic-bezier(0, 0, 0.2, 1) 1',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://unpkg.com/framer-motion@10.18.0/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

    <style>
        /* ä¿®å¤ç§»åŠ¨ç«¯ç‚¹å‡»å»¶è¿Ÿ */
        * { touch-action: manipulation; }
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .input-hidden::-webkit-outer-spin-button,
        .input-hidden::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* æœå†»æŒ‰é’®æ ·å¼ */
        .btn-jelly {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-jelly:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-bg text-text antialiased overflow-hidden h-[100dvh] pb-[env(safe-area-inset-bottom)] flex justify-center items-center select-none">

    <div id="root" class="w-full h-full max-w-[400px] mx-auto relative overflow-hidden shadow-2xl bg-bg pb-[env(safe-area-inset-bottom)]"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- å·¥å…·å‡½æ•° ---
        // å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ
        const generateCode = () => {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0].toString(36).substr(2, 6).toUpperCase();
        };
        const formatTime = (date) => new Date(date).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });

        // --- èƒŒæ™¯ç»„ä»¶ ---
        const Background = () => (
            <div className="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
                <div className="absolute top-0 left-0 w-64 h-64 bg-theme rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob"></div>
                <div className="absolute top-0 right-0 w-64 h-64 bg-aux rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob" style={{ animationDelay: '2s' }}></div>
                <div className="absolute -bottom-32 left-20 w-64 h-64 bg-pink rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob" style={{ animationDelay: '4s' }}></div>
            </div>
        );

        // --- Toast æç¤ºç»„ä»¶ ---
        const Toast = ({ show, text }) => (
            <AnimatePresence>
                {show && (
                    <motion.div 
                        initial={{ y: -50, opacity: 0 }}
                        animate={{ y: 20, opacity: 1 }}
                        exit={{ y: -50, opacity: 0 }}
                        className="absolute top-0 left-0 right-0 z-50 flex justify-center px-4 pointer-events-none mt-8"
                    >
                        <div className="bg-white/80 backdrop-blur-md shadow-lg px-5 py-2.5 rounded-full text-xs font-bold text-text border border-white/50 max-w-[80%]">
                            {text}
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        );

        // --- çŠ¶æ€é¡µé¢ï¼šåŠ è½½/é‡è¿ ---
        const LoadingView = ({ status, onReset }) => {
            let content = {
                'INIT': { icon: 'ğŸ ', text: 'æ­£åœ¨æ‰“å¼€å°çª...', sub: '' },
                'RECONNECT': { icon: 'ğŸ§µ', text: 'æ­£åœ¨ç‰µèµ·æ–­æ‰çš„çº¢çº¿...', sub: 'å¦‚æœTAä¸åœ¨çº¿ï¼Œæˆ‘ä»¬ä¼šä¸€ç›´ç­‰' },
                'WAITING_HOST': { icon: 'â³', text: 'ç­‰å¾… TA å›åº”...', sub: 'è¯·æŠŠæš—å·å‘Šè¯‰ TA' },
                'CONNECTING': { icon: 'ğŸšª', text: 'æ­£åœ¨æ•²é—¨...', sub: 'è½»è½»æ•²ä¸€ä¸‹' },
                'ERROR': { icon: 'ğŸ’”', text: 'è¿æ¥å¥½åƒå¤±è´¥äº†', sub: '' }
            }[status];

            if(status === 'ERROR') {
                return (
                    <div className="flex flex-col items-center justify-center h-full p-8 text-center space-y-6">
                        <div className="text-6xl">{content.icon}</div>
                        <h2 className="text-xl font-bold">{content.text}</h2>
                        <p className="text-sm text-subText">{content.sub}</p>
                        <button onClick={onReset} className="px-6 py-2 bg-theme rounded-full text-white font-bold shadow-md btn-jelly">
                            é‡æ–°å°è¯•
                        </button>
                    </div>
                )
            }

            return (
                <motion.div 
                    initial={{ opacity: 0 }} 
                    animate={{ opacity: 1 }}
                    className="flex flex-col items-center justify-center h-full"
                >
                    <div className="text-6xl mb-6 animate-bounce">{content.icon}</div>
                    <h2 className="font-display text-2xl mb-2">{content.text}</h2>
                    <p className="text-sm text-subText">{content.sub}</p>
                </motion.div>
            );
        };

        // --- é¡µé¢ï¼šé¦–æ¬¡å¼•å¯¼ (åˆ›å»º/åŠ å…¥) ---
        const Onboarding = ({ onJoin }) => {
            const [mode, setMode] = useState('choice'); // choice, create, join
            const [inputCode, setInputCode] = useState('');
            const [myCode, setMyCode] = useState('');

            const createNest = () => {
                const code = generateCode();
                setMyCode(code);
                setMode('created');
                // è¿™é‡ŒæŠŠ code å­˜å…¥ localStorage å˜æˆæˆ‘çš„ ID
                localStorage.setItem('yike_my_id', code);
                // å‘Šè¯‰çˆ¶ç»„ä»¶æˆ‘å˜æˆäº† Host
                onJoin(code, 'HOST'); 
            };

            const handleJoin = () => {
                if(inputCode.length !== 6) return; // ç»Ÿä¸€6ä½æ ¡éªŒ
                localStorage.setItem('yike_my_id', 'Guest-' + inputCode); // ä¸´æ—¶ Guest ID
                onJoin(inputCode, 'GUEST');
            };

            return (
                <motion.div 
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -20 }}
                    className="h-full flex flex-col pt-16 px-8 pb-8 justify-center"
                >
                    <AnimatePresence mode="wait">
                        {mode === 'choice' && (
                            <motion.div key="choice" className="space-y-6">
                                <div className="text-center mb-10">
                                    <h1 className="font-display text-4xl text-theme mb-2">ä¼Šå¯</h1>
                                    <p className="text-sm text-subText">æ¬¢è¿æ¥åˆ°åªå±äºæˆ‘ä»¬çš„ç§˜å¯†åŸºåœ°</p>
                                </div>
                                <button 
                                    onClick={() => setMode('create')}
                                    className="w-full p-6 glass rounded-3xl text-left hover:bg-white/80 transition-all active:scale-[0.98]"
                                >
                                    <div className="text-3xl mb-2">âœ¨</div>
                                    <div className="font-bold text-text">åˆ›å»ºæ–°çš„å°çª</div>
                                    <div className="text-xs text-subText mt-1">ç”Ÿæˆä¸“å±æš—å·ï¼Œè®© TA æ¥æ‰¾ä½ </div>
                                </button>
                                <button 
                                    onClick={() => setMode('join')}
                                    className="w-full p-6 glass rounded-3xl text-left hover:bg-white/80 transition-all active:scale-[0.98]"
                                >
                                    <div className="text-3xl mb-2">ğŸšª</div>
                                    <div className="font-bold text-text">å»æ•²é—¨ (åŠ å…¥)</div>
                                    <div className="text-xs text-subText mt-1">è¾“å…¥ TA ç»™ä½ çš„æš—å·</div>
                                </button>
                            </motion.div>
                        )}

                        {mode === 'create' && (
                            <motion.div key="create" className="text-center space-y-8">
                                <h2 className="font-display text-2xl">å°çªå·²åˆ›å»º!</h2>
                                <p className="text-sm text-subText">è¯·æŠŠä¸‹æ–¹æš—å·å‘Šè¯‰ TA</p>
                                <div 
                                    className="text-5xl font-display tracking-widest text-theme border-b-2 border-theme pb-2 select-all"
                                    id="copy-code"
                                >
                                    {myCode}
                                </div>
                                <p className="text-xs text-subText mt-8">æ­£åœ¨ç­‰å¾… TA è¿æ¥...</p>
                                <button 
                                    onClick={() => setMode('choice')}
                                    className="text-xs text-subText underline"
                                >
                                    é‡æ–°é€‰æ‹©
                                </button>
                            </motion.div>
                        )}

                        {mode === 'join' && (
                            <motion.div key="join" className="space-y-6">
                                <h2 className="font-display text-2xl text-center">å»æ•²é—¨</h2>
                                <div className="space-y-2">
                                    <input 
                                        type="text" 
                                        placeholder="è¾“å…¥ TA çš„æš—å·" 
                                        maxLength={6}
                                        className="w-full text-center text-3xl font-display tracking-widest bg-transparent border-b-2 border-gray-300 focus:border-theme outline-none py-2 uppercase placeholder-gray-300"
                                        value={inputCode}
                                        onChange={(e) => setInputCode(e.target.value.toUpperCase())}
                                    />
                                </div>
                                <button 
                                    onClick={handleJoin}
                                    disabled={inputCode.length !== 6}
                                    className={`w-full py-4 rounded-2xl font-bold text-white shadow-lg transition-all btn-jelly
                                        ${inputCode.length !== 6 ? 'bg-gray-300' : 'bg-theme'}
                                    `}
                                >
                                    æ•²é—¨ ğŸšª
                                </button>
                                <button 
                                    onClick={() => setMode('choice')}
                                    className="w-full py-2 text-sm text-subText"
                                >
                                    è¿”å›
                                </button>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
            );
        };

        // --- ç»„ä»¶ï¼šå¾…åŠé¡¹ ---
        const TodoItem = ({ todo, onToggle }) => (
            <motion.div 
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                className="glass p-3 rounded-2xl flex items-center gap-3"
            >
                <button 
                    onClick={() => onToggle(todo.id)}
                    className={`w-5 h-5 rounded-full flex items-center justify-center border ${todo.completed ? 'bg-theme border-theme' : 'border-gray-300'}`}
                >
                    {todo.completed && <span className="text-white text-[8px]">âœ“</span>}
                </button>
                <p className={`text-sm flex-1 ${todo.completed ? 'line-through text-subText' : ''}`}>{todo.text}</p>
            </motion.div>
        );

        // --- ç»„ä»¶ï¼šæƒ…æ„Ÿæ ‘æ´ ---
        const TreeHole = ({ messages, onSend, onReact }) => {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            // æ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = () => {
                if(!input.trim()) return;
                onSend({ id: generateCode() + Date.now(), text: input, isAnon: true, timestamp: Date.now(), reactions: 0 });
                setInput('');
            };

            // è¾“å…¥æ¡†è‡ªåŠ¨é€‚åº”é«˜åº¦
            const handleTextareaChange = (e) => {
                setInput(e.target.value);
                e.target.style.height = 'auto';
                e.target.style.height = `${Math.min(e.target.scrollHeight, 96)}px`;
            };

            return (
                <div className="h-full flex flex-col relative">
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-28 px-1 space-y-4 pt-2" ref={scrollRef}>
                        {messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center mt-20 opacity-50">
                                <div className="text-5xl mb-4">ğŸ“®</div>
                                <p className="text-sm text-subText text-center">è¿™é‡Œæ˜¯é€šå¾€å½¼æ­¤å†…å¿ƒçš„ä¿¡ç®±<br/>ç¬¬ä¸€å°ä¿¡ï¼Œç­‰ä½ è½ç¬” âœ’ï¸</p>
                            </div>
                        ) : (
                            messages.sort((a,b) => b.timestamp - a.timestamp).map(msg => (
                                <MessageCard key={msg.id} msg={msg} onReact={onReact} partnerName={msg.isAnon ? 'ç¥ç§˜äºº' : 'TA'} />
                            ))
                        )}
                    </div>
                    
                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-6">
                        <div className="glass p-1.5 rounded-2xl shadow-sm flex items-end gap-2">
                            <textarea
                                value={input}
                                onChange={handleTextareaChange}
                                placeholder="say something..."
                                className="flex-1 bg-transparent outline-none text-sm px-3 py-2 resize-none h-10 max-h-24"
                                rows={1}
                                onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }}}
                            />
                            <button 
                                onClick={handleSend}
                                className="bg-text text-white w-8 h-8 rounded-xl mb-1 mr-1 flex items-center justify-center btn-jelly shadow-md"
                            >
                                â¤ï¸
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MessageCard = ({ msg, onReact, partnerName }) => {
            const [reacted, setReacted] = useState(false);
            const [particles, setParticles] = useState([]);

            const handleReaction = (e) => {
                e.stopPropagation();
                if (reacted) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
                setReacted(true);
                onReact(msg.id);
                // ç²’å­ç‰¹æ•ˆæ•°æ®ï¼ˆå¸¦å”¯ä¸€IDï¼‰
                setParticles([1,2,3].map(i => ({ id: `${msg.id}-${i}` })));
                setTimeout(() => setParticles([]), 1000);
            };

            return (
                <motion.div 
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="glass p-4 rounded-3xl relative"
                >
                    {/* ç²’å­å±‚ - ä¿®å¤keyä¸ºå”¯ä¸€ID */}
                    {particles.map(p => (
                        <motion.div
                            key={p.id}
                            initial={{ scale: 0, x: 0, y: 0, opacity: 1 }}
                            animate={{ scale: 0.5, x: (Math.random()-0.5)*80, y: -80, opacity: 0 }}
                            transition={{ duration: 0.8 }}
                            className="absolute top-1/2 left-1/2 text-pink pointer-events-none text-sm"
                        >
                            â¤ï¸
                        </motion.div>
                    ))}

                    <div className="flex justify-between items-baseline mb-2">
                        <span className="font-bold text-sm text-text/80">{partnerName}</span>
                        <span className="text-[10px] text-subText">{formatTime(msg.timestamp)}</span>
                    </div>
                    <p className="text-sm leading-relaxed text-text/90">{msg.text}</p>
                    
                    <div className="mt-3 flex justify-end">
                        <button 
                            onClick={handleReaction}
                            className={`flex items-center gap-1 text-xs px-3 py-1 rounded-full border transition-all duration-300
                                ${reacted ? 'bg-pink border-pink text-white scale-110' : 'bg-white/50 border-gray-200 text-gray-400'}
                            `}
                        >
                            <span className={reacted ? "animate-ping-once" : ""}>â¤ï¸</span>
                            <span>{msg.reactions || 0}</span>
                        </button>
                    </div>
                </motion.div>
            );
        };

        // --- ç»„ä»¶ï¼šå¾…åŠ ---
        const SharedTodo = ({ todos, onAdd, onToggle }) => {
            const [input, setInput] = useState('');
            const activeTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);

            const handleAdd = () => {
                if(!input.trim()) return;
                const newTodo = { 
                    id: generateCode(), 
                    text: input, 
                    completed: false, 
                    timestamp: Date.now() 
                };
                onAdd(newTodo);
                setInput('');
            };

            return (
                <div className="h-full flex flex-col overflow-hidden">
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-28 space-y-3 px-1 pt-2">
                        <h2 className="font-display text-xl mb-2 px-1">å¾…åŠæ¸…å• ğŸ“</h2>
                        
                        {activeTodos.length === 0 && completedTodos.length === 0 && (
                            <div className="text-center mt-10 opacity-50 text-sm text-subText">
                                <div className="text-3xl mb-2">ğŸŒ±</div>
                                è¿˜æ²¡æœ‰ç§ä¸‹ä»»ä½•å°ç›®æ ‡
                            </div>
                        )}

                        {activeTodos.map(todo => (
                            <TodoItem key={todo.id} todo={todo} onToggle={onToggle} />
                        ))}
                        
                        {completedTodos.length > 0 && (
                            <div className="pt-6 pb-2 opacity-60">
                                <h3 className="text-xs font-bold mb-3 tracking-wider text-subText px-1">âœ¨ å®Œæˆçš„å°äº‹</h3>
                                <div className="space-y-3">
                                    {completedTodos.map(todo => (
                                        <TodoItem key={todo.id} todo={todo} onToggle={onToggle} />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-6">
                        <div className="flex gap-2">
                            <input 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                placeholder="è®°ä¸€ä¸‹..."
                                className="flex-1 glass rounded-xl px-3 py-2 outline-none text-sm"
                                onKeyDown={(e) => { if(e.key === 'Enter') { e.preventDefault(); handleAdd(); }}}
                            />
                            <button 
                                onClick={handleAdd}
                                className="bg-theme text-white rounded-xl px-4 py-2 font-bold btn-jelly shadow-md"
                            >
                                +
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»åº”ç”¨ç»„ä»¶ ---
        const App = () => {
            // æ ¸å¿ƒçŠ¶æ€
            const [status, setStatus] = useState('INIT'); // INIT/WAITING_HOST/CONNECTING/CONNECTED/RECONNECT/ERROR
            const [view, setView] = useState('onboarding'); // onboarding/treehole/todo
            const [peer, setPeer] = useState(null);
            const [conn, setConn] = useState(null);
            const [partnerId, setPartnerId] = useState('');
            const [role, setRole] = useState(''); // HOST/GUEST
            
            // æ•°æ®çŠ¶æ€
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            
            // Toast çŠ¶æ€
            const [toast, setToast] = useState({ show: false, text: '' });
            const showToast = (text) => {
                setToast({ show: true, text });
                setTimeout(() => setToast({ show: false, text: '' }), 2000);
            };

            // --- åˆå§‹åŒ–æœ¬åœ°æ•°æ® ---
            useEffect(() => {
                const loadLocalData = async () => {
                    try {
                        // åŠ è½½æ¶ˆæ¯
                        const localMessages = await localforage.getItem('yike_messages') || [];
                        setMessages(localMessages);
                        // åŠ è½½å¾…åŠ
                        const localTodos = await localforage.getItem('yike_todos') || [];
                        setTodos(localTodos);
                        setStatus('INIT');
                    } catch (err) {
                        console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', err);
                        showToast('ğŸ’¾ æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥');
                    }
                };
                loadLocalData();
            }, []);

            // --- PeerJS åˆå§‹åŒ– ---
            const initPeer = (newPeerId = null, targetId = '', newRole = '') => {
                // æ¸…ç†æ—§è¿æ¥
                if (conn) conn.close();
                if (peer) peer.destroy();
                
                setStatus(newRole === 'HOST' ? 'WAITING_HOST' : 'CONNECTING');
                
                // åˆ›å»ºæ–°Peer
                const newPeer = new Peer(newPeerId || generateCode(), {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true
                });
                
                setPeer(newPeer);
                setPartnerId(targetId);
                setRole(newRole);

                // Peer æ‰“å¼€äº‹ä»¶
                newPeer.on('open', (id) => {
                    console.log('Peer å·²æ‰“å¼€:', id);
                    if (newRole === 'GUEST' && targetId) {
                        // è®¿å®¢ä¸»åŠ¨è¿æ¥
                        const connection = newPeer.connect(targetId);
                        handleConnection(connection);
                    }
                });

                // ç›‘å¬å…¥ç«™è¿æ¥
                newPeer.on('connection', (connection) => {
                    if (conn) connection.close(); // åªä¿ç•™ä¸€ä¸ªè¿æ¥
                    handleConnection(connection);
                });

                // Peer é”™è¯¯å¤„ç†
                newPeer.on('error', (err) => {
                    console.error('Peer é”™è¯¯:', err);
                    setStatus('ERROR');
                    showToast(`âŒ ${err.message}`);
                });
            };

            // --- è¿æ¥å¤„ç† ---
            const handleConnection = (connection) => {
                setConn(connection);
                setStatus('CONNECTED');
                setView('treehole');
                showToast('ğŸ‰ è¿æ¥æˆåŠŸï¼Œæ¬¢è¿å›å®¶ï½');

                // è¿æ¥æ‰“å¼€
                connection.on('open', () => {
                    console.log('è¿æ¥å·²æ‰“å¼€');
                    // åŒæ­¥å…¨é‡æ•°æ®
                    syncAll();
                });

                // æ¥æ”¶æ•°æ®
                connection.on('data', (data) => handleDataSync(data));

                // è¿æ¥å…³é—­
                connection.on('close', () => {
                    setStatus('RECONNECT');
                    showToast("ğŸ’” è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¯•...");
                    // è‡ªåŠ¨é‡è¿é€»è¾‘ï¼ˆæœ€å¤š5æ¬¡ï¼‰
                    let retryCount = 0;
                    const retryConnect = () => {
                        if (retryCount >= 5 || status === 'CONNECTED') return;
                        retryCount++;
                        initPeer(null, partnerId, role);
                        setTimeout(retryConnect, 5000);
                    };
                    retryConnect();
                });

                // è¿æ¥é”™è¯¯
                connection.on('error', (err) => {
                    console.error('è¿æ¥é”™è¯¯:', err);
                    setStatus('ERROR');
                    showToast(`âŒ è¿æ¥å¤±è´¥: ${err.message}`);
                });
            };

            // --- æ•°æ®åŒæ­¥å¤„ç† ---
            const handleDataSync = (data) => {
                if (!data || !data.type) return;
                
                switch (data.type) {
                    // æ¶ˆæ¯æ–°å¢
                    case 'MSG_ADD':
                        setMessages(prev => {
                            const exists = prev.some(m => m.id === data.payload.id);
                            const newMessages = exists ? prev : [...prev, data.payload];
                            // ä¿å­˜åˆ°æœ¬åœ°
                            localforage.setItem('yike_messages', newMessages).catch(err => console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', err));
                            return newMessages;
                        });
                        break;
                    
                    // æ¶ˆæ¯ç‚¹èµ
                    case 'MSG_REACT':
                        setMessages(prev => {
                            const newMessages = prev.map(m => 
                                m.id === data.payload.id ? {...m, reactions: (m.reactions || 0) + 1} : m
                            );
                            localforage.setItem('yike_messages', newMessages).catch(err => console.error('ä¿å­˜ç‚¹èµå¤±è´¥:', err));
                            return newMessages;
                        });
                        break;
                    
                    // å¾…åŠæ–°å¢
                    case 'TODO_ADD':
                        setTodos(prev => {
                            const exists = prev.some(t => t.id === data.payload.id);
                            const newTodos = exists ? prev : [...prev, data.payload];
                            localforage.setItem('yike_todos', newTodos).catch(err => console.error('ä¿å­˜å¾…åŠå¤±è´¥:', err));
                            return newTodos;
                        });
                        break;
                    
                    // å¾…åŠåˆ‡æ¢
                    case 'TODO_TOGGLE':
                        setTodos(prev => {
                            const newTodos = prev.map(t => 
                                t.id === data.payload.id ? {...t, completed: !t.completed} : t
                            );
                            localforage.setItem('yike_todos', newTodos).catch(err => console.error('æ›´æ–°å¾…åŠå¤±è´¥:', err));
                            return newTodos;
                        });
                        break;
                    
                    // å…¨é‡åŒæ­¥ï¼ˆå¢é‡åˆå¹¶ï¼‰
                    case 'SYNC':
                        // åˆå¹¶æ¶ˆæ¯
                        if (data.payload.messages) {
                            setMessages(prev => {
                                const merged = [...prev, ...data.payload.messages].reduce((acc, cur) => {
                                    if (!acc.find(m => m.id === cur.id) || cur.timestamp > acc.find(m => m.id === cur.id)?.timestamp) {
                                        acc = acc.filter(m => m.id !== cur.id);
                                        acc.push(cur);
                                    }
                                    return acc;
                                }, []);
                                localforage.setItem('yike_messages', merged).catch(err => console.error('åŒæ­¥æ¶ˆæ¯å¤±è´¥:', err));
                                return merged;
                            });
                        }
                        // åˆå¹¶å¾…åŠ
                        if (data.payload.todos) {
                            setTodos(prev => {
                                const merged = [...prev, ...data.payload.todos].reduce((acc, cur) => {
                                    if (!acc.find(t => t.id === cur.id) || cur.timestamp > acc.find(t => t.id === cur.id)?.timestamp) {
                                        acc = acc.filter(t => t.id !== cur.id);
                                        acc.push(cur);
                                    }
                                    return acc;
                                }, []);
                                localforage.setItem('yike_todos', merged).catch(err => console.error('åŒæ­¥å¾…åŠå¤±è´¥:', err));
                                return merged;
                            });
                        }
                        break;
                }
            };

            // --- æ•°æ®å¹¿æ’­ï¼ˆå¸¦ç©ºå€¼ä¿æŠ¤ï¼‰ ---
            const broadcast = (type, payload) => {
                if (conn && conn.open) {
                    conn.send({ type, payload });
                } else {
                    showToast("ğŸ“¡ æœªè¿æ¥ï¼Œæ•°æ®æš‚å­˜æœ¬åœ°");
                }
            };

            // --- å…¨é‡åŒæ­¥æ•°æ® ---
            const syncAll = () => {
                broadcast('SYNC', {
                    messages,
                    todos
                });
            };

            // --- äº‹ä»¶å¤„ç†å‡½æ•° ---
            // åŠ å…¥å°çª
            const handleJoin = (code, newRole) => {
                initPeer(localStorage.getItem('yike_my_id'), code, newRole);
            };

            // é‡ç½®è¿æ¥
            const handleReset = () => {
                setStatus('INIT');
                setView('onboarding');
                initPeer(null, '', '');
            };

            // æ ‘æ´æ¶ˆæ¯å‘é€
            const handleSendMessage = (msg) => {
                setMessages(prev => {
                    const newMessages = [...prev, msg];
                    localforage.setItem('yike_messages', newMessages).catch(err => console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', err));
                    return newMessages;
                });
                broadcast('MSG_ADD', msg);
            };

            // æ¶ˆæ¯ç‚¹èµ
            const handleMessageReaction = (msgId) => {
                setMessages(prev => prev.map(m => m.id === msgId ? {...m, reactions: (m.reactions || 0) + 1} : m));
                broadcast('MSG_REACT', { id: msgId });
            };

            // å¾…åŠæ·»åŠ 
            const handleAddTodo = (todo) => {
                setTodos(prev => {
                    const newTodos = [...prev, todo];
                    localforage.setItem('yike_todos', newTodos).catch(err => console.error('ä¿å­˜å¾…åŠå¤±è´¥:', err));
                    return newTodos;
                });
                broadcast('TODO_ADD', todo);
            };

            // å¾…åŠåˆ‡æ¢
            const handleToggleTodo = (todoId) => {
                setTodos(prev => prev.map(t => t.id === todoId ? {...t, completed: !t.completed} : t));
                broadcast('TODO_TOGGLE', { id: todoId });
            };

            // --- é€€å‡ºå°çª ---
            const handleLeave = () => {
                if(confirm("ç¡®å®šè¦ç¦»å¼€å°çªå—ï¼Ÿæ‰€æœ‰æœ¬åœ°æ•°æ®ä¿ç•™ï¼Œä½†éœ€è¦é‡æ–°è¾“å…¥æš—å·æ‰èƒ½è¿æ¥ã€‚")) {
                    localStorage.clear();
                    localforage.clear().then(() => {
                        if (conn) conn.close();
                        if (peer) peer.destroy();
                        setConn(null);
                        setPeer(null);
                        setPartnerId('');
                        setRole('');
                        setStatus('INIT');
                        setView('onboarding');
                        setMessages([]);
                        setTodos([]);
                        window.location.reload();
                    });
                }
            };

            // --- æ¸²æŸ“é€»è¾‘ ---
            return (
                <div className="h-full w-full relative">
                    <Background />
                    <Toast show={toast.show} text={toast.text} />
                    
                    {/* åŠ è½½/é”™è¯¯é¡µé¢ */}
                    {status !== 'CONNECTED' && view === 'onboarding' && (
                        <LoadingView status={status} onReset={handleReset} />
                    )}

                    {/* é¦–æ¬¡å¼•å¯¼é¡µé¢ */}
                    {status === 'INIT' && view === 'onboarding' && (
                        <Onboarding onJoin={handleJoin} />
                    )}

                    {/* å·²è¿æ¥åçš„ä¸»ç•Œé¢ */}
                    {status === 'CONNECTED' && (
                        <div className="h-full w-full flex flex-col">
                            {/* é¡¶éƒ¨å¯¼èˆª */}
                            <div className="glass py-3 px-4 flex justify-between items-center shadow-sm">
                                <div className="flex gap-2 items-center">
                                    <button 
                                        onClick={() => setView(view === 'treehole' ? 'todo' : 'treehole')}
                                        className="btn-jelly"
                                    >
                                        {view === 'treehole' ? 'ğŸ“ å¾…åŠ' : 'ğŸ’¬ æ ‘æ´'}
                                    </button>
                                </div>
                                <button 
                                    onClick={handleLeave}
                                    className="text-xs text-subText btn-jelly"
                                >
                                    ç¦»å¼€ âŒ
                                </button>
                            </div>
                            
                            {/* å†…å®¹åŒºåŸŸ */}
                            <div className="flex-1 overflow-hidden">
                                {view === 'treehole' && (
                                    <TreeHole 
                                        messages={messages} 
                                        onSend={handleSendMessage}
                                        onReact={handleMessageReaction}
                                    />
                                )}
                                {view === 'todo' && (
                                    <SharedTodo 
                                        todos={todos} 
                                        onAdd={handleAddTodo}
                                        onToggle={handleToggleTodo}
                                    />
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // æ¸²æŸ“åº”ç”¨
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>