<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šå¯ Yike - æˆ‘ä»¬çš„ç§˜å¯†å°çª</title>
    
    <!-- Google Fonts - å›½å†…ç§’å¼€ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=ZCOOL+Kuai+Le&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (jsdelivr ç¨³å®š CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/src/css/preflight.css"></script>
    
    <!-- é…ç½® Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'main': "'Nunito', 'PingFang SC', 'Hiragino Sans GB', system-ui, sans-serif",
                        'hand': "'ZCOOL Kuai Le', 'Zhi Mang Xing', cursive",
                    },
                    colors: {
                        'coco': {
                            bg: '#FDFBF7',
                            pink: '#E8CFC8',
                            blue: '#D4E4E6',
                            text: '#4A403A',
                            muted: '#9CA3AF',
                            heart: '#E88D8D'
                        }
                    },
                    animation: {
                        'breathe': 'breathe 3s ease-in-out infinite',
                        'float': 'float 8s ease-in-out infinite',
                        'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
                    },
                    keyframes: {
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.3' },
                            '50%': { transform: 'scale(1.5)', opacity: '0.1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translate(0, 0)' },
                            '33%': { transform: 'translate(30px, -30px)' },
                            '66%': { transform: 'translate(-20px, 20px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Nunito', 'PingFang SC', 'Hiragino Sans GB', system-ui, sans-serif;
            background: linear-gradient(135deg, #FDFBF7 0%, #F5F0EB 100%);
            color: #4A403A;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* å­—ä½“è®¾ç½® */
        .font-hand { font-family: 'ZCOOL Kuai Le', 'Zhi Mang Xing', cursive; }
        
        /* æœå†»è§¦æ„Ÿ */
        .jelly {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .jelly:active { transform: scale(0.96); }
        
        /* æ¯›ç»ç’ƒå¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.03);
        }
        
        /* é­”æ³•ä¸‹åˆ’çº¿åŠ¨ç”» */
        .magic-strike {
            position: relative;
            overflow: hidden;
        }
        .magic-strike::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 0;
            height: 2px;
            background: #E88D8D;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .magic-strike.struck::after {
            width: 100%;
        }
        
        /* çˆ±å¿ƒå¼•çˆ†ç²’å­ */
        .heart-particle {
            position: absolute;
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(0.5); opacity: 0; }
        }
        
        /* å½•éŸ³æ°´æ³¢çº¹ */
        .record-ripple {
            position: absolute;
            border: 2px solid #E8CFC8;
            border-radius: 50%;
            animation: ripple 2s ease-out infinite;
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(232, 207, 200, 0.5); border-radius: 3px; }
        
        /* è¾“å…¥æ¡†ç¾åŒ– */
        input, textarea {
            outline: none;
            -webkit-appearance: none;
        }
        input::placeholder, textarea::placeholder { color: #9CA3AF; }
        
        /* Toast åŠ¨ç”» */
        .toast-enter { animation: slide-down 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes slide-down {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        /* å‘¼å¸ç¯ */
        .breathing-dot {
            position: relative;
        }
        .breathing-dot::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: #68D391;
            border-radius: 50%;
            animation: ping-slow 3s cubic-bezier(0, 0, 0.2, 1) infinite;
            opacity: 0.2;
        }
        
        /* ç®€ç¬”ç”»ä¿¡ç®± */
        .mailbox-draw {
            stroke: #4A403A;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (å†…è”ç¼–è¯‘) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    
    <!-- PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- localforage -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <!-- Framer Motion -->
    <script src="https://cdn.jsdelivr.net/npm/framer-motion@10.16.4/dist/framer-motion.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext, memo } = React;
        const { motion, AnimatePresence } = window.Motion;
        
        // ============ å·¥å…·å‡½æ•° ============
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatDate = (date) => new Date(date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
        const formatTime = (date) => new Date(date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        
        // æ‹çˆ±å¤©æ•°è®¡ç®—
        const calculateLoveDays = (startDate) => {
            const start = new Date(startDate);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };
        
        // ============ æœ¬åœ°å­˜å‚¨åˆå§‹åŒ– ============
        localforage.config({ name: 'YikeApp', storeName: 'yike_data' });
        
        // ============ å…¨å±€ä¸Šä¸‹æ–‡ ============
        const AppContext = createContext();
        
        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null); // ç”¨æˆ·ä¿¡æ¯ { id, peerId, name }
            const [partner, setPartner] = useState(null); // ä¼´ä¾£ä¿¡æ¯
            const [connectionStatus, setConnectionStatus] = useState('disconnected'); // disconnected, connecting, connected
            const [toasts, setToasts] = useState([]);
            const [treeholes, setTreeholes] = useState([]);
            const [todos, setTodos] = useState([]);
            const [voiceMemos, setVoiceMemos] = useState([]);
            const [loveStartDate, setLoveStartDate] = useState(null);
            const [notifications, setNotifications] = useState({ soundEnabled: false, customSoundId: null });
            
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const reconnectTimeoutRef = useRef(null);
            
            // æ˜¾ç¤º Toast
            const showToast = useCallback((message) => {
                const id = generateId();
                setToasts(prev => [...prev, { id, message }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);
            
            // ä¿å­˜ç”¨æˆ·é…å¯¹ä¿¡æ¯åˆ° localStorage
            const savePairingInfo = useCallback((myId, peerId, partnerName, startDate) => {
                localStorage.setItem('yike_pairing', JSON.stringify({
                    myId,
                    peerId,
                    partnerName,
                    startDate,
                    pairedAt: Date.now()
                }));
            }, []);
            
            // åŠ è½½é…å¯¹ä¿¡æ¯
            const loadPairingInfo = useCallback(() => {
                const saved = localStorage.getItem('yike_pairing');
                if (saved) {
                    return JSON.parse(saved);
                }
                return null;
            }, []);
            
            // åˆå§‹åŒ– PeerJS
            const initPeer = useCallback((myId, partnerId = null) => {
                if (peerRef.current) {
                    peerRef.current.destroy();
                }
                
                setConnectionStatus('connecting');
                
                const peer = new Peer(myId, {
                    debug: 0
                });
                
                peer.on('open', (id) => {
                    console.log('PeerJS è¿æ¥æˆåŠŸ:', id);
                    if (partnerId) {
                        connectToPartner(partnerId);
                    } else {
                        setConnectionStatus('connected');
                        setUser({ id: myId, peerId: id });
                    }
                });
                
                peer.on('connection', (conn) => {
                    handleNewConnection(conn);
                });
                
                peer.on('error', (err) => {
                    console.error('PeerJS é”™è¯¯:', err);
                    setConnectionStatus('disconnected');
                    
                    // è‡ªåŠ¨é‡è¿
                    if (reconnectTimeoutRef.current) clearTimeout(reconnectTimeoutRef.current);
                    reconnectTimeoutRef.current = setTimeout(() => {
                        initPeer(myId, partnerId);
                    }, 5000);
                });
                
                peerRef.current = peer;
            }, []);
            
            // è¿æ¥åˆ°ä¼´ä¾£
            const connectToPartner = useCallback((partnerId) => {
                if (!peerRef.current) return;
                
                const conn = peerRef.current.connect(partnerId, { reliable: true });
                
                conn.on('open', () => {
                    console.log('å·²è¿æ¥åˆ°ä¼´ä¾£');
                    connRef.current = conn;
                    setConnectionStatus('connected');
                    
                    // åŒæ­¥æœ¬åœ°æ•°æ®
                    sendSyncData(conn);
                });
                
                conn.on('data', (data) => {
                    handleIncomingData(data);
                });
                
                conn.on('close', () => {
                    setConnectionStatus('disconnected');
                });
                
                conn.on('error', (err) => {
                    console.error('è¿æ¥é”™è¯¯:', err);
                    setConnectionStatus('disconnected');
                });
            }, []);
            
            // å¤„ç†æ–°è¿æ¥
            const handleNewConnection = useCallback((conn) => {
                conn.on('open', () => {
                    console.log('ä¼´ä¾£å·²è¿æ¥');
                    connRef.current = conn;
                    setConnectionStatus('connected');
                    sendSyncData(conn);
                });
                
                conn.on('data', (data) => {
                    handleIncomingData(data);
                });
                
                conn.on('close', () => {
                    setConnectionStatus('disconnected');
                });
            }, []);
            
            // å‘é€åŒæ­¥æ•°æ®
            const sendSyncData = useCallback((conn) => {
                if (conn && conn.open) {
                    conn.send({
                        type: 'SYNC_REQUEST',
                        from: user?.id
                    });
                }
            }, [user]);
            
            // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
            const handleIncomingData = useCallback((data) => {
                console.log('æ”¶åˆ°æ•°æ®:', data.type);
                
                switch (data.type) {
                    case 'TREEHOLE':
                        setTreeholes(prev => {
                            if (prev.find(t => t.id === data.payload.id)) return prev;
                            return [data.payload, ...prev];
                        });
                        if (data.payload.type === 'create') {
                            showToast('å®å’šï¼ŒTA ç»™ä½ ç•™äº†æ–°çº¸æ¡~');
                        }
                        break;
                        
                    case 'TREEHOLE_LIKE':
                        setTreeholes(prev => prev.map(t => 
                            t.id === data.payload.id 
                                ? { ...t, likes: data.payload.likes, likedBy: data.payload.likedBy }
                                : t
                        ));
                        break;
                        
                    case 'TREEHOLE_REPLY':
                        setTreeholes(prev => prev.map(t => 
                            t.id === data.payload.treeholeId 
                                ? { ...t, replies: [...(t.replies || []), data.payload.reply] }
                                : t
                        ));
                        break;
                        
                    case 'TODO':
                        setTodos(prev => {
                            if (data.payload.action === 'delete') {
                                return prev.filter(t => t.id !== data.payload.id);
                            }
                            if (prev.find(t => t.id === data.payload.id)) return prev;
                            return [data.payload, ...prev];
                        });
                        if (data.payload.type === 'create') {
                            showToast('å®å’šï¼ŒTA ç»™ä½ ç•™äº†æ–°çº¸æ¡~');
                        }
                        break;
                        
                    case 'TODO_COMPLETE':
                        setTodos(prev => prev.map(t => 
                            t.id === data.payload.id 
                                ? { ...t, completed: true, completedAt: data.payload.completedAt }
                                : t
                        ));
                        break;
                        
                    case 'VOICE':
                        setVoiceMemos(prev => {
                            if (prev.find(v => v.id === data.payload.id)) return prev;
                            return [data.payload, ...prev];
                        });
                        if (data.payload.type === 'create') {
                            showToast('å¬åˆ°è¿œæ–¹çš„å£°éŸ³å•¦~');
                            playNotificationSound();
                        }
                        break;
                        
                    case 'SYNC_REQUEST':
                        // å¯¹æ–¹è¯·æ±‚åŒæ­¥ï¼Œå‘é€å®Œæ•´æ•°æ®
                        if (connRef.current) {
                            connRef.current.send({
                                type: 'SYNC_RESPONSE',
                                payload: {
                                    treeholes: treeholes,
                                    todos: todos,
                                    voiceMemos: voiceMemos,
                                    loveStartDate: loveStartDate
                                }
                            });
                        }
                        break;
                        
                    case 'SYNC_RESPONSE':
                        // åˆå¹¶å¯¹æ–¹æ•°æ®ï¼ˆæŒ‰æ—¶é—´æˆ³ï¼‰
                        if (data.payload.treeholes) {
                            setTreeholes(prev => {
                                const merged = [...prev];
                                data.payload.treeholes.forEach(t => {
                                    if (!merged.find(m => m.id === t.id)) {
                                        merged.push(t);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.payload.todos) {
                            setTodos(prev => {
                                const merged = [...prev];
                                data.payload.todos.forEach(t => {
                                    if (!merged.find(m => m.id === t.id)) {
                                        merged.push(t);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.payload.voiceMemos) {
                            setVoiceMemos(prev => {
                                const merged = [...prev];
                                data.payload.voiceMemos.forEach(v => {
                                    if (!merged.find(m => m.id === v.id)) {
                                        merged.push(v);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.payload.loveStartDate && !loveStartDate) {
                            setLoveStartDate(data.payload.loveStartDate);
                        }
                        break;
                }
            }, [treeholes, todos, voiceMemos, loveStartDate, showToast]);
            
            // å‘é€æ•°æ®ç»™ä¼´ä¾£
            const sendToPartner = useCallback((type, payload) => {
                if (connRef.current && connRef.current.open) {
                    connRef.current.send({ type, payload });
                }
            }, []);
            
            // æ·»åŠ æ ‘æ´
            const addTreehole = useCallback(async (content, isAnonymous) => {
                const treehole = {
                    id: generateId(),
                    content,
                    isAnonymous,
                    authorId: user?.id,
                    authorName: isAnonymous ? 'ç¥ç§˜äºº' : user?.name,
                    likes: 0,
                    likedBy: [],
                    replies: [],
                    createdAt: Date.now()
                };
                
                setTreeholes(prev => [treehole, ...prev]);
                await localforage.setItem('treeholes', [treehole, ...treeholes]);
                sendToPartner('TREEHOLE', { ...treehole, type: 'create' });
            }, [user, treeholes, sendToPartner]);
            
            // ç‚¹èµæ ‘æ´
            const likeTreehole = useCallback((id) => {
                setTreeholes(prev => prev.map(t => {
                    if (t.id === id) {
                        const isLiked = t.likedBy.includes(user?.id);
                        const newLikes = isLiked ? t.likes - 1 : t.likes + 1;
                        const newLikedBy = isLiked 
                            ? t.likedBy.filter(l => l !== user?.id)
                            : [...t.likedBy, user?.id];
                        
                        sendToPartner('TREEHOLE_LIKE', { id, likes: newLikes, likedBy: newLikedBy });
                        
                        return { ...t, likes: newLikes, likedBy: newLikedBy };
                    }
                    return t;
                }));
            }, [user, sendToPartner]);
            
            // å›å¤æ ‘æ´
            const replyTreehole = useCallback((treeholeId, replyContent) => {
                const reply = {
                    id: generateId(),
                    content: replyContent,
                    authorId: user?.id,
                    authorName: user?.name,
                    createdAt: Date.now()
                };
                
                setTreeholes(prev => prev.map(t => {
                    if (t.id === treeholeId) {
                        return { ...t, replies: [...(t.replies || []), reply] };
                    }
                    return t;
                }));
                
                sendToPartner('TREEHOLE_REPLY', { treeholeId, reply });
            }, [user, sendToPartner]);
            
            // æ·»åŠ å¾…åŠ
            const addTodo = useCallback(async (content, category) => {
                const todo = {
                    id: generateId(),
                    content,
                    category, // 'partner' | 'together'
                    completed: false,
                    createdAt: Date.now(),
                    createdBy: user?.id
                };
                
                setTodos(prev => [todo, ...todos]);
                await localforage.setItem('todos', [todo, ...todos]);
                sendToPartner('TODO', { ...todo, type: 'create' });
            }, [user, todos, sendToPartner]);
            
            // å®Œæˆå¾…åŠ
            const completeTodo = useCallback((id) => {
                setTodos(prev => prev.map(t => {
                    if (t.id === id) {
                        sendToPartner('TODO_COMPLETE', { id, completedAt: Date.now() });
                        return { ...t, completed: true, completedAt: Date.now() };
                    }
                    return t;
                }));
            }, [sendToPartner]);
            
            // åˆ é™¤å¾…åŠ
            const deleteTodo = useCallback((id) => {
                setTodos(prev => prev.filter(t => t.id !== id));
                sendToPartner('TODO', { id, action: 'delete' });
            }, [sendToPartner]);
            
            // å½•éŸ³ç›¸å…³
            const addVoiceMemo = useCallback(async (blob, duration) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    const base64 = reader.result;
                    const voiceMemo = {
                        id: generateId(),
                        audio: base64,
                        duration,
                        createdAt: Date.now(),
                        createdBy: user?.id,
                        authorName: user?.name
                    };
                    
                    setVoiceMemos(prev => [voiceMemo, ...voiceMemos]);
                    localforage.setItem('voiceMemos', [voiceMemo, ...voiceMemos]);
                    sendToPartner('VOICE', { ...voiceMemo, type: 'create' });
                };
            }, [user, voiceMemos, sendToPartner]);
            
            // æ’­æ”¾æç¤ºéŸ³
            const playNotificationSound = useCallback(() => {
                if (notifications.soundEnabled) {
                    const audio = new Audio(voiceMemos.find(v => v.id === notifications.customSoundId)?.audio);
                    if (audio) audio.play().catch(() => {});
                }
            }, [notifications, voiceMemos]);
            
            // å¯¼å‡ºæ•°æ®
            const exportData = useCallback(() => {
                const data = {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    treeholes,
                    todos,
                    voiceMemos,
                    loveStartDate
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `yike-backup-${formatDate(Date.now())}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('å›å¿†å·²æ‰“åŒ…~');
            }, [treeholes, todos, voiceMemos, loveStartDate, showToast]);
            
            // å¯¼å…¥æ•°æ®
            const importData = useCallback((file) => {
                const reader = new FileReader();
                reader.readAsText(file);
                reader.onloadend = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        if (data.treeholes) {
                            setTreeholes(prev => {
                                const merged = [...prev];
                                data.treeholes.forEach(t => {
                                    if (!merged.find(m => m.id === t.id)) {
                                        merged.push(t);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.todos) {
                            setTodos(prev => {
                                const merged = [...prev];
                                data.todos.forEach(t => {
                                    if (!merged.find(m => m.id === t.id)) {
                                        merged.push(t);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.voiceMemos) {
                            setVoiceMemos(prev => {
                                const merged = [...prev];
                                data.voiceMemos.forEach(v => {
                                    if (!merged.find(m => m.id === v.id)) {
                                        merged.push(v);
                                    }
                                });
                                return merged.sort((a, b) => b.createdAt - a.createdAt);
                            });
                        }
                        if (data.loveStartDate) {
                            setLoveStartDate(data.loveStartDate);
                        }
                        showToast('æ—¶å…‰å·²æ¢å¤~');
                    } catch (e) {
                        showToast('æ–‡ä»¶æ ¼å¼ä¸å¯¹å‘¢...');
                    }
                };
            }, [showToast]);
            
            // åˆå§‹åŒ–åŠ è½½
            useEffect(() => {
                const loadData = async () => {
                    const treeholesData = await localforage.getItem('treeholes');
                    const todosData = await localforage.getItem('todos');
                    const voiceData = await localforage.getItem('voiceMemos');
                    const loveDate = await localforage.getItem('loveStartDate');
                    
                    if (treeholesData) setTreeholes(treeholesData);
                    if (todosData) setTodos(todosData);
                    if (voiceData) setVoiceMemos(voiceData);
                    if (loveDate) setLoveStartDate(loveDate);
                    
                    const notificationsData = await localforage.getItem('notifications');
                    if (notificationsData) setNotifications(notificationsData);
                };
                loadData();
            }, []);
            
            // ä¿å­˜è®¾ç½®
            useEffect(() => {
                localforage.setItem('notifications', notifications);
            }, [notifications]);
            
            // æ¸…ç†å‡½æ•°
            useEffect(() => {
                return () => {
                    if (peerRef.current) peerRef.current.destroy();
                    if (reconnectTimeoutRef.current) clearTimeout(reconnectTimeoutRef.current);
                };
            }, []);
            
            return (
                <AppContext.Provider value={{
                    // çŠ¶æ€
                    user, setUser,
                    partner, setPartner,
                    connectionStatus,
                    toasts,
                    treeholes, setTreeholes,
                    todos,
                    voiceMemos,
                    loveStartDate, setLoveStartDate,
                    notifications, setNotifications,
                    
                    // æ–¹æ³•
                    initPeer,
                    savePairingInfo,
                    loadPairingInfo,
                    addTreehole,
                    likeTreehole,
                    replyTreehole,
                    addTodo,
                    completeTodo,
                    deleteTodo,
                    addVoiceMemo,
                    exportData,
                    importData,
                    showToast
                }}>
                    {children}
                </AppContext.Provider>
            );
        };
        
        // ============ ç»„ä»¶ ============
        
        // åŠ¨æ•ˆç»„ä»¶ï¼šçˆ±å¿ƒå¼•çˆ†
        const HeartBurst = ({ onComplete }) => {
            const particles = [
                { left: '20%', delay: 0 },
                { left: '50%', delay: 0.1 },
                { left: '80%', delay: 0.2 }
            ];
            
            useEffect(() => {
                const timer = setTimeout(onComplete, 1000);
                return () => clearTimeout(timer);
            }, [onComplete]);
            
            return (
                <div className="absolute inset-0 pointer-events-none">
                    {particles.map((p, i) => (
                        <motion.div
                            key={i}
                            initial={{ opacity: 1, scale: 1, y: 0 }}
                            animate={{ opacity: 0, scale: 0.5, y: -60 }}
                            transition={{ duration: 0.8, delay: p.delay, ease: 'easeOut' }}
                            className="absolute bottom-1/2 left-1/2 text-â¤ï¸"
                            style={{ left: p.left, transform: 'translateX(-50%)' }}
                        >
                            â¤ï¸
                        </motion.div>
                    ))}
                </div>
            );
        };
        
        // Toast ç»„ä»¶
        const Toast = ({ message }) => (
            <motion.div
                initial={{ y: -60, opacity: 0 }}
                animate={{ y: 20, opacity: 1 }}
                exit={{ y: -60, opacity: 0 }}
                className="fixed top-0 left-1/2 -translate-x-1/2 z-50 
                           bg-white/90 backdrop-blur-md px-6 py-3 rounded-full 
                           shadow-lg border border-white/60 text-coco-text text-sm font-medium
                           toast-enter"
            >
                {message}
            </motion.div>
        );
        
        // å‘¼å¸ç¯ç»„ä»¶
        const BreathingIndicator = ({ isOnline }) => (
            <div className="relative flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-400 breathing-dot' : 'bg-gray-300'}`}></div>
                <span className={`text-xs ${isOnline ? 'text-green-600' : 'text-coco-muted'}`}>
                    {isOnline ? 'TA æ­£åœ¨é™ªç€ä½ ' : 'æ­£åœ¨å¯»æ‰¾ TA...'}
                </span>
            </div>
        );
        
        // é¦–é¡µï¼ˆç‰µæ‰‹é¡µï¼‰
        const OnboardingPage = () => {
            const { initPeer, savePairingInfo, loadPairingInfo, setUser, setLoveStartDate, setPartner, showToast } = useContext(AppContext);
            const [mode, setMode] = useState('welcome'); // welcome, create, join
            const [myName, setMyName] = useState('');
            const [partnerName, setPartnerName] = useState('');
            const [partnerId, setPartnerId] = useState('');
            const [loveDate, setLoveDate] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            
            // æ£€æŸ¥æ˜¯å¦å·²é…å¯¹
            useEffect(() => {
                const saved = loadPairingInfo();
                if (saved) {
                    setUser({ id: saved.myId, name: 'æˆ‘' });
                    setPartner({ name: saved.partnerName });
                    setLoveStartDate(saved.startDate);
                    initPeer(saved.myId, saved.peerId);
                }
            }, []);
            
            const handleCreate = async () => {
                if (!myName || !partnerName || !loveDate) {
                    showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯~');
                    return;
                }
                
                setIsLoading(true);
                const myId = generateId();
                const peerId = generateId(); // ç®€åŒ–ï¼šç›´æ¥ç”¨éšæœºID
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                savePairingInfo(myId, peerId, partnerName, loveDate);
                
                setUser({ id: myId, name: myName });
                setPartner({ name: partnerName });
                setLoveStartDate(loveDate);
                await localforage.setItem('loveStartDate', loveDate);
                
                initPeer(myId, peerId);
            };
            
            const handleJoin = () => {
                if (!partnerId || !myName || !loveDate) {
                    showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯~');
                    return;
                }
                
                setIsLoading(true);
                const myId = generateId();
                
                savePairingInfo(myId, partnerId, 'TA', loveDate);
                
                setUser({ id: myId, name: myName });
                setPartner({ name: 'TA' });
                setLoveStartDate(loveDate);
                await localforage.setItem('loveStartDate', loveDate);
                
                initPeer(myId, partnerId);
            };
            
            if (mode === 'welcome') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-8">
                        {/* åŠ¨æ€èƒŒæ™¯å…‰æ–‘ */}
                        <div className="absolute inset-0 overflow-hidden pointer-events-none">
                            <div className="absolute top-20 left-10 w-40 h-40 bg-coco-pink/30 rounded-full blur-[80px] animate-float"></div>
                            <div className="absolute bottom-40 right-10 w-48 h-48 bg-coco-blue/30 rounded-full blur-[80px] animate-float" style={{ animationDelay: '2s' }}></div>
                        </div>
                        
                        <motion.div
                            initial={{ scale: 0.8, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            transition={{ duration: 0.6 }}
                            className="text-center z-10"
                        >
                            <div className="text-6xl mb-4">ğŸ </div>
                            <h1 className="text-4xl font-hand text-coco-text mb-2">ä¼Šå¯</h1>
                            <p className="text-coco-muted mb-8">æˆ‘ä»¬çš„æ•°å­—ç§˜å¯†å°çª</p>
                            
                            <div className="space-y-4 w-full max-w-xs">
                                <button
                                    onClick={() => setMode('create')}
                                    className="w-full py-4 bg-coco-pink rounded-2xl text-white font-medium jelly shadow-lg"
                                >
                                    ç”Ÿæˆçº¢çº¿æš—å·
                                </button>
                                <button
                                    onClick={() => setMode('join')}
                                    className="w-full py-4 bg-white rounded-2xl text-coco-text font-medium jelly shadow-lg border border-white/60"
                                >
                                    ç‰µæ‰‹ TA
                                </button>
                            </div>
                        </motion.div>
                    </div>
                );
            }
            
            return (
                <div className="h-full flex flex-col p-6 overflow-y-auto">
                    <button 
                        onClick={() => setMode('welcome')}
                        className="text-coco-muted text-sm mb-6 jelly self-start"
                    >
                        â† è¿”å›
                    </button>
                    
                    {mode === 'create' ? (
                        <motion.div
                            initial={{ x: 50, opacity: 0 }}
                            animate={{ x: 0, opacity: 1 }}
                            className="flex-1 flex flex-col"
                        >
                            <h2 className="text-2xl font-hand text-coco-text mb-6">æ­å»ºå°çª</h2>
                            
                            <div className="space-y-4 flex-1">
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">æˆ‘çš„åå­—</label>
                                    <input
                                        type="text"
                                        value={myName}
                                        onChange={(e) => setMyName(e.target.value)}
                                        placeholder="ä½ çš„æ˜µç§°"
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">TA çš„åå­—</label>
                                    <input
                                        type="text"
                                        value={partnerName}
                                        onChange={(e) => setPartnerName(e.target.value)}
                                        placeholder="äº²çˆ±çš„ TA"
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">åœ¨ä¸€èµ·çš„æ—¥å­</label>
                                    <input
                                        type="date"
                                        value={loveDate}
                                        onChange={(e) => setLoveDate(e.target.value)}
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30 text-coco-text"
                                    />
                                </div>
                                
                                <div className="bg-coco-pink/20 p-4 rounded-2xl">
                                    <p className="text-sm text-coco-text">
                                        <span className="font-medium">ç”Ÿæˆæš—å·å</span>ï¼Œè¯·å°†æš—å·å¤åˆ¶å‘é€ç»™ TAï¼Œè®© TA æ¥ç‰µæ‰‹ä½ ä»¬çš„å°çª~
                                    </p>
                                </div>
                            </div>
                            
                            <button
                                onClick={handleCreate}
                                disabled={isLoading}
                                className="w-full py-4 bg-coco-pink rounded-2xl text-white font-medium jelly shadow-lg mt-6 disabled:opacity-50"
                            >
                                {isLoading ? 'æ­å»ºä¸­...' : 'ç”Ÿæˆçº¢çº¿æš—å·'}
                            </button>
                        </motion.div>
                    ) : (
                        <motion.div
                            initial={{ x: -50, opacity: 0 }}
                            animate={{ x: 0, opacity: 1 }}
                            className="flex-1 flex flex-col"
                        >
                            <h2 className="text-2xl font-hand text-coco-text mb-6">ç‰µæ‰‹ TA</h2>
                            
                            <div className="space-y-4 flex-1">
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">æˆ‘çš„åå­—</label>
                                    <input
                                        type="text"
                                        value={myName}
                                        onChange={(e) => setMyName(e.target.value)}
                                        placeholder="ä½ çš„æ˜µç§°"
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">TA å‘æ¥çš„æš—å·</label>
                                    <input
                                        type="text"
                                        value={partnerId}
                                        onChange={(e) => setPartnerId(e.target.value)}
                                        placeholder="ç²˜è´´æš—å·"
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm text-coco-muted mb-2">åœ¨ä¸€èµ·çš„æ—¥å­</label>
                                    <input
                                        type="date"
                                        value={loveDate}
                                        onChange={(e) => setLoveDate(e.target.value)}
                                        className="w-full p-4 glass-card rounded-2xl focus:ring-2 focus:ring-coco-pink/30 text-coco-text"
                                    />
                                </div>
                            </div>
                            
                            <button
                                onClick={handleJoin}
                                disabled={isLoading}
                                className="w-full py-4 bg-coco-pink rounded-2xl text-white font-medium jelly shadow-lg mt-6 disabled:opacity-50"
                            >
                                {isLoading ? 'ç‰µæ‰‹ing...' : 'ç‰µæ‰‹ TA'}
                            </button>
                        </motion.div>
                    )}
                </div>
            );
        };
        
        // æ ‘æ´å¡ç‰‡ç»„ä»¶
        const TreeholeCard = ({ treehole }) => {
            const { user, likeTreehole, replyTreehole } = useContext(AppContext);
            const [showReplyInput, setShowReplyInput] = useState(false);
            const [replyContent, setReplyContent] = useState('');
            const [showBurst, setShowBurst] = useState(false);
            const cardRef = useRef(null);
            
            const handleLike = () => {
                likeTreehole(treehole.id);
                setShowBurst(true);
            };
            
            const handleReply = () => {
                if (replyContent.trim()) {
                    replyTreehole(treehole.id, replyContent);
                    setReplyContent('');
                    setShowReplyInput(false);
                }
            };
            
            const quickReplies = ['æŠ±æŠ±ä½ ', 'æˆ‘åœ¨å‘¢', 'è¾›è‹¦å•¦'];
            
            return (
                <motion.div
                    ref={cardRef}
                    initial={{ y: 30, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    className="glass-card rounded-3xl p-5 mb-4 relative overflow-hidden"
                >
                    {showBurst && <HeartBurst onComplete={() => setShowBurst(false)} />}
                    
                    <div className="flex items-start gap-3">
                        <div className="text-2xl">{treehole.isAnonymous ? 'ğŸ­' : 'ğŸ’¬'}</div>
                        <div className="flex-1">
                            <p className="text-coco-text leading-relaxed">{treehole.content}</p>
                            <div className="flex items-center gap-3 mt-3 text-xs text-coco-muted">
                                <span>{treehole.authorName}</span>
                                <span>Â·</span>
                                <span>{formatTime(treehole.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* æ“ä½œæ  */}
                    <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-100">
                        <button
                            onClick={handleLike}
                            className="flex items-center gap-1.5 jelly"
                        >
                            <motion.span
                                whileTap={{ scale: 0.8 }}
                                animate={showBurst ? { scale: [1, 1.4, 1] } : {}}
                                className={`${treehole.likedBy.includes(user?.id) ? 'text-coco-heart' : 'text-coco-muted'}`}
                            >
                                â¤ï¸
                            </motion.span>
                            <span className={`text-sm ${treehole.likedBy.includes(user?.id) ? 'text-coco-heart' : 'text-coco-muted'}`}>
                                {treehole.likes}
                            </span>
                        </button>
                        
                        <button
                            onClick={() => setShowReplyInput(!showReplyInput)}
                            className="flex items-center gap-1.5 jelly"
                        >
                            <span className="text-coco-muted">ğŸ’Œ</span>
                            <span className="text-sm text-coco-muted">å›å¤</span>
                        </button>
                        
                        {treehole.replies?.length > 0 && (
                            <span className="text-xs text-coco-muted">
                                {treehole.replies.length} æ¡å›å¤
                            </span>
                        )}
                    </div>
                    
                    {/* å›å¤è¾“å…¥ */}
                    <AnimatePresence>
                        {showReplyInput && (
                            <motion.div
                                initial={{ height: 0, opacity: 0 }}
                                animate={{ height: 'auto', opacity: 1 }}
                                exit={{ height: 0, opacity: 0 }}
                                className="mt-4 overflow-hidden"
                            >
                                <div className="flex gap-2 mb-2 overflow-x-auto py-1">
                                    {quickReplies.map(reply => (
                                        <button
                                            key={reply}
                                            onClick={() => {
                                                replyTreehole(treehole.id, reply);
                                                setShowReplyInput(false);
                                            }}
                                            className="px-3 py-1 bg-coco-pink/20 text-coco-text text-sm rounded-full whitespace-nowrap jelly"
                                        >
                                            {reply}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={replyContent}
                                        onChange={(e) => setReplyContent(e.target.value)}
                                        placeholder="å†™ä¸‹ä½ çš„å›å¤..."
                                        className="flex-1 p-2 bg-white/50 rounded-xl text-sm focus:outline-none"
                                        onKeyPress={(e) => e.key === 'Enter' && handleReply()}
                                    />
                                    <button
                                        onClick={handleReply}
                                        className="px-4 py-2 bg-coco-pink rounded-xl text-white text-sm jelly"
                                    >
                                        å‘é€
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                    
                    {/* å›å¤åˆ—è¡¨ */}
                    {treehole.replies?.length > 0 && (
                        <div className="mt-4 space-y-2 border-t border-gray-100 pt-4">
                            {treehole.replies.map((reply, i) => (
                                <motion.div
                                    key={reply.id || i}
                                    initial={{ x: -10, opacity: 0 }}
                                    animate={{ x: 0, opacity: 1 }}
                                    transition={{ delay: i * 0.1 }}
                                    className="bg-white/30 rounded-xl p-3 text-sm"
                                >
                                    <span className="font-medium text-coco-pink">{reply.authorName}: </span>
                                    <span className="text-coco-text">{reply.content}</span>
                                </motion.div>
                            ))}
                        </div>
                    )}
                </motion.div>
            );
        };
        
        // å¾…åŠå¡ç‰‡ç»„ä»¶
        const TodoCard = ({ todo }) => {
            const { completeTodo, deleteTodo } = useContext(AppContext);
            const [isStriking, setIsStriking] = useState(false);
            const [isFalling, setIsFalling] = useState(false);
            
            const handleComplete = () => {
                setIsStriking(true);
                setTimeout(() => {
                    setIsFalling(true);
                    setTimeout(() => {
                        completeTodo(todo.id);
                        setIsFalling(false);
                    }, 400);
                }, 400);
            };
            
            if (isFalling) {
                return (
                    <motion.div
                        initial={{ x: 0, y: 0, opacity: 1 }}
                        animate={{ x: 20, y: 100, opacity: 0 }}
                        transition={{ duration: 0.4, ease: 'easeIn' }}
                        className="glass-card rounded-3xl p-4 mb-3 bg-gray-50"
                    >
                        <div className="flex items-center gap-3">
                            <div className="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span className="text-gray-400 line-through">{todo.content}</span>
                        </div>
                    </motion.div>
                );
            }
            
            return (
                <motion.div
                    initial={{ y: 20, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    className={`glass-card rounded-3xl p-4 mb-3 transition-all duration-300 ${isStriking ? 'bg-gray-50' : ''}`}
                >
                    <div className="flex items-center gap-3">
                        <button
                            onClick={handleComplete}
                            className="flex-shrink-0 w-6 h-6 rounded-full border-2 border-coco-pink flex items-center justify-center jelly"
                        >
                            {todo.completed && (
                                <motion.div
                                    initial={{ scale: 0 }}
                                    animate={{ scale: 1 }}
                                    className="w-4 h-4 rounded-full bg-coco-pink"
                                />
                            )}
                        </button>
                        
                        <div className="flex-1 min-w-0">
                            <div className={`text-coco-text ${todo.completed ? 'line-through text-gray-400' : ''}`}>
                                {todo.content}
                            </div>
                            <div className="text-xs text-coco-muted mt-1 flex items-center gap-2">
                                <span>{todo.category === 'partner' ? 'ğŸ«‚ TA èº«è¾¹çš„å°äº‹' : 'ğŸŒŸ ä¸€èµ·å®Œæˆçš„æˆå°±'}</span>
                            </div>
                        </div>
                        
                        {!todo.completed && (
                            <button
                                onClick={() => deleteTodo(todo.id)}
                                className="text-coco-muted jelly p-1"
                            >
                                <span className="text-sm">Ã—</span>
                            </button>
                        )}
                    </div>
                    
                    {/* é­”æ³•ä¸‹åˆ’çº¿åŠ¨ç”» */}
                    <motion.div
                        className={`h-0.5 bg-coco-pink/50 mt-3 ${isStriking ? 'magic-strike struck' : 'magic-strike'}`}
                        style={{ transition: isStriking ? 'none' : undefined }}
                    />
                </motion.div>
            );
        };
        
        // å½•éŸ³ç»„ä»¶
        const VoiceRecorder = () => {
            const { addVoiceMemo, showToast } = useContext(AppContext);
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [audioBlob, setAudioBlob] = useState(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);
            
            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    
                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            chunksRef.current.push(e.data);
                        }
                    };
                    
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        setAudioBlob(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordingTime(0);
                    
                    timerRef.current = setInterval(() => {
                        setRecordingTime(t => t + 1);
                    }, 1000);
                } catch (e) {
                    showToast('æ— æ³•è®¿é—®éº¦å…‹é£...');
                }
            };
            
            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    clearInterval(timerRef.current);
                }
            };
            
            const saveRecording = () => {
                if (audioBlob) {
                    addVoiceMemo(audioBlob, recordingTime);
                    setAudioBlob(null);
                    setRecordingTime(0);
                    showToast('å£°éŸ³å·²é€è¾¾~');
                }
            };
            
            const formatTime = (s) => {
                const mins = Math.floor(s / 60);
                const secs = s % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            return (
                <div className="flex flex-col items-center py-8">
                    <motion.div
                        animate={isRecording ? { scale: [1, 1.1, 1] } : {}}
                        transition={{ duration: 1, repeat: Infinity }}
                        className="relative"
                    >
                        {/* å½•éŸ³æ°´æ³¢çº¹ */}
                        {isRecording && (
                            <>
                                <div className="record-ripple absolute inset-0"></div>
                                <div className="record-ripple absolute inset-0" style={{ animationDelay: '0.5s' }}></div>
                            </>
                        )}
                        
                        <button
                            onClick={isRecording ? stopRecording : startRecording}
                            className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl transition-all duration-300
                                ${isRecording ? 'bg-coco-heart text-white' : 'bg-coco-pink text-white'} 
                                jelly shadow-lg`}
                        >
                            {isRecording ? 'â¹' : 'ğŸ™ï¸'}
                        </button>
                    </motion.div>
                    
                    <div className="mt-4 text-center">
                        <div className={`text-2xl font-hand ${isRecording ? 'text-coco-heart' : 'text-coco-muted'}`}>
                            {isRecording ? formatTime(recordingTime) : 'æŒ‰ä½å½•éŸ³'}
                        </div>
                        
                        {audioBlob && (
                            <motion.div
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="mt-4 flex items-center gap-3"
                            >
                                <audio src={URL.createObjectURL(audioBlob)} controls className="h-8" />
                                <button
                                    onClick={saveRecording}
                                    className="px-4 py-2 bg-coco-pink rounded-full text-white text-sm jelly"
                                >
                                    å‘é€
                                </button>
                                <button
                                    onClick={() => setAudioBlob(null)}
                                    className="px-4 py-2 bg-gray-200 rounded-full text-coco-text text-sm jelly"
                                >
                                    å–æ¶ˆ
                                </button>
                            </motion.div>
                        )}
                    </div>
                    
                    <p className="text-xs text-coco-muted mt-4">é•¿æŒ‰å¼€å§‹å½•éŸ³</p>
                </div>
            );
        };
        
        // è¯­éŸ³æ¶ˆæ¯å¡ç‰‡
        const VoiceMemoCard = ({ memo }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const audioRef = useRef(null);
            
            const togglePlay = () => {
                if (audioRef.current) {
                    if (isPlaying) {
                        audioRef.current.pause();
                    } else {
                        audioRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };
            
            return (
                <motion.div
                    initial={{ scale: 0.9, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="glass-card rounded-3xl p-4 mb-3"
                >
                    <div className="flex items-center gap-4">
                        <button
                            onClick={togglePlay}
                            className="w-12 h-12 rounded-full bg-coco-pink flex items-center justify-center text-white jelly"
                        >
                            {isPlaying ? 'â¸' : 'â–¶ï¸'}
                        </button>
                        
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-medium text-coco-text">{memo.authorName}</span>
                                <span className="text-xs text-coco-muted">{formatTime(memo.createdAt)}</span>
                            </div>
                            
                            {/* ç®€æ˜“æ³¢å½¢ */}
                            <div className="flex items-center gap-0.5 mt-2 h-6">
                                {[...Array(20)].map((_, i) => (
                                    <motion.div
                                        key={i}
                                        animate={isPlaying ? { height: [4, Math.random() * 16 + 4, 4] } : { height: 4 }}
                                        transition={{ duration: 0.3, repeat: Infinity, delay: i * 0.05 }}
                                        className="w-1 bg-coco-pink/60 rounded-full"
                                    />
                                ))}
                            </div>
                        </div>
                        
                        <audio
                            ref={audioRef}
                            src={memo.audio}
                            onEnded={() => setIsPlaying(false)}
                        />
                        
                        <span className="text-xs text-coco-muted">
                            {Math.floor(memo.duration / 60)}:{String(memo.duration % 60).padStart(2, '0')}
                        </span>
                    </div>
                </motion.div>
            );
        };
        
        // ä¾§è¾¹æ 
        const Sidebar = ({ isOpen, onClose }) => {
            const { exportData, importData, user, partner, loveStartDate, setNotifications, notifications } = useContext(AppContext);
            const fileInputRef = useRef(null);
            
            const handleImport = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    importData(file);
                }
            };
            
            return (
                <AnimatePresence>
                    {isOpen && (
                        <>
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                onClick={onClose}
                                className="fixed inset-0 bg-black/20 z-40"
                            />
                            <motion.div
                                initial={{ x: '100%' }}
                                animate={{ x: 0 }}
                                exit={{ x: '100%' }}
                                transition={{ type: 'spring', damping: 25 }}
                                className="fixed right-0 top-0 bottom-0 w-72 bg-[#FDFBF7] z-50 shadow-2xl p-6 overflow-y-auto"
                            >
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-xl font-hand text-coco-text">å›å¿†ä¿é™©ç®±</h2>
                                    <button onClick={onClose} className="text-coco-muted text-2xl jelly">Ã—</button>
                                </div>
                                
                                <div className="space-y-6">
                                    {/* ç»Ÿè®¡å¡ç‰‡ */}
                                    <div className="glass-card rounded-2xl p-4">
                                        <h3 className="text-sm font-medium text-coco-muted mb-3">æˆ‘ä»¬çš„æ—¶å…‰</h3>
                                        <div className="text-3xl font-hand text-coco-pink">
                                            {loveStartDate ? calculateLoveDays(loveStartDate) : 0} å¤©
                                        </div>
                                        <p className="text-xs text-coco-muted mt-1">
                                            ä» {loveStartDate ? formatDate(loveStartDate) : '...'} å¼€å§‹
                                        </p>
                                    </div>
                                    
                                    {/* æç¤ºéŸ³è®¾ç½® */}
                                    <div className="glass-card rounded-2xl p-4">
                                        <h3 className="text-sm font-medium text-coco-muted mb-3">ä¸“å±æç¤ºéŸ³</h3>
                                        <label className="flex items-center gap-3">
                                            <input
                                                type="checkbox"
                                                checked={notifications.soundEnabled}
                                                onChange={(e) => setNotifications(prev => ({ ...prev, soundEnabled: e.target.checked }))}
                                                className="w-5 h-5 rounded-full accent-coco-pink"
                                            />
                                            <span className="text-sm text-coco-text">æ”¶åˆ°æ¶ˆæ¯æ—¶æ’­æ”¾æç¤ºéŸ³</span>
                                        </label>
                                    </div>
                                    
                                    {/* æ•°æ®ç®¡ç† */}
                                    <div className="space-y-3">
                                        <button
                                            onClick={exportData}
                                            className="w-full py-3 bg-coco-pink/20 rounded-xl text-coco-text text-sm jelly"
                                        >
                                            ğŸ“¦ æ‰“åŒ…å›å¿†ï¼ˆå¯¼å‡ºï¼‰
                                        </button>
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full py-3 bg-coco-blue/30 rounded-xl text-coco-text text-sm jelly"
                                        >
                                            ğŸ“¥ æ¢å¤æ—¶å…‰ï¼ˆå¯¼å…¥ï¼‰
                                        </button>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".json"
                                            onChange={handleImport}
                                            className="hidden"
                                        />
                                    </div>
                                    
                                    {/* å…³äº */}
                                    <div className="pt-6 border-t border-gray-200">
                                        <p className="text-xs text-coco-muted text-center">
                                            ä¼Šå¯ Yike v1.0<br/>
                                            ç”¨çˆ±ç¼–ç»‡çš„æ•°å­—å°çª
                                        </p>
                                    </div>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>
            );
        };
        
        // ä¸»é¡µ
        const HomePage = () => {
            const { 
                user, partner, connectionStatus, 
                treeholes, todos, voiceMemos, 
                loveStartDate, addTreehole, addTodo,
                showToast 
            } = useContext(AppContext);
            
            const [activeTab, setActiveTab] = useState('treehole'); // treehole, todo, voice
            const [showSidebar, setShowSidebar] = useState(false);
            const [newTreehole, setNewTreehole] = useState('');
            const [isAnonymous, setIsAnonymous] = useState(false);
            const [showTodoInput, setShowTodoInput] = useState(false);
            const [newTodo, setNewTodo] = useState('');
            const [todoCategory, setTodoCategory] = useState('partner');
            const treeholeInputRef = useRef(null);
            
            const handleSubmitTreehole = () => {
                if (newTreehole.trim()) {
                    addTreehole(newTreehole, isAnonymous);
                    setNewTreehole('');
                    setIsAnonymous(false);
                }
            };
            
            const handleSubmitTodo = () => {
                if (newTodo.trim()) {
                    addTodo(newTodo, todoCategory);
                    setNewTodo('');
                    setShowTodoInput(false);
                }
            };
            
            const partnerTodos = todos.filter(t => t.category === 'partner' && !t.completed);
            const togetherTodos = todos.filter(t => t.category === 'together' && !t.completed);
            const completedTodos = todos.filter(t => t.completed);
            
            return (
                <div className="h-full flex flex-col bg-[#FDFBF7]">
                    {/* åŠ¨æ€èƒŒæ™¯å…‰æ–‘ */}
                    <div className="fixed inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-0 left-0 w-64 h-64 bg-coco-pink/20 rounded-full blur-[100px] animate-float"></div>
                        <div className="absolute bottom-0 right-0 w-72 h-72 bg-coco-blue/20 rounded-full blur-[100px] animate-float" style={{ animationDelay: '3s' }}></div>
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-purple-100/20 rounded-full blur-[120px] animate-float" style={{ animationDelay: '1.5s' }}></div>
                    </div>
                    
                    {/* é¡¶éƒ¨æ  */}
                    <div className="relative z-10 px-5 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-coco-pink/30 flex items-center justify-center">
                                <span className="text-sm">ğŸ‘«</span>
                            </div>
                            <div>
                                <h1 className="text-lg font-medium text-coco-text">
                                    {partner?.name || 'TA'}
                                </h1>
                                <BreathingIndicator isOnline={connectionStatus === 'connected'} />
                            </div>
                        </div>
                        
                        <button
                            onClick={() => setShowSidebar(true)}
                            className="p-2 rounded-full bg-white/50 jelly"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-coco-text">
                                <path d="M3 12h.01M3 6h.01M3 18h.01M21 12h.01M21 6h.01M21 18h.01M12 3v.01M12 6v.01M12 18v.01"/>
                            </svg>
                        </button>
                    </div>
                    
                    {/* æ‹çˆ±å¤©æ•°å¤§æ ‡é¢˜ */}
                    <div className="relative z-10 px-5 mb-4">
                        <div className="glass-card rounded-3xl p-6 text-center">
                            <p className="text-sm text-coco-muted mb-1">æˆ‘ä»¬åœ¨ä¸€èµ·</p>
                            <p className="text-5xl font-hand text-coco-text">
                                {loveStartDate ? calculateLoveDays(loveStartDate) : 0}
                            </p>
                            <p className="text-sm text-coco-muted mt-1">å¤© ğŸ’•</p>
                        </div>
                    </div>
                    
                    {/* Tab åˆ‡æ¢ */}
                    <div className="relative z-10 px-5 mb-4">
                        <div className="flex gap-2 p-1 bg-white/40 rounded-2xl">
                            {[
                                { id: 'treehole', icon: 'ğŸŒ³', label: 'æ ‘æ´' },
                                { id: 'todo', icon: 'ğŸ“‹', label: 'å¾…åŠ' },
                                { id: 'voice', icon: 'ğŸ™ï¸', label: 'è¯­éŸ³' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-1 py-2.5 rounded-xl text-sm font-medium transition-all duration-300
                                        ${activeTab === tab.id 
                                            ? 'bg-coco-pink text-white shadow-lg' 
                                            : 'text-coco-muted hover:text-coco-text'}`}
                                >
                                    {tab.icon} {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* å†…å®¹åŒº */}
                    <div className="relative z-10 flex-1 overflow-y-auto px-5 pb-24">
                        <AnimatePresence mode="wait">
                            
                            {/* æ ‘æ´ Tab */}
                            {activeTab === 'treehole' && (
                                <motion.div
                                    key="treehole"
                                    initial={{ opacity: 0, y: 20 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    exit={{ opacity: 0, y: -20 }}
                                >
                                    {/* è¾“å…¥æ¡† */}
                                    <div className="glass-card rounded-3xl p-4 mb-4">
                                        <textarea
                                            ref={treeholeInputRef}
                                            value={newTreehole}
                                            onChange={(e) => setNewTreehole(e.target.value)}
                                            placeholder="åœ¨è¿™é‡Œå†™ä¸‹æƒ³å¯¹ TA è¯´çš„è¯..."
                                            className="w-full resize-none text-sm text-coco-text placeholder-coco-muted bg-transparent focus:outline-none"
                                            rows={2}
                                        />
                                        <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                                            <label className="flex items-center gap-2 text-sm text-coco-muted cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={isAnonymous}
                                                    onChange={(e) => setIsAnonymous(e.target.checked)}
                                                    className="w-4 h-4 rounded accent-coco-pink"
                                                />
                                                <span className={isAnonymous ? 'text-coco-pink' : ''}>ğŸ­ åŒ¿å</span>
                                            </label>
                                            <button
                                                onClick={handleSubmitTreehole}
                                                className="px-4 py-2 bg-coco-pink rounded-xl text-white text-sm jelly"
                                            >
                                                æŠ•é€’
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* æ ‘æ´åˆ—è¡¨ */}
                                    {treeholes.length === 0 ? (
                                        <motion.div
                                            initial={{ scale: 0.9, opacity: 0 }}
                                            animate={{ scale: 1, opacity: 1 }}
                                            className="text-center py-12"
                                        >
                                            <svg width="80" height="60" viewBox="0 0 80 60" className="mailbox-draw mx-auto mb-4">
                                                <path d="M10 60 L10 20 Q10 10 20 10 L60 10 Q70 10 70 20 L70 60"/>
                                                <rect x="30" y="35" width="20" height="25" rx="2"/>
                                                <path d="M15 60 L25 50 M65 60 L55 50"/>
                                            </svg>
                                            <p className="text-coco-muted">è¿™é‡Œè¿˜æ²¡å¡è¿›å¿ƒäº‹</p>
                                            <p className="text-sm text-coco-muted">å¿«å»ç§ä¸‹ç¬¬ä¸€é¢—ç§å­å§ ğŸŒ±</p>
                                        </motion.div>
                                    ) : (
                                        <div className="space-y-1">
                                            <AnimatePresence>
                                                {treeholes.map((treehole, i) => (
                                                    <motion.div
                                                        key={treehole.id}
                                                        initial={{ y: 20, opacity: 0 }}
                                                        animate={{ y: 0, opacity: 1 }}
                                                        transition={{ delay: i * 0.05 }}
                                                    >
                                                        <TreeholeCard treehole={treehole} />
                                                    </motion.div>
                                                ))}
                                            </AnimatePresence>
                                        </div>
                                    )}
                                </motion.div>
                            )}
                            
                            {/* å¾…åŠ Tab */}
                            {activeTab === 'todo' && (
                                <motion.div
                                    key="todo"
                                    initial={{ opacity: 0, y: 20 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    exit={{ opacity: 0, y: -20 }}
                                    className="space-y-6"
                                >
                                    {/* TA èº«è¾¹çš„å°äº‹ */}
                                    <div>
                                        <h3 className="text-sm font-medium text-coco-text mb-3 flex items-center gap-2">
                                            <span>ğŸ«‚</span> TA èº«è¾¹çš„å°äº‹
                                        </h3>
                                        {partnerTodos.length === 0 ? (
                                            <p className="text-sm text-coco-muted text-center py-4 bg-white/30 rounded-xl">
                                                è¿˜æ²¡æœ‰æƒ³å¸® TA å®Œæˆçš„äº‹å‘¢ ğŸ’­
                                            </p>
                                        ) : (
                                            partnerTodos.map(todo => <TodoCard key={todo.id} todo={todo} />)
                                        )}
                                    </div>
                                    
                                    {/* ä¸€èµ·å®Œæˆçš„æˆå°± */}
                                    <div>
                                        <h3 className="text-sm font-medium text-coco-text mb-3 flex items-center gap-2">
                                            <span>ğŸŒŸ</span> ä¸€èµ·å®Œæˆçš„æˆå°±
                                        </h3>
                                        {togetherTodos.length === 0 ? (
                                            <p className="text-sm text-coco-muted text-center py-4 bg-white/30 rounded-xl">
                                                è¿˜æ²¡æœ‰å…±åŒçš„é‡Œç¨‹ç¢‘å‘¢ âœ¨
                                            </p>
                                        ) : (
                                            togetherTodos.map(todo => <TodoCard key={todo.id} todo={todo} />)
                                        )}
                                    </div>
                                    
                                    {/* æ·»åŠ å¾…åŠ */}
                                    {!showTodoInput ? (
                                        <button
                                            onClick={() => setShowTodoInput(true)}
                                            className="w-full py-3 border-2 border-dashed border-coco-pink/30 rounded-xl text-coco-pink text-sm jelly"
                                        >
                                            + æ·»åŠ æ–°çš„æœŸå¾…
                                        </button>
                                    ) : (
                                        <motion.div
                                            initial={{ opacity: 0, height: 0 }}
                                            animate={{ opacity: 1, height: 'auto' }}
                                            className="glass-card rounded-3xl p-4"
                                        >
                                            <input
                                                type="text"
                                                value={newTodo}
                                                onChange={(e) => setNewTodo(e.target.value)}
                                                placeholder="å†™ä¸‹æ–°çš„æœŸå¾…..."
                                                className="w-full p-3 bg-white/50 rounded-xl text-sm mb-3 focus:outline-none"
                                                autoFocus
                                            />
                                            <div className="flex gap-2 mb-3">
                                                <button
                                                    onClick={() => setTodoCategory('partner')}
                                                    className={`flex-1 py-2 rounded-xl text-sm transition-all duration-300
                                                        ${todoCategory === 'partner' 
                                                            ? 'bg-coco-pink/20 text-coco-text' 
                                                            : 'bg-white/50 text-coco-muted'}`}
                                                >
                                                    ğŸ«‚ TA èº«è¾¹
                                                </button>
                                                <button
                                                    onClick={() => setTodoCategory('together')}
                                                    className={`flex-1 py-2 rounded-xl text-sm transition-all duration-300
                                                        ${todoCategory === 'together' 
                                                            ? 'bg-coco-pink/20 text-coco-text' 
                                                            : 'bg-white/50 text-coco-muted'}`}
                                                >
                                                    ğŸŒŸ ä¸€èµ·å®Œæˆ
                                                </button>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => setShowTodoInput(false)}
                                                    className="flex-1 py-2 bg-gray-100 rounded-xl text-coco-text text-sm jelly"
                                                >
                                                    å–æ¶ˆ
                                                </button>
                                                <button
                                                    onClick={handleSubmitTodo}
                                                    className="flex-1 py-2 bg-coco-pink rounded-xl text-white text-sm jelly"
                                                >
                                                    æ·»åŠ 
                                                </button>
                                            </div>
                                        </motion.div>
                                    )}
                                    
                                    {/* å·²å®Œæˆ */}
                                    {completedTodos.length > 0 && (
                                        <div className="pt-4 border-t border-gray-200">
                                            <h3 className="text-sm font-medium text-coco-muted mb-3 flex items-center gap-2">
                                                <span>âœ…</span> å·²å®Œæˆ ({completedTodos.length})
                                            </h3>
                                            <div className="opacity-50">
                                                {completedTodos.slice(0, 3).map(todo => (
                                                    <TodoCard key={todo.id} todo={todo} />
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </motion.div>
                            )}
                            
                            {/* è¯­éŸ³ Tab */}
                            {activeTab === 'voice' && (
                                <motion.div
                                    key="voice"
                                    initial={{ opacity: 0, y: 20 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    exit={{ opacity: 0, y: -20 }}
                                >
                                    <VoiceRecorder />
                                    
                                    {voiceMemos.length > 0 ? (
                                        <div className="mt-8 space-y-3">
                                            <h3 className="text-sm font-medium text-coco-muted mb-3">æ”¶åˆ°çš„å£°éŸ³</h3>
                                            {voiceMemos.map(memo => (
                                                <VoiceMemoCard key={memo.id} memo={memo} />
                                            ))}
                                        </div>
                                    ) : (
                                        <motion.div
                                            initial={{ scale: 0.9, opacity: 0 }}
                                            animate={{ scale: 1, opacity: 1 }}
                                            className="text-center py-12"
                                        >
                                            <span className="text-4xl mb-4 block">ğŸ”‡</span>
                                            <p className="text-coco-muted">è¿˜æ²¡æœ‰å£°éŸ³</p>
                                            <p className="text-sm text-coco-muted">æŒ‰ä½éº¦å…‹é£ tell ä½ çš„ TA ğŸ’•</p>
                                        </motion.div>
                                    )}
                                </motion.div>
                            )}
                            
                        </AnimatePresence>
                    </div>
                    
                    {/* Toast å®¹å™¨ */}
                    <div className="fixed top-0 left-0 right-0 z-50 flex flex-col items-center pointer-events-none">
                        <AnimatePresence>
                            {toasts.map(toast => (
                                <Toast key={toast.id} message={toast.message} />
                            ))}
                        </AnimatePresence>
                    </div>
                    
                    {/* ä¾§è¾¹æ  */}
                    <Sidebar isOpen={showSidebar} onClose={() => setShowSidebar(false)} />
                </div>
            );
        };
        
        // ä¸»åº”ç”¨
        const App = () => {
            const { user, connectionStatus, loveStartDate } = useContext(AppContext);
            const [isReady, setIsReady] = useState(false);
            
            useEffect(() => {
                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é—ªçƒ
                const timer = setTimeout(() => setIsReady(true), 100);
                return () => clearTimeout(timer);
            }, []);
            
            if (!isReady) {
                return (
                    <div className="h-screen flex items-center justify-center bg-[#FDFBF7]">
                        <div className="text-center">
                            <div className="text-4xl mb-4 animate-bounce">ğŸ </div>
                            <p className="text-coco-muted">æ­£åœ¨æ­å»ºå°çª...</p>
                        </div>
                    </div>
                );
            }
            
            // å¦‚æœè¿˜æ²¡æœ‰é…å¯¹ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¼•å¯¼é¡µ
            if (!user) {
                return <OnboardingPage />;
            }
            
            // å¦‚æœé…å¯¹æˆåŠŸä½†è¿˜åœ¨è¿æ¥ä¸­ï¼Œæ˜¾ç¤ºè½»é‡è¿æ¥çŠ¶æ€
            return (
                <div className="h-screen flex flex-col">
                    {connectionStatus === 'disconnected' && (
                        <motion.div
                            initial={{ y: -50, opacity: 0 }}
                            animate={{ y: 0, opacity: 1 }}
                            className="bg-yellow-50 px-4 py-2 text-center text-sm text-yellow-700"
                        >
                            å“å‘€ï¼Œä¸ TA æš‚æ—¶èµ°æ•£äº†ï¼Œæ­£åœ¨åŠªåŠ›é‡æ–°ç‰µæ‰‹...
                        </motion.div>
                    )}
                    <div className="flex-1 overflow-hidden">
                        <HomePage />
                    </div>
                </div>
            );
        };
        
        // æ ¹ç»„ä»¶
        const Root = () => (
            <AppProvider>
                <App />
            </AppProvider>
        );
        
        // æ¸²æŸ“
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
    
    <script>
        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            // æš‚æ—¶ä¸æ³¨å†Œ SWï¼Œå› ä¸ºè¿™æ˜¯çº¯é™æ€æ–‡ä»¶
        }
        
        // PWA æ ·å¼æ³¨å…¥
        document.addEventListener('DOMContentLoaded', () => {
            // æ·»åŠ  iOS æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                /* iOS é€‚é… */
                @supports (-webkit-touch-callout: none) {
                    body {
                        min-height: -webkit-fill-available;
                    }
                }
                
                /* å®‰å…¨åŒºåŸŸé€‚é… */
                .safe-area-bottom {
                    padding-bottom: env(safe-area-inset-bottom, 20px);
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
