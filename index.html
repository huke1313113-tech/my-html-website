<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¼Šå¯ Yike | æƒ…ä¾£å°çª</title>
    
    <!-- å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', '"PingFang SC"', 'sans-serif'] },
                    colors: {
                        bg: '#FDFBF7',
                        card: '#FFFFFF',
                        primary: '#D4A5A5',
                        primaryLight: '#E8CFC8',
                        secondary: '#A8B5B8',
                        secondaryLight: '#C5D6D8',
                        accent: '#B8C9BC',
                        accentLight: '#D4E4DE',
                        yellow: '#E8DCCA',
                        yellowLight: '#F5EFE0',
                        text: '#5C5552',
                        textLight: '#9E9591',
                        textLighter: '#C4BEB9',
                        danger: '#D98181',
                        success: '#A8C9A8',
                        homeBg: '#FDFBF7',
                        treeholeBg: '#FAF5F0',
                        todoBg: '#F5F7F5',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-soft': 'pulse 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                    }
                }
            }
        }
    </script>
    
    <!-- æ ¸å¿ƒä¾èµ–åº“ -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.staticfile.net/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.staticfile.net/peerjs/1.5.2/peerjs.min.js"></script>

    <style>
        body { background: #E5E7EB; display: flex; justify-content: center; margin: 0; min-height: 100vh; }
        #app { width: 100%; max-width: 420px; height: 100dvh; background: #FDFBF7; position: relative; overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.08); }
        .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.6); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å½•éŸ³æ³¢å½¢åŠ¨ç”» */
        .recording-wave { animation: wave 0.8s ease-in-out infinite; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.6); } }
        
        /* å¿ƒè·³åŠ¨ç”» */
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 14% { transform: scale(1.1); } 28% { transform: scale(1); } 42% { transform: scale(1.1); } 70% { transform: scale(1); } }
        .heartbeat { animation: heartbeat 1.5s ease-in-out infinite; }

        /* è¿æ¥ä¸­æ—‹è½¬ */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="app">
        <div id="root"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- å·¥å…·å‡½æ•° ---
        const generateId = () => 'yike_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        const formatTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        };
        const formatDateOnly = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        };
        const getDays = (ts) => {
            if (!ts) return 0;
            const start = new Date(ts);
            const now = new Date();
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            return Math.floor((now - start) / (1000 * 60 * 60 * 24));
        };

        // --- å›¾æ ‡åº“ ---
        const Icons = {
            Heart: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Home: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Msg: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            List: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Plus: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Send: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Check: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Setting: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Mic: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            MicOff: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Trash: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Clock: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Calendar: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Close: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Copy: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Play: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Delete: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Refresh: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            FileAudio: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
            Wifi: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
        };

        // ================= ä¸»åº”ç”¨ =================
        function App() {
            const [view, setView] = useState('loading');
            const [tab, setTab] = useState('home');
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState(null);
            const [loadingProgress, setLoadingProgress] = useState('æ­£åœ¨åˆå§‹åŒ–...');
            
            // æ•°æ®
            const [myId, setMyId] = useState('');
            const [partnerId, setPartnerId] = useState('');
            const [anniversary, setAnniversary] = useState(null);
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            
            // è¿æ¥çŠ¶æ€
            const [connStatus, setConnStatus] = useState('disconnected');
            const [conn, setConn] = useState(null);
            const peerRef = useRef(null);
            const reconnectTimerRef = useRef(null);

            // åˆå§‹åŒ– - åˆ†ç¦»ä¸ºå¤šä¸ªæ­¥éª¤
            useEffect(() => {
                let mounted = true;
                
                const initApp = async () => {
                    if (!mounted) return;
                    setLoadingProgress('è¯»å–æœ¬åœ°æ•°æ®...');
                    
                    // æ­¥éª¤1: è¯»å–æœ¬åœ°å­˜å‚¨
                    let savedMyId = localStorage.getItem('yike_myId');
                    const savedPartner = localStorage.getItem('yike_partnerId');
                    const savedAnniversary = localStorage.getItem('yike_anniversary');
                    
                    if (savedAnniversary) setAnniversary(Number(savedAnniversary));
                    
                    // æ­¥éª¤2: å¼‚æ­¥è¯»å– IndexedDBï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
                    const loadData = async () => {
                        const msgs = await localforage.getItem('yike_msgs') || [];
                        const todos = await localforage.getItem('yike_todos') || [];
                        return { msgs, todos };
                    };
                    
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©å‡ºä¸»çº¿ç¨‹
                    await new Promise(r => setTimeout(r, 100));
                    if (!mounted) return;
                    
                    const data = await loadData();
                    if (!mounted) return;
                    
                    setMessages(data.msgs);
                    setTodos(data.todos);
                    
                    // æ­¥éª¤3: ç¡®å®šå…¥å£
                    setLoadingProgress('æ£€æŸ¥è¿æ¥çŠ¶æ€...');
                    await new Promise(r => setTimeout(r, 100));
                    if (!mounted) return;

                    if (!savedMyId) {
                        // é¦–æ¬¡ä½¿ç”¨ï¼Œç”ŸæˆID
                        savedMyId = generateId();
                        localStorage.setItem('yike_myId', savedMyId);
                        if (!mounted) return;
                        setMyId(savedMyId);
                        setView('login');
                    } else {
                        // æœ‰è®°å½•ï¼Œç›´æ¥è¿›å…¥
                        setMyId(savedMyId);
                        if (savedPartner) {
                            setPartnerId(savedPartner);
                            setView('home');
                            // åå°åˆå§‹åŒ–è¿æ¥
                            setTimeout(() => initPeer(savedMyId, savedPartner), 500);
                        } else {
                            setView('login');
                        }
                    }
                };

                initApp();
                
                return () => {
                    mounted = false;
                    if (reconnectTimerRef.current) clearTimeout(reconnectTimerRef.current);
                    if (peerRef.current) peerRef.current.destroy();
                };
            }, []);

            // PeerJS è¿æ¥é€»è¾‘ - æ›´ç¨³å®š
            const initPeer = useCallback((id, pid, forceReconnect = false) => {
                if (!forceReconnect && (connStatus === 'connected' || connStatus === 'connecting')) {
                    console.log('Already connected or connecting, skip');
                    return;
                }
                
                // æ¸…ç†æ—§è¿æ¥
                if (peerRef.current) {
                    try { peerRef.current.destroy(); } catch(e) {}
                    peerRef.current = null;
                }
                if (reconnectTimerRef.current) clearTimeout(reconnectTimerRef.current);
                
                setConnStatus('connecting');
                console.log('Init Peer:', id, '->', pid);

                try {
                    const peer = new Peer(id, {
                        debug: 0,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' }
                            ]
                        }
                    });
                    peerRef.current = peer;

                    // è¶…æ—¶å¤„ç† - 8ç§’ååˆ¤å®šå¤±è´¥
                    const timeoutId = setTimeout(() => {
                        if (peerRef.current === peer) {
                            setConnStatus('disconnected');
                            console.log('Connection timeout');
                        }
                    }, 8000);

                    peer.on('open', (myPeerId) => {
                        console.log('Peer open:', myPeerId);
                        clearTimeout(timeoutId);
                        
                        if (!pid) {
                            // åˆ›å»ºè€…æ¨¡å¼ï¼Œç­‰å¾…è¿æ¥
                            setConnStatus('waiting');
                        }
                    });

                    peer.on('connection', (connection) => {
                        console.log('Incoming connection');
                        clearTimeout(timeoutId);
                        setupConnection(connection);
                    });

                    peer.on('error', (err) => {
                        console.error('Peer Error:', err);
                        clearTimeout(timeoutId);
                        setConnStatus('disconnected');
                        
                        if (err.type === 'peer-unavailable') {
                            showToast('æš—å·æ— æ•ˆ');
                        } else if (err.type === 'unavailable-id') {
                            // IDå†²çªï¼Œé‡æ–°ç”Ÿæˆ
                            const newId = generateId();
                            localStorage.setItem('yike_myId', newId);
                            showToast('æš—å·å·²æ›´æ–°ï¼Œè¯·é‡æ–°åˆ†äº«');
                            setTimeout(() => window.location.reload(), 2000);
                        } else if (err.type === 'network-disconnected') {
                            showToast('ç½‘ç»œæ–­å¼€');
                        }
                    });

                    // åˆ›å»ºè€…ä¸éœ€è¦ä¸»åŠ¨è¿æ¥
                    if (pid) {
                        const connection = peer.connect(pid, { 
                            reliable: true,
                            serialization: 'json'
                        });
                        
                        connection.on('open', () => {
                            clearTimeout(timeoutId);
                            setupConnection(connection);
                        });
                        
                        connection.on('error', (err) => {
                            console.error('Connection error:', err);
                            clearTimeout(timeoutId);
                        });
                    }

                } catch (e) {
                    console.error('Peer init error:', e);
                    setConnStatus('disconnected');
                }
            }, [connStatus]);

            const setupConnection = (c) => {
                setConn(c);
                setConnStatus('connected');
                showToast('â¤ï¸ è¿æ¥æˆåŠŸ');

                c.on('data', (data) => {
                    if (data.type === 'msg') {
                        setMessages(prev => {
                            const newMsgs = [...prev, data.payload];
                            localforage.setItem('yike_msgs', newMsgs);
                            return newMsgs;
                        });
                        showToast('æ”¶åˆ°ä¸€æ¡çº¸æ¡');
                    } else if (data.type === 'todo') {
                        setTodos(prev => {
                            const newTodos = [...prev, data.payload];
                            localforage.setItem('yike_todos', newTodos);
                            return newTodos;
                        });
                        showToast('æ”¶åˆ°æ–°å¾…åŠ');
                    } else if (data.type === 'anniversary') {
                        setAnniversary(data.payload);
                    }
                });

                c.on('close', () => {
                    setConnStatus('disconnected');
                    setConn(null);
                    showToast('è¿æ¥å·²æ–­å¼€');
                });
                
                c.on('error', () => {
                    setConnStatus('disconnected');
                });
            };

            // æ‰‹åŠ¨é‡è¿
            const handleReconnect = () => {
                const pid = localStorage.getItem('yike_partnerId');
                if (pid) {
                    showToast('æ­£åœ¨é‡è¿...');
                    initPeer(myId, pid, true);
                } else {
                    showToast('è¯·å…ˆè¾“å…¥æš—å·');
                }
            };

            // å‘é€æ•°æ®
            const sendData = (type, payload) => {
                if (type === 'msg') {
                    const newMsg = { ...payload, self: true };
                    setMessages(prev => {
                        const newMsgs = [...prev, newMsg];
                        localforage.setItem('yike_msgs', newMsgs);
                        return newMsgs;
                    });
                } else if (type === 'todo') {
                    const newTodo = { ...payload, self: true };
                    setTodos(prev => {
                        const newTodos = [...prev, newTodo];
                        localforage.setItem('yike_todos', newTodos);
                        return newTodos;
                    });
                } else if (type === 'anniversary') {
                    setAnniversary(payload);
                    localStorage.setItem('yike_anniversary', payload);
                }

                if (conn && conn.open) {
                    conn.send({ type, payload });
                }
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 2500);
            };

            const getBgColor = () => {
                switch(tab) {
                    case 'msg': return 'bg-treeholeBg';
                    case 'todo': return 'bg-todoBg';
                    default: return 'bg-homeBg';
                }
            };

            // åŠ è½½é¡µé¢
            if (view === 'loading') {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-homeBg">
                        <div className="relative mb-6">
                            <div className="w-16 h-16 rounded-full bg-primary/20 animate-pulse flex items-center justify-center">
                                <Icons.Heart className="w-8 h-8 text-primary heartbeat" />
                            </div>
                        </div>
                        <div className="w-48 h-1 bg-gray-200 rounded-full overflow-hidden mb-3">
                            <div className="h-full bg-primary animate-pulse" style={{width: '60%'}}></div>
                        </div>
                        <p className="text-textLight text-sm">{loadingProgress}</p>
                    </div>
                );
            }

            // ç™»å½•é¡µ
            if (view === 'login') return (
                <LoginView 
                    myId={myId}
                    connStatus={connStatus}
                    onJoin={(pid) => {
                        localStorage.setItem('yike_partnerId', pid);
                        setPartnerId(pid);
                        setView('home');
                        // å»¶è¿Ÿåˆå§‹åŒ–è¿æ¥ï¼Œè®©ç•Œé¢å…ˆæ˜¾ç¤º
                        setTimeout(() => initPeer(myId, pid), 300);
                    }}
                    onRefresh={handleReconnect}
                />
            );

            // é¦–é¡µ
            const days = getDays(anniversary);
            const timelineData = useMemo(() => {
                const m = messages.map(m => ({...m, kind: 'msg'}));
                const t = todos.map(t => ({...t, kind: 'todo'}));
                return [...m, ...t].sort((a, b) => b.ts - a.ts);
            }, [messages, todos]);

            return (
                <div className={`h-full flex flex-col ${getBgColor()} relative overflow-hidden transition-colors duration-500`}>
                    {/* èƒŒæ™¯è£…é¥° */}
                    <div className="absolute inset-0 pointer-events-none">
                        {tab === 'home' && (
                            <>
                                <div className="absolute top-[-15%] right-[-10%] w-[70%] h-[70%] rounded-full bg-primary/10 blur-[80px]"></div>
                                <div className="absolute bottom-[-15%] left-[-10%] w-[70%] h-[70%] rounded-full bg-secondaryLight/30 blur-[80px]"></div>
                            </>
                        )}
                        {tab === 'msg' && (
                            <>
                                <div className="absolute top-[-10%] right-[-20%] w-[80%] h-[80%] rounded-full bg-yellowLight/50 blur-[100px]"></div>
                                <div className="absolute bottom-[-10%] left-[-10%] w-[60%] h-[60%] rounded-full bg-primary/10 blur-[80px]"></div>
                            </>
                        )}
                        {tab === 'todo' && (
                            <>
                                <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] rounded-full bg-accentLight/50 blur-[80px]"></div>
                                <div className="absolute bottom-[-10%] right-[-10%] w-[70%] h-[70%] rounded-full bg-secondaryLight/30 blur-[80px]"></div>
                            </>
                        )}
                    </div>

                    {/* é¡¶éƒ¨æ  */}
                    <header className="relative z-10 px-6 pt-6 pb-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className={`w-2.5 h-2.5 rounded-full transition-all duration-500 ${
                                connStatus === 'connected' ? 'bg-success shadow-[0_0_8px_#A8C9A8]' : 
                                connStatus === 'connecting' || connStatus === 'waiting' ? 'bg-yellow-400 animate-pulse' : 'bg-gray-300'
                            }`}></div>
                            <span className="text-xs font-medium text-textLight">
                                {connStatus === 'connected' ? 'TA åœ¨çº¿' : 
                                 connStatus === 'connecting' ? 'å¯»æ‰¾ä¸­...' : 
                                 connStatus === 'waiting' ? 'ç­‰å¾…ç‰µæ‰‹' : 'ç¦»çº¿'}
                            </span>
                        </div>
                        <div className="flex items-center gap-2">
                            {/* é‡è¿æŒ‰é’® */}
                            {(connStatus === 'disconnected' || connStatus === 'failed') && (
                                <button 
                                    onClick={handleReconnect}
                                    className="p-1.5 rounded-full bg-white/50 text-textLighter hover:text-primary transition-colors"
                                    title="é‡æ–°è¿æ¥"
                                >
                                    <Icons.Refresh className="w-4 h-4" />
                                </button>
                            )}
                            <button 
                                onClick={() => setShowSettings(true)} 
                                className="p-2 rounded-full text-textLight hover:bg-white/60 transition-colors"
                            >
                                <Icons.Setting className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {/* çºªå¿µæ—¥å¡ç‰‡ */}
                    <div className="px-6 pb-4 relative z-10">
                        <div className="glass rounded-3xl p-5 shadow-sm flex items-center justify-between">
                            <div>
                                <div className="flex items-baseline gap-1">
                                    <p className="text-xs text-textLight">ç›¸çˆ±</p>
                                    <span className="text-4xl font-extrabold text-text">{days}</span>
                                    <span className="text-lg text-textLight font-medium">å¤©</span>
                                </div>
                                {anniversary && <p className="text-xs text-textLight mt-1">å§‹äº {formatDateOnly(anniversary)}</p>}
                            </div>
                            <div className={`w-14 h-14 rounded-full flex items-center justify-center transition-all duration-500 ${tab === 'home' ? 'bg-primary/20 text-primary heartbeat' : 'bg-gray-100 text-gray-300'}`}>
                                <Icons.Heart className="w-7 h-7" />
                            </div>
                        </div>
                    </div>

                    {/* å†…å®¹åŒº */}
                    <main className="flex-1 overflow-y-auto hide-scrollbar px-4 pb-28 relative z-0">
                        {tab === 'home' && (
                            <div className="space-y-3 pt-2">
                                {timelineData.map((item, i) => (
                                    <div key={i} className="animate-fade-in" style={{animationDelay: `${Math.min(i * 0.03, 0.3)}s`}}>
                                        {item.kind === 'msg' ? <MsgCard msg={item} /> : <TodoCardMini todo={item} />}
                                    </div>
                                ))}
                                {timelineData.length === 0 && (
                                    <div className="text-center mt-20">
                                        <div className="text-5xl mb-4">ğŸŒ±</div>
                                        <p className="text-textLight">å°çªè¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»ç§ä¸‹ç§å­å§</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {tab === 'msg' && (
                            <TreeHoleView 
                                messages={messages} 
                                onSend={(text) => sendData('msg', { id: generateId(), text: text, ts: Date.now() })} 
                                connStatus={connStatus}
                                toast={showToast}
                            />
                        )}

                        {tab === 'todo' && (
                            <TodoView 
                                todos={todos} 
                                onAdd={(text) => sendData('todo', { id: generateId(), text, done: false, ts: Date.now() })}
                                onToggle={(todo) => sendData('todo', { ...todo, done: !todo.done })}
                                onDelete={(id) => {
                                    setTodos(prev => {
                                        const filtered = prev.filter(t => t.id !== id);
                                        localforage.setItem('yike_todos', filtered);
                                        return filtered;
                                    });
                                }}
                            />
                        )}
                    </main>

                    {/* åº•éƒ¨å¯¼èˆªæ  */}
                    <nav className="absolute bottom-0 left-0 right-0 z-30 px-4 pb-4 pt-2">
                        <div className="glass rounded-2xl p-2 shadow-lg border border-white/60 flex justify-around items-center">
                            <NavBtn 
                                icon={<Icons.List className="w-6 h-6"/>} 
                                label="å¾…åŠ"
                                active={tab === 'todo'} 
                                onClick={() => setTab('todo')}
                                color={tab === 'todo' ? 'text-primary' : 'text-textLighter'}
                            />
                            <NavBtn 
                                icon={<Icons.Msg className="w-6 h-6"/>} 
                                label="æ ‘æ´"
                                active={tab === 'msg'} 
                                onClick={() => setTab('msg')}
                                color={tab === 'msg' ? 'text-primary' : 'text-textLighter'}
                            />
                            <NavBtn 
                                icon={<Icons.Home className="w-7 h-7"/>} 
                                label="æ—¶å…‰"
                                active={tab === 'home'} 
                                onClick={() => setTab('home')}
                                color={tab === 'home' ? 'text-primary' : 'text-textLighter'}
                                isCenter={true}
                            />
                        </div>
                    </nav>

                    {/* è®¾ç½®å¼¹çª— */}
                    {showSettings && (
                        <SettingsView 
                            anniversary={anniversary} 
                            onSave={(ts) => {
                                sendData('anniversary', ts);
                                setShowSettings(false);
                            }}
                            onClose={() => setShowSettings(false)}
                        />
                    )}

                    {/* Toast */}
                    {toast && (
                        <div className="fixed top-28 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-5 py-2.5 rounded-full shadow-lg text-sm font-bold text-text z-50 animate-fade-in">
                            {toast}
                        </div>
                    )}
                </div>
            );
        }

        // ================= ç™»å½•ç»„ä»¶ =================
        function LoginView({ myId, connStatus, onJoin, onRefresh }) {
            const [mode, setMode] = useState(null);
            const [inputCode, setInputCode] = useState('');
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(myId);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // æ˜¾ç¤ºç»“æœé¡µï¼ˆåˆ›å»ºåç­‰å¾…å¯¹æ–¹ï¼‰
            if (mode === 'create' && myId) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-homeBg p-6 relative">
                        <h1 className="text-5xl font-extrabold text-primary mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                        <p className="text-textLight mb-8 text-sm">æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                        
                        <div className="w-full bg-white rounded-3xl p-6 text-center shadow-sm border border-primary/10 mb-6">
                            <div className="text-xs text-textLight mb-3 uppercase tracking-wider">åˆ†äº«æš—å·ç»™ TA</div>
                            <div 
                                onClick={handleCopy}
                                className="group relative bg-yellowLight/50 p-4 rounded-xl cursor-pointer hover:bg-yellowLight transition-colors active:scale-95"
                            >
                                <p className="text-lg font-mono font-bold text-text break-all select-all">{myId}</p>
                                <div className="absolute top-2 right-2 text-textLighter">
                                    {copied ? (
                                        <span className="text-xs text-success">å·²å¤åˆ¶!</span>
                                    ) : (
                                        <Icons.Copy className="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    )}
                                </div>
                            </div>
                            <p className="text-xs text-textLighter mt-3">ç‚¹å‡»æš—å·å¤åˆ¶åå‘é€ç»™ TA</p>
                        </div>
                        
                        {/* çŠ¶æ€æ˜¾ç¤º */}
                        <div className="w-full mb-4">
                            {connStatus === 'waiting' ? (
                                <div className="flex items-center justify-center gap-2 text-sm text-textLight bg-white/60 px-4 py-3 rounded-full">
                                    <div className="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                                    <span>ç­‰å¾… TA è¾“å…¥æš—å·...</span>
                                </div>
                            ) : connStatus === 'connecting' ? (
                                <div className="flex items-center justify-center gap-2 text-sm text-textLight bg-white/60 px-4 py-3 rounded-full">
                                    <Icons.Refresh className="w-4 h-4 spin" />
                                    <span>æ­£åœ¨è¿æ¥...</span>
                                </div>
                            ) : (
                                <div className="flex items-center justify-center gap-2 text-sm text-textLight bg-white/60 px-4 py-3 rounded-full">
                                    <div className="w-2 h-2 rounded-full bg-gray-300"></div>
                                    <span>ç­‰å¾…ä¸­... <button onClick={onRefresh} className="text-primary underline">åˆ·æ–°</button></span>
                                </div>
                            )}
                        </div>
                        
                        <button onClick={() => setMode(null)} className="mt-4 text-sm text-textLighter hover:text-text transition-colors">è¿”å›</button>
                    </div>
                );
            }

            // åŠ å…¥é¡µ
            if (mode === 'join') {
                return (
                    <div className="h-full flex flex-col justify-center bg-treeholeBg p-6">
                        <h1 className="text-3xl font-bold text-text text-center mb-8">æ‰¾åˆ°å½¼æ­¤</h1>
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                            <div className="p-4 border-b border-gray-50">
                                <input 
                                    className="w-full text-center text-lg font-mono outline-none bg-transparent placeholder-textLighter"
                                    placeholder="ç²˜è´´ TA çš„æš—å·"
                                    value={inputCode}
                                    onChange={e => setInputCode(e.target.value)}
                                />
                            </div>
                        </div>
                        <button 
                            onClick={() => {
                                if (!inputCode.trim()) {
                                    alert('è¯·è¾“å…¥æš—å·');
                                    return;
                                }
                                onJoin(inputCode.trim());
                            }} 
                            className="mt-6 w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                        >
                            ç‰µæ‰‹ TA
                        </button>
                        <button onClick={() => setMode(null)} className="mt-4 text-center text-sm text-textLighter">è¿”å›</button>
                    </div>
                );
            }

            // é€‰æ‹©é¡µ
            return (
                <div className="h-full flex flex-col items-center justify-center bg-homeBg p-6">
                    <div className="mb-2 relative">
                        <div className="w-20 h-20 rounded-full bg-primary/20 flex items-center justify-center">
                            <Icons.Heart className="w-10 h-10 text-primary heartbeat" />
                        </div>
                    </div>
                    <h1 className="text-5xl font-extrabold text-primary mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                    <p className="text-textLight mb-12 text-sm">æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                    
                    <button 
                        onClick={() => {
                            const id = generateId();
                            localStorage.setItem('yike_myId', id);
                            setMode('create');
                        }} 
                        className="w-full py-4 bg-white text-text rounded-2xl font-bold shadow-sm mb-4 active:scale-95 transition-transform border border-gray-100"
                    >
                        åˆ›å»ºå°çª
                    </button>
                    <button 
                        onClick={() => setMode('join')} 
                        className="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                    >
                        è¾“å…¥æš—å·ç‰µæ‰‹
                    </button>
                </div>
            );
        }

        // ================= æ ‘æ´ç»„ä»¶ =================
        function TreeHoleView({ messages, onSend, connStatus, toast }) {
            const [text, setText] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [audioBlob, setAudioBlob] = useState(null);
            const mediaRecorderRef = useRef(null);
            const timerRef = useRef(null);

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    
                    const chunks = [];
                    
                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };
                    
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        setAudioBlob(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordingTime(0);
                    
                    timerRef.current = setInterval(() => {
                        setRecordingTime(prev => {
                            if (prev >= 30) {
                                stopRecording();
                                return 30;
                            }
                            return prev + 1;
                        });
                    }, 1000);
                    
                } catch (e) {
                    console.error('å½•éŸ³é”™è¯¯:', e);
                    toast('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™');
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                }
                if (timerRef.current) {
                    clearInterval(timerRef.current);
                }
                setIsRecording(false);
            };

            const playAudio = () => {
                if (audioBlob) {
                    const url = URL.createObjectURL(audioBlob);
                    const audio = new Audio(url);
                    audio.play();
                }
            };

            const clearAudio = () => {
                setAudioBlob(null);
                setRecordingTime(0);
            };

            const handleSend = () => {
                if (audioBlob) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        // å‘é€è¯­éŸ³
                        const msg = {
                            id: generateId(),
                            text: 'ğŸ¤ è¯­éŸ³æ¶ˆæ¯',
                            audio: base64Audio,
                            isAudio: true,
                            ts: Date.now()
                        };
                        
                        // æœ¬åœ°ä¹è§‚æ›´æ–°
                        messages.forEach((m, i) => {
                            if (m.id === msg.id) return;
                        });
                        
                        // é€šè¿‡å…¨å±€äº‹ä»¶å‘é€
                        window.dispatchEvent(new CustomEvent('yike-send-msg', { detail: msg }));
                        clearAudio();
                    };
                    reader.readAsDataURL(audioBlob);
                } else if (text.trim()) {
                    onSend(text);
                    setText('');
                }
            };

            // ç›‘å¬å…¨å±€å‘é€äº‹ä»¶
            useEffect(() => {
                const handler = (e) => {
                    // æœ¬åœ°æ·»åŠ æ¶ˆæ¯
                    setMessages(prev => {
                        const newMsgs = [...prev, { ...e.detail, self: true }];
                        localforage.setItem('yike_msgs', newMsgs);
                        return newMsgs;
                    });
                };
                window.addEventListener('yike-send-msg', handler);
                return () => window.removeEventListener('yike-send-msg', handler);
            }, []);

            return (
                <div className="flex flex-col h-full pb-24">
                    <div className="flex-1 overflow-y-auto hide-scrollbar space-y-3 pt-2">
                        {messages.map(m => (
                            <MsgCard key={m.id} msg={m} />
                        ))}
                        {messages.length === 0 && (
                            <div className="text-center mt-20">
                                <div className="text-5xl mb-4">ğŸ“®</div>
                                <p className="text-textLight text-sm">æ ‘æ´ç©ºç©ºè¡è¡...</p>
                            </div>
                        )}
                    </div>
                    
                    <div className="fixed bottom-24 left-6 right-6 z-20">
                        {/* å½•éŸ³çŠ¶æ€ */}
                        {isRecording && (
                            <div className="mb-2 flex items-center justify-center gap-2 animate-fade-in">
                                <div className="flex gap-1">
                                    <div className="w-2 h-8 rounded-full bg-danger recording-wave"></div>
                                    <div className="w-2 h-8 rounded-full bg-danger recording-wave" style={{animationDelay: '0.2s'}}></div>
                                    <div className="w-2 h-8 rounded-full bg-danger recording-wave" style={{animationDelay: '0.4s'}}></div>
                                </div>
                                <span className="text-danger font-medium ml-2">{recordingTime}s</span>
                                <button 
                                    onClick={stopRecording}
                                    className="ml-2 px-3 py-1 bg-danger text-white rounded-full text-xs"
                                >
                                    å®Œæˆ
                                </button>
                            </div>
                        )}

                        {/* å½•éŸ³é¢„è§ˆ */}
                        {audioBlob && !isRecording && (
                            <div className="mb-2 bg-white rounded-xl p-3 flex items-center gap-3 shadow-sm animate-fade-in">
                                <button 
                                    onClick={playAudio}
                                    className="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center flex-shrink-0"
                                >
                                    <Icons.Play className="w-4 h-4 ml-0.5" />
                                </button>
                                <div className="flex-1">
                                    <div className="text-xs text-textLight mb-1">å½•éŸ³é¢„è§ˆ</div>
                                    <div className="h-2 bg-yellowLight rounded-full overflow-hidden">
                                        <div className="w-1/3 h-full bg-primary animate-pulse"></div>
                                    </div>
                                </div>
                                <button 
                                    onClick={clearAudio}
                                    className="p-2 text-textLighter hover:text-danger"
                                >
                                    <Icons.Close className="w-4 h-4" />
                                </button>
                            </div>
                        )}

                        {/* è¾“å…¥æ¡† */}
                        <div className="glass rounded-full p-2 flex items-center shadow-md">
                            <button 
                                onClick={isRecording ? stopRecording : startRecording}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors flex-shrink-0 ${
                                    isRecording 
                                    ? 'bg-danger text-white animate-pulse' 
                                    : 'text-textLighter hover:bg-white'
                                }`}
                            >
                                {isRecording ? <Icons.MicOff className="w-5 h-5" /> : <Icons.Mic className="w-5 h-5" />}
                            </button>
                            
                            <input 
                                className="flex-1 bg-transparent px-4 py-2 outline-none text-sm"
                                placeholder={audioBlob ? 'ç‚¹å‡»å‘é€' : 'è¯´ç‚¹ä»€ä¹ˆ...'}
                                value={text}
                                onChange={e => setText(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                                disabled={!!audioBlob}
                            />
                            
                            <button 
                                onClick={handleSend}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all flex-shrink-0 ${
                                    text.trim() || audioBlob
                                    ? 'bg-primary text-white' 
                                    : 'bg-gray-100 text-gray-300'
                                }`}
                                disabled={!text.trim() && !audioBlob}
                            >
                                <Icons.Send className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ================= å¾…åŠç»„ä»¶ =================
        function TodoView({ todos, onAdd, onToggle, onDelete }) {
            const [text, setText] = useState('');
            const [showDeleteMode, setShowDeleteMode] = useState(false);
            
            const groupedTodos = useMemo(() => {
                const groups = {};
                todos.forEach(todo => {
                    const date = new Date(todo.ts).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(todo);
                });
                return groups;
            }, [todos]);

            const handleAdd = () => {
                if (!text.trim()) return;
                onAdd(text);
                setText('');
            };

            return (
                <div className="space-y-4 pb-28">
                    <div className="flex gap-2">
                        <input 
                            className="flex-1 bg-white p-3 rounded-xl outline-none text-sm shadow-sm placeholder-textLighter"
                            placeholder="æ·»åŠ å°äº‹..."
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleAdd()}
                        />
                        <button 
                            onClick={() => setShowDeleteMode(!showDeleteMode)}
                            className={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors ${
                                showDeleteMode ? 'bg-danger/20 text-danger' : 'bg-white text-textLighter'
                            }`}
                        >
                            <Icons.Trash className="w-5 h-5" />
                        </button>
                        <button 
                            onClick={handleAdd}
                            className="w-12 h-12 rounded-xl bg-primary text-white flex items-center justify-center active:scale-95"
                        >
                            <Icons.Plus className="w-5 h-5" />
                        </button>
                    </div>
                    
                    {Object.entries(groupedTodos).map(([date, items]) => (
                        <div key={date} className="space-y-2">
                            <div className="flex items-center gap-2 text-xs font-medium text-textLighter py-1">
                                <Icons.Clock className="w-3 h-3" />
                                {date}
                            </div>
                            {items.map(todo => (
                                <div key={todo.id} className={`flex items-center gap-3 bg-white/80 p-3 rounded-xl border border-white/50 transition-all ${showDeleteMode ? 'pr-2' : ''}`}>
                                    <button 
                                        onClick={() => onToggle(todo)}
                                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${
                                            todo.done ? 'bg-success border-success' : 'border-textLighter/30 hover:border-primary'
                                        }`}
                                    >
                                        {todo.done && <Icons.Check className="w-3 h-3 text-white" />}
                                    </button>
                                    <span className={`flex-1 text-sm ${todo.done ? 'line-through text-textLighter' : 'text-text'}`}>
                                        {todo.text}
                                    </span>
                                    {showDeleteMode && (
                                        <button onClick={() => onDelete(todo.id)} className="p-2 text-danger/70 hover:text-danger delete-btn">
                                            <Icons.Delete className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    ))}
                    
                    {todos.length === 0 && (
                        <div className="text-center mt-16">
                            <div className="text-5xl mb-4">âœ¨</div>
                            <p className="text-textLight text-sm">è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</p>
                        </div>
                    )}
                </div>
            );
        }

        // ================= é€šç”¨ç»„ä»¶ =================
        function NavBtn({ icon, label, active, onClick, color, isCenter }) {
            return (
                <button 
                    onClick={onClick} 
                    className={`flex flex-col items-center justify-center py-1 px-3 rounded-xl transition-all ${
                        active 
                        ? 'text-primary scale-105' 
                        : 'text-textLighter hover:text-text'
                    }`}
                >
                    <div className={isCenter ? 'mb-1' : ''}>
                        {icon}
                    </div>
                    <span className={`text-[10px] font-medium ${active ? 'text-primary' : ''}`}>
                        {label}
                    </span>
                </button>
            );
        }

        function MsgCard({ msg }) {
            return (
                <div className={`flex ${msg.self ? 'justify-end' : 'justify-start'}`}>
                    {msg.isAudio ? (
                        // è¯­éŸ³æ¶ˆæ¯
                        <div className={`max-w-[80%] p-3 rounded-2xl shadow-sm ${
                            msg.self ? 'bg-primary text-white' : 'bg-white text-text'
                        }`}>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => {
                                        if (msg.audio) {
                                            const audio = new Audio(msg.audio);
                                            audio.play();
                                        }
                                    }}
                                    className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                        msg.self ? 'bg-white/20' : 'bg-primary/20'
                                    }`}
                                >
                                    <Icons.Play className={`w-4 h-4 ${msg.self ? 'text-white' : 'text-primary'}`} />
                                </button>
                                <div>
                                    <div className="flex items-center gap-2">
                                        <Icons.FileAudio className={`w-4 h-4 ${msg.self ? 'text-white/70' : 'text-textLighter'}`} />
                                        <span className="text-sm">è¯­éŸ³æ¶ˆæ¯</span>
                                    </div>
                                    <div className={`text-[10px] mt-1 ${msg.self ? 'text-white/70' : 'text-textLighter'}`}>
                                        {formatTime(msg.ts)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        // æ–‡å­—æ¶ˆæ¯
                        <div className={`max-w-[82%] p-3.5 rounded-2xl shadow-sm text-sm leading-relaxed ${
                            msg.self 
                            ? 'bg-primary text-white rounded-br-sm' 
                            : 'bg-white text-text rounded-bl-sm'
                        }`}>
                            {msg.text}
                            <div className={`text-[10px] mt-1.5 ${msg.self ? 'text-white/70' : 'text-textLighter'}`}>
                                {formatTime(msg.ts)}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function TodoCardMini({ todo }) {
            return (
                <div className={`flex items-center gap-2 p-2.5 rounded-lg text-xs ${
                    todo.done 
                    ? 'bg-white/30 line-through text-textLighter' 
                    : 'bg-yellowLight/60 text-text'
                }`}>
                    <div className={`w-1.5 h-1.5 rounded-full ${todo.done ? 'bg-textLighter' : 'bg-primary'}`}></div>
                    <span className="flex-1 truncate">{todo.text}</span>
                    <span className="text-[10px] opacity-60">
                        {new Date(todo.ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}
                    </span>
                </div>
            );
        }

        // ================= è®¾ç½®ç»„ä»¶ =================
        function SettingsView({ anniversary, onSave, onClose }) {
            const [date, setDate] = useState(anniversary ? formatDateOnly(anniversary) : '');

            return (
                <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
                    <div className="bg-bg w-full max-w-[420px] sm:rounded-t-3xl sm:rounded-b-3xl p-6 animate-fade-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-text">å°çªè®¾ç½®</h2>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white text-textLighter flex items-center justify-center hover:bg-gray-100">
                                <Icons.Close className="w-4 h-4" />
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            <div className="space-y-2">
                                <label className="flex items-center gap-2 text-sm font-bold text-text">
                                    <Icons.Calendar className="w-4 h-4 text-primary" />
                                    çºªå¿µæ—¥
                                </label>
                                <input 
                                    type="date" 
                                    className="w-full p-4 rounded-xl bg-white border border-gray-100 outline-none text-text shadow-sm"
                                    value={date}
                                    onChange={e => setDate(e.target.value)}
                                />
                                <p className="text-xs text-textLighter">è®¾ç½®æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©</p>
                            </div>
                            
                            <button 
                                onClick={() => onSave(date ? new Date(date).getTime() : Date.now())}
                                className="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform"
                            >
                                ä¿å­˜è®¾ç½®
                            </button>
                            
                            <div className="pt-4 border-t border-gray-100">
                                <button 
                                    onClick={() => {
                                        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                                            localforage.clear().then(() => {
                                                localStorage.clear();
                                                window.location.reload();
                                            });
                                        }
                                    }} 
                                    className="w-full py-3 text-sm text-danger hover:bg-danger/5 rounded-xl transition-colors"
                                >
                                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // æ¸²æŸ“
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
