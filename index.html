<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šå¯ - æˆ‘ä»¬çš„æ•°å­—å°çª</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FDFBF7',
                        theme: '#E8CFC8',
                        aux: '#D4E4E6',
                        text: '#4A403A',
                        subText: '#9CA3AF',
                        pink: '#FFB7B2'
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['ZCOOL KuaiLe', 'cursive'],
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/framer-motion@10.18.0/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

    <style>
        * { touch-action: manipulation; }
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-jelly { transition: transform 0.2s; }
        .btn-jelly:active { transform: scale(0.95); }
        body { height: 100vh; height: 100dvh; }
        .animate-blob { will-change: transform; }
    </style>
</head>
<body class="bg-bg text-text antialiased flex justify-center items-center select-none overflow-hidden">
    <div id="root" class="w-full h-full max-w-[400px] mx-auto relative overflow-hidden shadow-2xl bg-bg"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // ç”Ÿæˆ6ä½æš—å·
        const generateCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        const formatTime = (date) => {
            return new Date(date).toLocaleString('zh-CN', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        };

        // èƒŒæ™¯ç»„ä»¶
        const Background = () => (
            <div className="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
                <div className="absolute top-0 left-0 w-64 h-64 bg-theme rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob"></div>
                <div className="absolute top-0 right-0 w-64 h-64 bg-aux rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob" style={{ animationDelay: '2s' }}></div>
                <div className="absolute -bottom-32 left-20 w-64 h-64 bg-pink rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-blob" style={{ animationDelay: '4s' }}></div>
            </div>
        );

        // Toastæç¤º
        const Toast = ({ show, text }) => (
            <AnimatePresence>
                {show && (
                    <motion.div 
                        initial={{ y: -50, opacity: 0 }}
                        animate={{ y: 20, opacity: 1 }}
                        exit={{ y: -50, opacity: 0 }}
                        className="absolute top-0 left-0 right-0 z-50 flex justify-center px-4 pointer-events-none mt-8"
                    >
                        <div className="bg-white/80 backdrop-blur-md shadow-lg px-5 py-2.5 rounded-full text-xs font-bold text-text border border-white/50 max-w-[80%]">
                            {text}
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        );

        // åŠ è½½é¡µé¢
        const LoadingView = ({ status, onReset }) => {
            let content = {
                'INIT': { icon: 'ğŸ ', text: 'æ­£åœ¨æ‰“å¼€å°çª...', sub: '' },
                'RECONNECT': { icon: 'ğŸ§µ', text: 'æ­£åœ¨ç‰µèµ·æ–­æ‰çš„çº¢çº¿...', sub: 'å¦‚æœTAä¸åœ¨çº¿ï¼Œæˆ‘ä»¬ä¼šä¸€ç›´ç­‰' },
                'WAITING_HOST': { icon: 'â³', text: 'ç­‰å¾… TA å›åº”...', sub: 'è¯·æŠŠæš—å·å‘Šè¯‰ TA' },
                'CONNECTING': { icon: 'ğŸšª', text: 'æ­£åœ¨æ•²é—¨...', sub: 'è½»è½»æ•²ä¸€ä¸‹' },
                'ERROR': { icon: 'ğŸ’”', text: 'è¿æ¥å¥½åƒå¤±è´¥äº†', sub: 'è¯·æ£€æŸ¥ç½‘ç»œï¼Œæˆ–é‡è¯•' }
            }[status];

            return (
                <div className="flex flex-col items-center justify-center h-full p-8 text-center space-y-6">
                    <div className="text-6xl mb-6 animate-bounce">{content.icon}</div>
                    <h2 className="font-display text-2xl mb-2">{content.text}</h2>
                    <p className="text-sm text-subText text-center px-8">{content.sub}</p>
                    {status === 'ERROR' && (
                        <button onClick={onReset} className="px-6 py-2 bg-theme rounded-full text-white font-bold shadow-md btn-jelly">
                            é‡æ–°å°è¯•
                        </button>
                    )}
                </div>
            );
        };

        // å¼•å¯¼é¡µ
        const Onboarding = ({ onJoin }) => {
            const [mode, setMode] = useState('choice');
            const [inputCode, setInputCode] = useState('');
            const [myCode, setMyCode] = useState('');

            const createNest = () => {
                const code = generateCode();
                setMyCode(code);
                setMode('created');
                localStorage.setItem('yike_my_id', code);
                onJoin(code, 'HOST'); 
            };

            const handleJoin = () => {
                if(inputCode.length < 4) return;
                localStorage.setItem('yike_my_id', 'Guest-' + inputCode); 
                onJoin(inputCode, 'GUEST');
            };

            return (
                <div className="h-full flex flex-col pt-16 px-8 pb-8 justify-center">
                    {mode === 'choice' && (
                        <div className="space-y-6">
                            <div className="text-center mb-10">
                                <h1 className="font-display text-4xl text-theme mb-2">ä¼Šå¯</h1>
                                <p className="text-sm text-subText">æ¬¢è¿æ¥åˆ°åªå±äºæˆ‘ä»¬çš„ç§˜å¯†åŸºåœ°</p>
                            </div>
                            <button 
                                onClick={createNest}
                                className="w-full p-6 glass rounded-3xl text-left hover:bg-white/80 transition-all active:scale-[0.98]"
                            >
                                <div className="text-3xl mb-2">âœ¨</div>
                                <div className="font-bold text-text">åˆ›å»ºæ–°çš„å°çª</div>
                                <div className="text-xs text-subText mt-1">ç”Ÿæˆä¸“å±æš—å·ï¼Œè®© TA æ¥æ‰¾ä½ </div>
                            </button>
                            <button 
                                onClick={() => setMode('join')}
                                className="w-full p-6 glass rounded-3xl text-left hover:bg-white/80 transition-all active:scale-[0.98]"
                            >
                                <div className="text-3xl mb-2">ğŸšª</div>
                                <div className="font-bold text-text">å»æ•²é—¨ (åŠ å…¥)</div>
                                <div className="text-xs text-subText mt-1">è¾“å…¥ TA ç»™ä½ çš„æš—å·</div>
                            </button>
                        </div>
                    )}

                    {mode === 'create' && (
                        <div className="text-center space-y-8">
                            <h2 className="font-display text-2xl">å°çªå·²åˆ›å»º!</h2>
                            <p className="text-sm text-subText">è¯·æŠŠä¸‹æ–¹æš—å·å‘Šè¯‰ TA</p>
                            <div className="text-5xl font-display tracking-widest text-theme border-b-2 border-theme pb-2 select-all">
                                {myCode}
                            </div>
                            <p className="text-xs text-subText mt-8">æ­£åœ¨ç­‰å¾… TA è¿æ¥...</p>
                            <button onClick={() => setMode('choice')} className="text-xs text-subText underline">
                                é‡æ–°é€‰æ‹©
                            </button>
                        </div>
                    )}

                    {mode === 'join' && (
                        <div className="space-y-6">
                            <h2 className="font-display text-2xl text-center">å»æ•²é—¨</h2>
                            <div className="space-y-2">
                                <input 
                                    type="text" 
                                    placeholder="è¾“å…¥ TA çš„æš—å·" 
                                    maxLength={6}
                                    className="w-full text-center text-3xl font-display tracking-widest bg-transparent border-b-2 border-gray-300 focus:border-theme outline-none py-2 uppercase placeholder-gray-300"
                                    value={inputCode}
                                    onChange={(e) => setInputCode(e.target.value.toUpperCase())}
                                />
                            </div>
                            <button 
                                onClick={handleJoin}
                                disabled={inputCode.length < 4}
                                className={`w-full py-4 rounded-2xl font-bold text-white shadow-lg transition-all btn-jelly
                                    ${inputCode.length < 4 ? 'bg-gray-300' : 'bg-theme'}
                                `}
                            >
                                æ•²é—¨ ğŸšª
                            </button>
                            <button onClick={() => setMode('choice')} className="w-full py-2 text-sm text-subText">
                                è¿”å›
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // å¾…åŠé¡¹
        const TodoItem = ({ todo, onToggle }) => (
            <div className="glass p-3 rounded-2xl flex items-center gap-3">
                <button 
                    onClick={() => onToggle(todo.id)}
                    className={`w-5 h-5 rounded-full flex items-center justify-center border ${todo.completed ? 'bg-theme border-theme' : 'border-gray-300'}`}
                >
                    {todo.completed && <span className="text-white text-[8px]">âœ“</span>}
                </button>
                <p className={`text-sm flex-1 ${todo.completed ? 'line-through text-subText' : ''}`}>{todo.text}</p>
            </div>
        );

        // æ ‘æ´æ¶ˆæ¯å¡ç‰‡
        const MessageCard = ({ msg, onReact, partnerName }) => {
            const [reacted, setReacted] = useState(false);

            const handleReaction = () => {
                if (reacted) return;
                setReacted(true);
                onReact(msg.id);
            };

            return (
                <div className="glass p-4 rounded-3xl relative">
                    <div className="flex justify-between items-baseline mb-2">
                        <span className="font-bold text-sm text-text/80">{partnerName}</span>
                        <span className="text-[10px] text-subText">{formatTime(msg.timestamp)}</span>
                    </div>
                    <p className="text-sm leading-relaxed text-text/90">{msg.text}</p>
                    
                    <div className="mt-3 flex justify-end">
                        <button 
                            onClick={handleReaction}
                            className={`flex items-center gap-1 text-xs px-3 py-1 rounded-full border transition-all duration-300
                                ${reacted ? 'bg-pink border-pink text-white' : 'bg-white/50 border-gray-200 text-gray-400'}
                            `}
                        >
                            â¤ï¸ {msg.reactions || 0}
                        </button>
                    </div>
                </div>
            );
        };

        // æ ‘æ´ç»„ä»¶
        const TreeHole = ({ messages, onSend, onReact }) => {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = () => {
                if(!input.trim()) return;
                onSend({ 
                    id: generateCode() + Date.now(), 
                    text: input, 
                    timestamp: Date.now(), 
                    reactions: 0 
                });
                setInput('');
            };

            return (
                <div className="h-full flex flex-col relative">
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-28 px-1 space-y-4 pt-2" ref={scrollRef}>
                        {messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center mt-20 opacity-50">
                                <div className="text-5xl mb-4">ğŸ“®</div>
                                <p className="text-sm text-subText text-center">è¿™é‡Œæ˜¯é€šå¾€å½¼æ­¤å†…å¿ƒçš„ä¿¡ç®±<br/>ç¬¬ä¸€å°ä¿¡ï¼Œç­‰ä½ è½ç¬” âœ’ï¸</p>
                            </div>
                        ) : (
                            messages.sort((a,b) => b.timestamp - a.timestamp).map(msg => (
                                <MessageCard key={msg.id} msg={msg} onReact={onReact} partnerName="ç¥ç§˜äºº" />
                            ))
                        )}
                    </div>
                    
                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-6">
                        <div className="glass p-1.5 rounded-2xl shadow-sm flex items-end gap-2">
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="say something..."
                                className="flex-1 bg-transparent outline-none text-sm px-3 py-2 resize-none h-10 max-h-24"
                                rows={1}
                                onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }}}
                            />
                            <button 
                                onClick={handleSend}
                                className="bg-text text-white w-8 h-8 rounded-xl mb-1 mr-1 flex items-center justify-center btn-jelly shadow-md"
                            >
                                â¤ï¸
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å¾…åŠæ¸…å•ç»„ä»¶
        const SharedTodo = ({ todos, onAdd, onToggle }) => {
            const [input, setInput] = useState('');
            const activeTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);

            const handleAdd = () => {
                if(!input.trim()) return;
                const newTodo = { id: generateCode(), text: input, completed: false, timestamp: Date.now() };
                onAdd(newTodo);
                setInput('');
            };

            return (
                <div className="h-full flex flex-col overflow-hidden">
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-28 space-y-3 px-1 pt-2">
                        <h2 className="font-display text-xl mb-2 px-1">å¾…åŠæ¸…å• ğŸ“</h2>
                        
                        {activeTodos.length === 0 && completedTodos.length === 0 && (
                            <div className="text-center mt-10 opacity-50 text-sm text-subText">
                                <div className="text-3xl mb-2">ğŸŒ±</div>
                                è¿˜æ²¡æœ‰ç§ä¸‹ä»»ä½•å°ç›®æ ‡
                            </div>
                        )}

                        {activeTodos.map(todo => (
                            <TodoItem key={todo.id} todo={todo} onToggle={onToggle} />
                        ))}
                        
                        {completedTodos.length > 0 && (
                            <div className="pt-6 pb-2 opacity-60">
                                <h3 className="text-xs font-bold mb-3 tracking-wider text-subText px-1">âœ¨ å®Œæˆçš„å°äº‹</h3>
                                <div className="space-y-3">
                                    {completedTodos.map(todo => (
                                        <TodoItem key={todo.id} todo={todo} onToggle={onToggle} />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-6">
                        <div className="flex gap-2">
                            <input 
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="è®°ä¸€ä¸‹..."
                                className="flex-1 glass rounded-xl px-3 py-2 outline-none text-sm"
                                onKeyDown={(e) => { if(e.key === 'Enter') { e.preventDefault(); handleAdd(); }}}
                            />
                            <button 
                                onClick={handleAdd}
                                className="bg-theme text-white rounded-xl px-4 py-2 font-bold btn-jelly shadow-md"
                            >
                                +
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ä¸»åº”ç”¨
        const App = () => {
            const [status, setStatus] = useState('INIT'); 
            const [view, setView] = useState('onboarding');
            const [peer, setPeer] = useState(null);
            const [conn, setConn] = useState(null);
            const [partnerId, setPartnerId] = useState('');
            const [retryCount, setRetryCount] = useState(0);
            
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            const [toast, setToast] = useState({ show: false, text: '' });
            
            const showToast = (text) => {
                setToast({ show: true, text });
                setTimeout(() => setToast({ show: false, text: '' }), 2000);
            };

            // åˆå§‹åŒ–åŠ è½½
            useEffect(() => {
                const initApp = async () => {
                    try {
                        // åŠ è½½æœ¬åœ°æ•°æ®
                        const localMessages = await localforage.getItem('yike_messages') || [];
                        setMessages(localMessages);
                        const localTodos = await localforage.getItem('yike_todos') || [];
                        setTodos(localTodos);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„è¿æ¥
                        const savedPartner = localStorage.getItem('yike_partner_id');
                        const savedMyId = localStorage.getItem('yike_my_id');
                        
                        if(savedPartner && savedMyId) {
                            console.log('å‘ç°æ—§è¿æ¥ï¼Œå°è¯•é‡è¿...');
                            setStatus('RECONNECT');
                            initPeer(savedMyId, savedPartner);
                        }
                    } catch (err) {
                        console.error('åˆå§‹åŒ–å¤±è´¥:', err);
                    }
                };
                initApp();
            }, []);

            const initPeer = (newPeerId, targetId) => {
                if (conn) conn.close();
                if (peer) peer.destroy();
                
                const myId = newPeerId || localStorage.getItem('yike_my_id') || `Yike-${generateCode()}`;
                if(!newPeerId) localStorage.setItem('yike_my_id', myId);

                setStatus(targetId ? 'CONNECTING' : 'WAITING_HOST');
                setRetryCount(0);
                
                console.log('åˆå§‹åŒ–Peerï¼ŒID:', myId, 'ç›®æ ‡:', targetId);

                const newPeer = new Peer(myId, {
                    debug: 1
                });
                
                setPeer(newPeer);
                setPartnerId(targetId || '');

                // è¶…æ—¶ä¿æŠ¤
                const timeout = setTimeout(() => {
                    if (status !== 'CONNECTED') {
                        setStatus('ERROR');
                        showToast('â³ è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•');
                    }
                }, 15000);

                newPeer.on('open', (id) => {
                    console.log('Peerå·²è¿æ¥:', id);
                    clearTimeout(timeout);
                    if (targetId) {
                        const connection = newPeer.connect(targetId);
                        handleConnection(connection);
                    }
                });

                newPeer.on('connection', (connection) => {
                    console.log('æ”¶åˆ°å…¥ç«™è¿æ¥');
                    clearTimeout(timeout);
                    handleConnection(connection);
                });

                newPeer.on('error', (err) => {
                    console.error('Peeré”™è¯¯:', err);
                    clearTimeout(timeout);
                    setStatus('ERROR');
                    showToast(`âŒ ${err.type === 'peer-unavailable' ? 'æš—å·é”™è¯¯' : 'è¿æ¥å¤±è´¥'}`);
                });
            };

            const handleConnection = (connection) => {
                setConn(connection);
                setStatus('CONNECTED');
                setView('treehole');
                showToast('ğŸ‰ è¿æ¥æˆåŠŸ');
                localStorage.setItem('yike_partner_id', connection.peer);
                console.log('è¿æ¥æˆåŠŸ:', connection.peer);

                connection.on('open', () => {
                    console.log('æ•°æ®é€šé“æ‰“å¼€');
                    syncAll();
                });

                connection.on('data', (data) => {
                    if (data.type === 'PING') return;
                    handleDataSync(data);
                });

                connection.on('close', () => {
                    console.log('è¿æ¥å…³é—­');
                    setStatus('RECONNECT');
                    showToast("ğŸ’” è¿æ¥æ–­å¼€");
                    if (retryCount < 3) {
                        setTimeout(() => {
                            setRetryCount(prev => prev + 1);
                            initPeer(null, partnerId);
                        }, 5000);
                    } else {
                        setStatus('ERROR');
                        setRetryCount(0);
                    }
                });
            };

            const handleDataSync = (data) => {
                if (!data || !data.type) return;
                
                switch (data.type) {
                    case 'MSG_ADD':
                        setMessages(prev => {
                            if (prev.some(m => m.id === data.payload.id)) return prev;
                            const newMsgs = [...prev, data.payload];
                            localforage.setItem('yike_messages', newMsgs);
                            return newMsgs;
                        });
                        break;
                    case 'MSG_REACT':
                        setMessages(prev => prev.map(m => m.id === data.payload.id ? {...m, reactions: (m.reactions||0)+1} : m));
                        break;
                    case 'TODO_ADD':
                        setTodos(prev => {
                            if (prev.some(t => t.id === data.payload.id)) return prev;
                            const newTodos = [...prev, data.payload];
                            localforage.setItem('yike_todos', newTodos);
                            return newTodos;
                        });
                        break;
                    case 'TODO_TOGGLE':
                        setTodos(prev => prev.map(t => t.id === data.payload.id ? {...t, completed: !t.completed} : t));
                        break;
                    case 'SYNC':
                        setMessages(prev => [...prev, ...(data.payload.messages || [])].reduce((acc, cur) => (!acc.find(m => m.id === cur.id) && acc.push(cur), acc), []));
                        setTodos(prev => [...prev, ...(data.payload.todos || [])].reduce((acc, cur) => (!acc.find(t => t.id === cur.id) && acc.push(cur), acc), []));
                        break;
                }
            };

            const broadcast = (type, payload) => {
                if (conn && conn.open) {
                    try { conn.send({ type, payload }); } catch (e) {}
                }
            };

            const syncAll = () => broadcast('SYNC', { messages, todos });

            const handleReset = () => {
                setStatus('RECONNECT');
                initPeer(null, partnerId);
            };

            const handleJoin = (code) => {
                initPeer(localStorage.getItem('yike_my_id'), code);
            };

            const handleSendMessage = (msg) => {
                setMessages(prev => { const n = [...prev, msg]; localforage.setItem('yike_messages', n); return n; });
                broadcast('MSG_ADD', msg);
            };

            const handleMessageReaction = (msgId) => {
                setMessages(prev => prev.map(m => m.id === msgId ? {...m, reactions: (m.reactions||0)+1} : m));
                broadcast('MSG_REACT', { id: msgId });
            };

            const handleAddTodo = (todo) => {
                setTodos(prev => { const n = [...prev, todo]; localforage.setItem('yike_todos', n); return n; });
                broadcast('TODO_ADD', todo);
            };

            const handleToggleTodo = (todoId) => {
                setTodos(prev => prev.map(t => t.id === todoId ? {...t, completed: !t.completed} : t));
                broadcast('TODO_TOGGLE', { id: todoId });
            };
            
            const handleLeave = () => {
                if(confirm("ç¡®å®šç¦»å¼€ï¼Ÿ")) {
                    localStorage.clear();
                    if (conn) conn.close();
                    if (peer) peer.destroy();
                    setStatus('INIT');
                    setView('onboarding');
                }
            };

            return (
                <div className="h-full w-full relative">
                    <Background />
                    <Toast show={toast.show} text={toast.text} />
                    
                    {view === 'onboarding' && status !== 'CONNECTED' && (
                        <LoadingView status={status} onReset={handleReset} />
                    )}

                    {view === 'onboarding' && status === 'INIT' && (
                        <Onboarding onJoin={handleJoin} />
                    )}

                    {status === 'CONNECTED' && (
                        <div className="h-full w-full flex flex-col">
                            <div className="glass py-3 px-4 flex justify-between items-center shadow-sm z-10">
                                <button 
                                    onClick={() => setView(view === 'treehole' ? 'todo' : 'treehole')}
                                    className="btn-jelly bg-white/50 px-3 py-1 rounded-full text-sm font-bold"
                                >
                                    {view === 'treehole' ? 'ğŸ“ å¾…åŠ' : 'ğŸ’¬ æ ‘æ´'}
                                </button>
                                <button onClick={handleLeave} className="text-xs text-subText btn-jelly">
                                    ç¦»å¼€ âŒ
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-hidden">
                                {view === 'treehole' && <TreeHole messages={messages} onSend={handleSendMessage} onReact={handleMessageReaction} />}
                                {view === 'todo' && <SharedTodo todos={todos} onAdd={handleAddTodo} onToggle={handleToggleTodo} />}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
