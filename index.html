<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šå¯ Yike | æƒ…ä¾£å°çª</title>

    <!-- ä½¿ç”¨æœ€ç¨³å®šçš„ CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#FDFBF7',
                        primary: '#E8CFC8',
                        text: '#4A403A',
                        gray: '#9CA3AF'
                    }
                }
            }
        }
    </script>

    <!-- æ ¸å¿ƒä¾èµ– -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js" crossorigin="anonymous"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; }
        body {
            background: #E5E7EB;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        #app {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 850px;
            background: #FDFBF7;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.1);
        }
        @media (min-width: 421px) {
            #app { height: 100vh; border-radius: 0; }
        }
        .btn { transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .input-code { letter-spacing: 8px; font-size: 28px; font-weight: bold; font-family: monospace; }
        .heartbeat { animation: heartbeat 1.5s ease-in-out infinite; }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.15); }
            28% { transform: scale(1); }
            42% { transform: scale(1.15); }
            70% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ç”Ÿæˆ6ä½æ•°å­—æš—å·
        function generateCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // è®¡ç®—ç›¸çˆ±å¤©æ•°
        function getDays(ts) {
            if (!ts) return 0;
            const start = new Date(ts);
            const now = new Date();
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            return Math.floor((now - start) / (1000 * 60 * 60 * 24));
        }

        // å­˜å‚¨æ“ä½œ
        const Storage = {
            get: (key, def = []) => {
                try {
                    const v = localStorage.getItem(key);
                    return v ? JSON.parse(v) : def;
                } catch { return def; }
            },
            set: (key, val) => {
                try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
            }
        };

        // å›¾æ ‡
        const Icon = ({ type }) => {
            const icons = {
                heart: <svg className="w-6 h-6" viewBox="0 0 24 24" fill="#E8CFC8"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
                home: <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                msg: <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
                list: <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
                plus: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                send: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
                check: <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
                trash: <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                refresh: <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
                setting: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                calendar: <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                close: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            };
            return icons[type] || null;
        };

        // ä¸»åº”ç”¨
        function App() {
            const [view, setView] = useState('loading');
            const [tab, setTab] = useState('home');
            const [showSettings, setShowSettings] = useState(false);
            
            const [myId, setMyId] = useState('');
            const [myCode, setMyCode] = useState('');
            const [partnerId, setPartnerId] = useState('');
            const [anniversary, setAnniversary] = useState(null);
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            
            const [connStatus, setConnStatus] = useState('disconnected');
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const isMounted = useRef(true);
            const [toast, setToast] = useState('');

            // åˆå§‹åŒ–
            useEffect(() => {
                isMounted.current = true;
                
                const savedMyId = localStorage.getItem('yike_myId');
                const savedPartnerId = localStorage.getItem('yike_partnerId');
                const savedMyCode = localStorage.getItem('yike_myCode');
                const savedAnniversary = localStorage.getItem('yike_anniversary');
                const msgs = Storage.get('yike_msgs', []);
                const tds = Storage.get('yike_todos', []);
                
                if (savedAnniversary) setAnniversary(Number(savedAnniversary));
                if (msgs.length) setMessages(msgs);
                if (tds.length) setTodos(tds);

                let finalMyId = savedMyId;
                let finalMyCode = savedMyCode;
                
                if (!finalMyId) {
                    finalMyId = 'yike_' + Date.now();
                    finalMyCode = generateCode();
                    localStorage.setItem('yike_myId', finalMyId);
                    localStorage.setItem('yike_myCode', finalMyCode);
                }
                if (!finalMyCode) {
                    finalMyCode = generateCode();
                    localStorage.setItem('yike_myCode', finalMyCode);
                }
                
                setMyId(finalMyId);
                setMyCode(finalMyCode);

                if (savedPartnerId) {
                    setPartnerId(savedPartnerId);
                    setView('home');
                    setTimeout(() => initPeer(finalMyId, savedPartnerId), 800);
                } else {
                    setView('login');
                }

                return () => { isMounted.current = false; cleanup(); };
            }, []);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(''), 2500);
            };

            const cleanup = useCallback(() => {
                if (peerRef.current) {
                    try { peerRef.current.destroy(); } catch {}
                    peerRef.current = null;
                }
                if (connRef.current) {
                    try { connRef.current.close(); } catch {}
                    connRef.current = null;
                }
            }, []);

            const initPeer = useCallback((id, pid) => {
                if (!pid || !isMounted.current) return;
                
                cleanup();
                setConnStatus('connecting');
                console.log('Connecting:', id, pid);

                const timeout = setTimeout(() => {
                    if (!isMounted.current) return;
                    cleanup();
                    setConnStatus('disconnected');
                    showToast('è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•');
                }, 8000);

                try {
                    const peer = new Peer(id, {
                        debug: 0,
                        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
                    });
                    peerRef.current = peer;

                    peer.on('open', () => {
                        if (!isMounted.current) return;
                        setConnStatus('waiting');
                        
                        setTimeout(() => {
                            if (!isMounted.current || !peerRef.current) return;
                            const conn = peer.connect(pid, { reliable: true });
                            connRef.current = conn;
                            setupConnection(conn, timeout);
                        }, 1000);
                    });

                    peer.on('connection', (conn) => {
                        if (!isMounted.current) return;
                        clearTimeout(timeout);
                        connRef.current = conn;
                        setupConnection(conn);
                    });

                    peer.on('error', (err) => {
                        if (!isMounted.current) return;
                        clearTimeout(timeout);
                        cleanup();
                        setConnStatus('disconnected');
                        showToast('è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });

                } catch (e) {
                    if (!isMounted.current) return;
                    clearTimeout(timeout);
                    setConnStatus('disconnected');
                    showToast('åˆå§‹åŒ–å¤±è´¥');
                }
            }, [cleanup]);

            const setupConnection = useCallback((conn, timeout) => {
                conn.on('open', () => {
                    if (!isMounted.current) return;
                    if (timeout) clearTimeout(timeout);
                    setConnStatus('connected');
                    showToast('å·²è¿æ¥');
                });

                conn.on('data', (data) => {
                    if (!isMounted.current) return;
                    if (data.type === 'msg') {
                        setMessages(prev => {
                            const n = [...prev, data.msg];
                            Storage.set('yike_msgs', n);
                            return n;
                        });
                        showToast('æ”¶åˆ°æ–°æ¶ˆæ¯');
                    } else if (data.type === 'todo') {
                        setTodos(prev => {
                            const n = [...prev, data.todo];
                            Storage.set('yike_todos', n);
                            return n;
                        });
                        showToast('æ”¶åˆ°æ–°å¾…åŠ');
                    }
                });

                conn.on('close', () => {
                    if (!isMounted.current) return;
                    setConnStatus('disconnected');
                    setTimeout(() => {
                        if (partnerId && isMounted.current) {
                            initPeer(myId, partnerId);
                        }
                    }, 3000);
                });
            }, [myId, partnerId, initPeer]);

            const sendData = (type, data) => {
                if (type === 'msg') {
                    const msg = { ...data, self: true };
                    setMessages(prev => {
                        const n = [...prev, msg];
                        Storage.set('yike_msgs', n);
                        return n;
                    });
                } else if (type === 'todo') {
                    const todo = { ...data, self: true };
                    setTodos(prev => {
                        const n = [...prev, todo];
                        Storage.set('yike_todos', n);
                        return n;
                    });
                }
                if (connRef.current && connRef.current.open) {
                    connRef.current.send(type === 'msg' ? { type: 'msg', msg: data } : { type: 'todo', todo: data });
                }
            };

            const handlePair = (code) => {
                if (code.length !== 6) {
                    showToast('è¯·è¾“å…¥6ä½æ•°å­—');
                    return;
                }
                cleanup();
                const pid = 'yike_' + code;
                localStorage.setItem('yike_partnerId', pid);
                setPartnerId(pid);
                setView('home');
                setTimeout(() => initPeer(myId, pid), 500);
            };

            const handleCreate = () => {
                cleanup();
                const newCode = generateCode();
                const newId = 'yike_' + newCode;
                localStorage.setItem('yike_myId', newId);
                localStorage.setItem('yike_myCode', newCode);
                setMyId(newId);
                setMyCode(newCode);
                setView('create');
                setTimeout(() => initPeer(newId, null), 500);
            };

            const copyCode = (code) => {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('å·²å¤åˆ¶');
                }).catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = code;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showToast('å·²å¤åˆ¶');
                });
            };

            // åŠ è½½é¡µé¢
            if (view === 'loading') {
                return (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#FDFBF7' }}>
                        <div style={{ width: 50, height: 50, borderRadius: '50%', background: '#E8CFC8', animation: 'heartbeat 1.5s ease-in-out infinite' }}></div>
                        <p style={{ color: '#9CA3AF', marginTop: 20, fontSize: 14 }}>åŠ è½½ä¸­...</p>
                    </div>
                );
            }

            // ç™»å½•é¡µé¢
            if (view === 'login') {
                const [inputCode, setInputCode] = useState('');
                
                return (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 30, background: '#FDFBF7' }}>
                        <div style={{ width: 80, height: 80, borderRadius: '50%', background: '#E8CFC8', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: 30 }}>
                            <div style={{ width: 30, height: 30, background: '#fff', borderRadius: '50%' }}></div>
                        </div>
                        <h1 style={{ fontSize: 40, fontWeight: 'bold', color: '#D4A5A5', marginBottom: 10 }}>ä¼Šå¯</h1>
                        <p style={{ color: '#9CA3AF', marginBottom: 40, fontSize: 14 }}>æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                        
                        <div style={{ width: '100%', background: 'white', borderRadius: 20, padding: 25, marginBottom: 20, textAlign: 'center', boxShadow: '0 2px 10px rgba(0,0,0,0.05)' }}>
                            <p style={{ color: '#9CA3AF', fontSize: 12, marginBottom: 15 }}>ä½ çš„ä¸“å±æš—å·</p>
                            <div onClick={() => copyCode(myCode)} style={{ background: '#FDFBF7', padding: 20, borderRadius: 12, border: '2px dashed #ddd', cursor: 'pointer' }}>
                                <p className="input-code" style={{ color: '#4A403A' }}>{myCode}</p>
                                <p style={{ color: '#9CA3AF', fontSize: 12, marginTop: 10 }}>ç‚¹å‡»å¤åˆ¶</p>
                            </div>
                        </div>
                        
                        <div style={{ width: '100%', background: 'white', borderRadius: 16, padding: 20, marginBottom: 15, boxShadow: '0 2px 10px rgba(0,0,0,0.05)' }}>
                            <p style={{ color: '#9CA3AF', fontSize: 12, marginBottom: 10 }}>è¾“å…¥TAçš„æš—å·</p>
                            <input 
                                className="input-code"
                                style={{ width: '100%', textAlign: 'center', background: 'transparent', outline: 'none', color: '#4A403A' }}
                                placeholder="000000"
                                value={inputCode}
                                maxLength={6}
                                onChange={e => setInputCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                            />
                        </div>
                        
                        <button 
                            onClick={() => handlePair(inputCode)}
                            disabled={inputCode.length !== 6}
                            style={{ width: '100%', padding: '16px', background: inputCode.length === 6 ? '#E8CFC8' : '#ccc', color: 'white', border: 'none', borderRadius: 16, fontSize: 16, fontWeight: 'bold', cursor: inputCode.length === 6 ? 'pointer' : 'not-allowed', marginBottom: 20 }}
                            className="btn"
                        >
                            ç‰µæ‰‹è¿›å…¥å°çª
                        </button>
                        
                        <div style={{ display: 'flex', alignItems: 'center', width: '100%', marginBottom: 20 }}>
                            <div style={{ flex: 1, height: 1, background: '#eee' }}></div>
                            <span style={{ color: '#9CA3AF', fontSize: 12, margin: '0 20px' }}>æˆ–</span>
                            <div style={{ flex: 1, height: 1, background: '#eee' }}></div>
                        </div>
                        
                        <button onClick={handleCreate} style={{ width: '100%', padding: '16px', background: 'white', color: '#4A403A', border: '1px solid #eee', borderRadius: 16, fontSize: 16, fontWeight: 'bold' }} className="btn">
                            åˆ›å»ºæ–°å°çª
                        </button>
                    </div>
                );
            }

            // åˆ›å»ºé¡µé¢
            if (view === 'create') {
                return (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 30, background: '#FDFBF7' }}>
                        <div style={{ width: 70, height: 70, borderRadius: '50%', background: '#E8CFC8', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: 30 }}>
                            <div style={{ width: 25, height: 25, background: '#fff', borderRadius: '50%' }}></div>
                        </div>
                        <h1 style={{ fontSize: 28, fontWeight: 'bold', color: '#4A403A', marginBottom: 10 }}>å°çªå·²åˆ›å»º</h1>
                        <p style={{ color: '#9CA3AF', marginBottom: 30, fontSize: 14, textAlign: 'center', lineHeight: 1.8 }}>æŠŠæš—å·å‘ç»™TAï¼Œ<br/>ç­‰å¾…TAè¾“å…¥åä¸€èµ·è¿›å…¥å°çª</p>
                        
                        <div style={{ width: '100%', background: 'white', borderRadius: 20, padding: 25, marginBottom: 20, textAlign: 'center', boxShadow: '0 2px 10px rgba(0,0,0,0.05)' }}>
                            <p style={{ color: '#E8CFC8', fontSize: 12, marginBottom: 15, fontWeight: 'bold' }}>åˆ†äº«ç»™TA</p>
                            <div onClick={() => copyCode(myCode)} style={{ background: '#FDFBF7', padding: 25, borderRadius: 12, border: '2px dashed #E8CFC8', cursor: 'pointer' }}>
                                <p className="input-code" style={{ color: '#4A403A' }}>{myCode}</p>
                                <p style={{ color: '#9CA3AF', fontSize: 12, marginTop: 10 }}>ç‚¹å‡»å¤åˆ¶</p>
                            </div>
                        </div>
                        
                        <div style={{ width: '100%' }}>
                            {connStatus === 'waiting' && (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10, padding: 15, background: 'rgba(255,255,255,0.6)', borderRadius: 30 }}>
                                    <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#FBBF24', animation: 'heartbeat 1s infinite' }}></div>
                                    <span style={{ color: '#6B7280', fontSize: 14 }}>ç­‰å¾…TAè¾“å…¥æš—å·...</span>
                                </div>
                            )}
                            {connStatus === 'connected' && (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10, padding: 15, background: '#ECFDF5', borderRadius: 30 }}>
                                    <Icon type="check" />
                                    <span style={{ color: '#10B981', fontSize: 14 }}>è¿æ¥æˆåŠŸï¼</span>
                                </div>
                            )}
                            {connStatus === 'disconnected' && (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10, padding: 15, background: 'rgba(255,255,255,0.6)', borderRadius: 30 }}>
                                    <span style={{ color: '#9CA3AF', fontSize: 14 }}>ç­‰å¾…ä¸­...</span>
                                </div>
                            )}
                        </div>
                        
                        <button onClick={() => { cleanup(); setView('login'); }} style={{ marginTop: 30, color: '#9CA3AF', fontSize: 14, background: 'transparent', border: 'none' }} className="btn">
                            è¿”å›é‡æ–°åˆ›å»º
                        </button>
                    </div>
                );
            }

            // ä¸»é¡µ
            const days = getDays(anniversary);
            const timeline = [...messages.map(m => ({...m, type: 'msg'})), ...todos.map(t => ({...t, type: 'todo'}))].sort((a, b) => b.ts - a.ts);

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', background: '#FDFBF7' }}>
                    {/* é¡¶éƒ¨ */}
                    <header style={{ padding: '40px 20px 15px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <div style={{ 
                                width: 10, height: 10, borderRadius: '50%', 
                                background: connStatus === 'connected' ? '#10B981' : connStatus === 'connecting' ? '#FBBF24' : '#9CA3AF',
                                animation: connStatus === 'connected' ? 'heartbeat 2s infinite' : 'none'
                            }}></div>
                            <span style={{ fontSize: 12, color: '#6B7280' }}>
                                {connStatus === 'connected' ? 'TA åœ¨çº¿' : connStatus === 'connecting' ? 'è¿æ¥ä¸­...' : connStatus === 'waiting' ? 'ç­‰å¾…å¯¹æ–¹...' : 'ç¦»çº¿'}
                            </span>
                        </div>
                        <div style={{ display: 'flex', gap: 10 }}>
                            {connStatus !== 'connected' && (
                                <button onClick={() => partnerId && initPeer(myId, partnerId)} style={{ width: 32, height: 32, borderRadius: '50%', background: 'rgba(255,255,255,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', border: 'none' }} className="btn">
                                    <Icon type="refresh" />
                                </button>
                            )}
                            <button onClick={() => setShowSettings(true)} style={{ width: 32, height: 32, borderRadius: '50%', background: 'rgba(255,255,255,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', border: 'none' }} className="btn">
                                <Icon type="setting" />
                            </button>
                        </div>
                    </header>

                    {/* çºªå¿µæ—¥å¡ç‰‡ */}
                    <div style={{ padding: '0 20px 20px' }}>
                        <div style={{ background: 'rgba(255,255,255,0.7)', backdropFilter: 'blur(12px)', borderRadius: 24, padding: 20, display: 'flex', justifyContent: 'space-between', alignItems: 'center', boxShadow: '0 2px 10px rgba(0,0,0,0.03)' }}>
                            <div>
                                <div style={{ display: 'flex', alignItems: 'baseline', gap: 5 }}>
                                    <span style={{ fontSize: 12, color: '#6B7280' }}>ç›¸çˆ±</span>
                                    <span style={{ fontSize: 36, fontWeight: 'bold', color: '#4A403A' }}>{days}</span>
                                    <span style={{ fontSize: 18, color: '#6B7280' }}>å¤©</span>
                                </div>
                                <p style={{ fontSize: 12, color: '#9CA3AF', marginTop: 5 }}>
                                    {anniversary ? 'å§‹äº ' + new Date(anniversary).toLocaleDateString('zh-CN') : 'è®¾ç½®çºªå¿µæ—¥å¼€å§‹è®¡æ—¶'}
                                </p>
                            </div>
                            <div style={{ width: 56, height: 56, borderRadius: '50%', background: '#E8CFC8', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <Icon type="heart" />
                            </div>
                        </div>
                    </div>

                    {/* å†…å®¹åŒº */}
                    <main style={{ flex: 1, overflowY: 'auto', padding: '0 15px 120px' }}>
                        {tab === 'home' && (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                                {timeline.length === 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '60px 0' }}>
                                        <div style={{ fontSize: 48, marginBottom: 20 }}>ğŸŒ±</div>
                                        <p style={{ color: '#9CA3AF', textAlign: 'center', fontSize: 14, lineHeight: 1.8 }}>å°çªè¿˜æ˜¯ç©ºçš„ï¼Œ<br/>å¿«å»æ ‘æ´æˆ–å¾…åŠé‡Œç•™ä¸‹ç‚¹ä»€ä¹ˆå§</p>
                                        <div style={{ display: 'flex', gap: 15, marginTop: 25 }}>
                                            <button onClick={() => setTab('msg')} style={{ padding: '10px 20px', background: 'rgba(232,207,200,0.2)', color: '#D4A5A5', borderRadius: 20, fontSize: 14, border: 'none' }} className="btn">å»æ ‘æ´</button>
                                            <button onClick={() => setTab('todo')} style={{ padding: '10px 20px', background: 'rgba(212,228,230,0.2)', color: '#9CA3AF', borderRadius: 20, fontSize: 14, border: 'none' }} className="btn">å»å¾…åŠ</button>
                                        </div>
                                    </div>
                                ) : (
                                    timeline.map((item, i) => (
                                        <div key={i} style={{ 
                                            animation: 'fadeIn 0.3s ease-out', 
                                            animationDelay: `${Math.min(i * 0.05, 0.3)}s`,
                                            opacity: 0,
                                            animationFillMode: 'forwards'
                                        }}>
                                            {item.type === 'msg' ? (
                                                <div style={{ display: 'flex', justifyContent: item.self ? 'flex-end' : 'flex-start' }}>
                                                    <div style={{ 
                                                        maxWidth: '75%', padding: '12px 16px', borderRadius: 20, fontSize: 14,
                                                        background: item.self ? '#E8CFC8' : 'white',
                                                        color: item.self ? 'white' : '#4A403A',
                                                        borderBottomRightRadius: item.self ? 4 : 20,
                                                        borderBottomLeftRadius: item.self ? 20 : 4
                                                    }}>
                                                        {item.text}
                                                        <div style={{ fontSize: 10, marginTop: 5, opacity: 0.7 }}>{formatTime(item.ts)}</div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div style={{ 
                                                    display: 'flex', alignItems: 'center', gap: 10, padding: 10, borderRadius: 10,
                                                    background: item.done ? 'rgba(255,255,255,0.3)' : 'rgba(232,207,200,0.2)',
                                                    textDecoration: item.done ? 'line-through' : 'none',
                                                    color: item.done ? '#9CA3AF' : '#4A403A',
                                                    fontSize: 13
                                                }}>
                                                    <div style={{ width: 6, height: 6, borderRadius: '50%', background: item.done ? '#9CA3AF' : '#E8CFC8', flexShrink: 0 }}></div>
                                                    <span style={{ flex: 1 }}>{item.text}</span>
                                                    <span style={{ fontSize: 11, opacity: 0.6 }}>{new Date(item.ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}</span>
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {tab === 'msg' && <TreeHole messages={messages} onSend={(text) => sendData('msg', { id: Date.now(), text, ts: Date.now() })} toast={showToast} />}

                        {tab === 'todo' && <TodoList todos={todos} onAdd={(text) => sendData('todo', { id: Date.now(), text, done: false, ts: Date.now() })} />}
                    </main>

                    {/* åº•éƒ¨å¯¼èˆª */}
                    <nav style={{ position: 'fixed', bottom: 0, left: 0, right: 0, padding: '15px 20px 35px', background: '#FDFBF7' }}>
                        <div style={{ 
                            background: 'rgba(255,255,255,0.7)', backdropFilter: 'blur(12px)', 
                            borderRadius: 20, padding: '10px 20px', display: 'flex', justifyContent: 'space-around',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.05)'
                        }}>
                            <button onClick={() => setTab('todo')} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '8px 20px', background: 'transparent', border: 'none' }} className="btn">
                                <Icon type="list" />
                                <span style={{ fontSize: 10, marginTop: 4, color: tab === 'todo' ? '#E8CFC8' : '#9CA3AF' }}>å¾…åŠ</span>
                            </button>
                            <button onClick={() => setTab('msg')} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '8px 20px', background: 'transparent', border: 'none' }} className="btn">
                                <Icon type="msg" />
                                <span style={{ fontSize: 10, marginTop: 4, color: tab === 'msg' ? '#E8CFC8' : '#9CA3AF' }}>æ ‘æ´</span>
                            </button>
                            <button onClick={() => setTab('home')} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '8px 20px', background: 'transparent', border: 'none', marginTop: -25 }} className="btn">
                                <div style={{ 
                                    width: 50, height: 50, borderRadius: '50%', 
                                    background: tab === 'home' ? '#E8CFC8' : 'white',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    boxShadow: tab === 'home' ? '0 4px 15px rgba(232,207,200,0.4)' : '0 4px 15px rgba(0,0,0,0.1)'
                                }}>
                                    <Icon type="heart" />
                                </div>
                                <span style={{ fontSize: 10, marginTop: 4, color: tab === 'home' ? '#E8CFC8' : '#9CA3AF' }}>æ—¶å…‰</span>
                            </button>
                        </div>
                    </nav>

                    {/* è®¾ç½®å¼¹çª— */}
                    {showSettings && (
                        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.3)', backdropFilter: 'blur(4px)', zIndex: 100, display: 'flex', alignItems: 'flex-end', justifyContent: 'center' }}>
                            <div style={{ background: '#FDFBF7', width: '100%', maxWidth: 420, borderRadius: '24px 24px 0 0', padding: 25, animation: 'slideUp 0.3s ease-out' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 25 }}>
                                    <h2 style={{ fontSize: 20, fontWeight: 'bold', color: '#4A403A' }}>å°çªè®¾ç½®</h2>
                                    <button onClick={() => setShowSettings(false)} style={{ width: 32, height: 32, borderRadius: '50%', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', border: 'none' }} className="btn">
                                        <Icon type="close" />
                                    </button>
                                </div>
                                <div style={{ marginBottom: 25 }}>
                                    <label style={{ display: 'flex', alignItems: 'center', gap: 8, fontSize: 14, fontWeight: 'bold', color: '#4A403A', marginBottom: 10 }}>
                                        <Icon type="calendar" /> çºªå¿µæ—¥
                                    </label>
                                    <input type="date" id="date-input" style={{ width: '100%', padding: 15, borderRadius: 12, border: '1px solid #eee', background: 'white', fontSize: 14 }} />
                                </div>
                                <button onClick={() => {
                                    const d = document.getElementById('date-input').value;
                                    if (d) {
                                        const ts = new Date(d).getTime();
                                        localStorage.setItem('yike_anniversary', ts);
                                        setAnniversary(ts);
                                    }
                                    setShowSettings(false);
                                }} style={{ width: '100%', padding: 16, background: '#E8CFC8', color: 'white', border: 'none', borderRadius: 16, fontSize: 16, fontWeight: 'bold', marginBottom: 15 }} className="btn">
                                    ä¿å­˜è®¾ç½®
                                </button>
                                <button onClick={() => {
                                    if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                                        Object.keys(localStorage).filter(k => k.startsWith('yike_')).forEach(k => localStorage.removeItem(k));
                                        window.location.reload();
                                    }
                                }} style={{ width: '100%', padding: 12, background: 'transparent', color: '#EF4444', fontSize: 14, border: 'none' }} className="btn">
                                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Toast */}
                    {toast && (
                        <div style={{ 
                            position: 'fixed', top: 100, left: '50%', transform: 'translateX(-50%)',
                            background: 'rgba(0,0,0,0.8)', color: 'white', padding: '10px 25px', borderRadius: 25,
                            fontSize: 14, zIndex: 200, animation: 'fadeIn 0.2s ease-out'
                        }}>
                            {toast}
                        </div>
                    )}
                </div>
            );
        }

        // æ ‘æ´ç»„ä»¶
        function TreeHole({ messages, onSend, toast }) {
            const [text, setText] = useState('');
            const bottomRef = useRef(null);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleSend = () => {
                if (!text.trim()) return;
                onSend(text);
                setText('');
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: '100%', paddingBottom: 80 }}>
                    <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: 12 }}>
                        {messages.map(m => (
                            <div key={m.id} style={{ display: 'flex', justifyContent: m.self ? 'flex-end' : 'flex-start' }}>
                                <div style={{ 
                                    maxWidth: '75%', padding: '12px 16px', borderRadius: 20, fontSize: 14,
                                    background: m.self ? '#E8CFC8' : 'white',
                                    color: m.self ? 'white' : '#4A403A',
                                    borderBottomRightRadius: m.self ? 4 : 20,
                                    borderBottomLeftRadius: m.self ? 20 : 4
                                }}>
                                    {m.text}
                                    <div style={{ fontSize: 10, marginTop: 5, opacity: 0.7 }}>{formatTime(m.ts)}</div>
                                </div>
                            </div>
                        ))}
                        {messages.length === 0 && (
                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', marginTop: 60 }}>
                                <div style={{ fontSize: 40, marginBottom: 15 }}>ğŸ“®</div>
                                <p style={{ color: '#9CA3AF', fontSize: 14 }}>æ ‘æ´ç©ºç©ºè¡è¡...</p>
                            </div>
                        )}
                        <div ref={bottomRef} />
                    </div>
                    <div style={{ 
                        position: 'fixed', bottom: 100, left: 15, right: 15,
                        background: 'rgba(255,255,255,0.8)', backdropFilter: 'blur(8px)',
                        borderRadius: 30, padding: 8, display: 'flex', gap: 10,
                        boxShadow: '0 2px 15px rgba(0,0,0,0.05)'
                    }}>
                        <input 
                            style={{ flex: 1, padding: '12px 15px', background: 'transparent', border: 'none', outline: 'none', fontSize: 14 }}
                            placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleSend()}
                        />
                        <button 
                            onClick={handleSend}
                            disabled={!text.trim()}
                            style={{ 
                                width: 42, height: 42, borderRadius: '50%', 
                                background: text.trim() ? '#E8CFC8' : '#f3f4f6',
                                color: text.trim() ? 'white' : '#9CA3AF',
                                border: 'none', display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}
                            className="btn"
                        >
                            <Icon type="send" />
                        </button>
                    </div>
                </div>
            );
        }

        // å¾…åŠç»„ä»¶
        function TodoList({ todos, onAdd }) {
            const [text, setText] = useState('');
            const [showDelete, setShowDelete] = useState(false);
            const [localTodos, setLocalTodos] = useState(todos);

            useEffect(() => { setLocalTodos(todos); }, [todos]);

            const handleAdd = () => {
                if (!text.trim()) return;
                onAdd(text);
                setText('');
            };

            const toggleTodo = (todo) => {
                const newTodos = localTodos.map(t => t.id === todo.id ? { ...t, done: !t.done } : t);
                setLocalTodos(newTodos);
                localStorage.setItem('yike_todos', JSON.stringify(newTodos));
            };

            const deleteTodo = (id) => {
                const newTodos = localTodos.filter(t => t.id !== id);
                setLocalTodos(newTodos);
                localStorage.setItem('yike_todos', JSON.stringify(newTodos));
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 15 }}>
                    <div style={{ display: 'flex', gap: 10 }}>
                        <input 
                            style={{ flex: 1, padding: 14, borderRadius: 12, border: '1px solid #eee', background: 'white', outline: 'none', fontSize: 14 }}
                            placeholder="æ·»åŠ å°äº‹..."
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleAdd()}
                        />
                        <button onClick={handleAdd} style={{ width: 48, height: 48, borderRadius: 12, background: '#E8CFC8', color: 'white', border: 'none', display: 'flex', alignItems: 'center', justifyContent: 'center' }} className="btn">
                            <Icon type="plus" />
                        </button>
                        <button onClick={() => setShowDelete(!showDelete)} style={{ width: 48, height: 48, borderRadius: 12, background: showDelete ? '#FEE2E2' : 'white', color: showDelete ? '#EF4444' : '#9CA3AF', border: '1px solid #eee', display: 'flex', alignItems: 'center', justifyContent: 'center' }} className="btn">
                            <Icon type="trash" />
                        </button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                        {localTodos.map(todo => (
                            <div key={todo.id} style={{ 
                                display: 'flex', alignItems: 'center', gap: 12, padding: 14, borderRadius: 12,
                                background: showDelete ? '#FEE2E2' : 'rgba(255,255,255,0.8)'
                            }}>
                                <button 
                                    onClick={() => toggleTodo(todo)}
                                    style={{ 
                                        width: 24, height: 24, borderRadius: '50%', border: '2px solid', 
                                        borderColor: todo.done ? '#D4E4E6' : '#d1d5db',
                                        background: todo.done ? '#D4E4E6' : 'transparent',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0
                                    }}
                                    className="btn"
                                >
                                    {todo.done && <Icon type="check" />}
                                </button>
                                <span style={{ flex: 1, fontSize: 14, textDecoration: todo.done ? 'line-through' : 'none', color: todo.done ? '#9CA3AF' : '#4A403A' }}>
                                    {todo.text}
                                </span>
                                {showDelete && (
                                    <button onClick={() => deleteTodo(todo.id)} style={{ color: '#EF4444', background: 'transparent', border: 'none', padding: 5 }} className="btn">
                                        <Icon type="trash" />
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                    {localTodos.length === 0 && (
                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', marginTop: 40 }}>
                            <div style={{ fontSize: 40, marginBottom: 15 }}>âœ¨</div>
                            <p style={{ color: '#9CA3AF', fontSize: 14 }}>è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</p>
                        </div>
                    )}
                </div>
            );
        }

        // æ¸²æŸ“
        ReactDOM.createRoot(document.getElementById('app')).render(<App />);
    </script>
</body>
</html>
