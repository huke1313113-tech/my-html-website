<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¼Šå¯ Yike | æƒ…ä¾£å°çª</title>
    
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', '"PingFang SC"', 'sans-serif'] },
                    colors: {
                        bg: '#FDFBF7',
                        pink: '#E8CFC8',
                        pinkDark: '#D4B5AD',
                        blue: '#C5D6D8',
                        yellow: '#F0E6D2',
                        green: '#B8C9BC',
                        text: '#5C5552',
                        textLight: '#9E9591',
                    }
                }
            }
        }
    </script>
    
    <!-- æ ¸å¿ƒä¾èµ–åº“ -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.staticfile.net/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.staticfile.net/peerjs/1.5.2/peerjs.min.js"></script>

    <style>
        body { 
            background: #E5E7EB; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            min-height: 100vh;
        }
        #app { 
            width: 100%; 
            max-width: 420px; 
            height: 100dvh; 
            background: #FDFBF7; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.1);
        }
        .glass {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .anim-fade { animation: fadeIn 0.3s ease; }
        .anim-slide { animation: slideUp 0.4s ease; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .anim-pulse { animation: pulse-soft 2s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="app">
        <div id="root"></div>
    </div>

    <!-- ä¸šåŠ¡é€»è¾‘ -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // å·¥å…·å‡½æ•°
        const uid = () => Math.random().toString(36).substr(2, 9);
        const fmtDate = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        };
        
        // è®¡ç®—å¤©æ•°
        const getDays = (ts) => {
            if (!ts) return 0;
            const start = new Date(ts);
            const now = new Date();
            const diff = now - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        // å›¾æ ‡
        const Icon = {
            Heart: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            Home: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>,
            Msg: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            List: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Plus: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Send: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Check: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Setting: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        };

        // ================= ä¸»åº”ç”¨ =================
        function App() {
            // çŠ¶æ€
            const [view, setView] = useState('loading'); // loading, login, home
            const [tab, setTab] = useState('msg'); // msg, todo, home
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState(null);
            
            // æ•°æ®
            const [myId, setMyId] = useState('');
            const [partnerId, setPartnerId] = useState('');
            const [anniversary, setAnniversary] = useState(null);
            const [messages, setMessages] = useState([]);
            const [todos, setTodos] = useState([]);
            
            // è¿æ¥
            const [connStatus, setConnStatus] = useState('disconnected');
            const [conn, setConn] = useState(null);
            const peerRef = useRef(null);

            // 1. åˆå§‹åŒ–
            useEffect(() => {
                const init = async () => {
                    // è¯»å–æœ¬åœ°å­˜å‚¨
                    const savedMyId = localStorage.getItem('yike_myId');
                    const savedPartner = localStorage.getItem('yike_partnerId');
                    const savedAnniversary = localStorage.getItem('yike_anniversary');
                    
                    if (savedAnniversary) setAnniversary(Number(savedAnniversary));

                    // è¯»å– IndexedDB
                    const msgs = await localforage.getItem('yike_msgs') || [];
                    const todos = await localforage.getItem('yike_todos') || [];
                    setMessages(msgs);
                    setTodos(todos);

                    if (savedMyId && savedPartner) {
                        setMyId(savedMyId);
                        setPartnerId(savedPartner);
                        setView('home');
                        initPeer(savedMyId, savedPartner);
                    } else {
                        setView('login');
                    }
                };
                
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå°±ç»ª
                setTimeout(init, 500);
            }, []);

            // 2. PeerJS è¿æ¥é€»è¾‘
            const initPeer = (id, pid, mode = 'connect') => {
                if (peerRef.current) {
                    peerRef.current.destroy();
                }
                
                setConnStatus('connecting');
                console.log(`Init Peer: ${id} -> ${pid}, Mode: ${mode}`);

                const peer = new Peer(id);
                peerRef.current = peer;

                // è¶…æ—¶ä¿æŠ¤ (8ç§’)
                const timer = setTimeout(() => {
                    if (connStatus === 'connecting') {
                        setConnStatus('disconnected');
                        showToast('è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•');
                    }
                }, 8000);

                peer.on('open', (myId) => {
                    console.log('Peer Open:', myId);
                });

                peer.on('connection', (c) => {
                    // å¯¹æ–¹è¿æ¥æˆ‘
                    clearTimeout(timer);
                    setupConnection(c);
                });

                peer.on('error', (err) => {
                    console.error('Peer Error:', err);
                    clearTimeout(timer);
                    setConnStatus('disconnected');
                    
                    if (err.type === 'peer-unavailable') {
                        showToast('æš—å·æ— æ•ˆæˆ–å¯¹æ–¹å·²ç¦»çº¿');
                    } else if (err.type === 'unavailable-id') {
                        showToast('æš—å·å·²è¢«å ç”¨ï¼Œè¯·åˆ·æ–°é‡è¯•');
                    } else {
                        showToast('è¿æ¥é”™è¯¯: ' + err.type);
                    }
                });

                // æˆ‘è¿æ¥å¯¹æ–¹
                if (mode === 'connect' && pid) {
                    const c = peer.connect(pid);
                    setupConnection(c);
                }
            };

            const setupConnection = (c) => {
                c.on('open', () => {
                    setConnStatus('connected');
                    setConn(c);
                    clearTimeout(8000);
                    showToast('è¿æ¥æˆåŠŸ');
                });

                c.on('data', (data) => {
                    console.log('Received:', data);
                    if (data.type === 'msg') {
                        setMessages(prev => [...prev, data.payload]);
                    } else if (data.type === 'todo') {
                        setTodos(prev => [...prev, data.payload]);
                    } else if (data.type === 'anniversary') {
                        setAnniversary(data.payload);
                    }
                });

                c.on('close', () => {
                    setConnStatus('disconnected');
                    setConn(null);
                    showToast('è¿æ¥å·²æ–­å¼€');
                });
            };

            // 3. å‘é€æ•°æ®
            const send = (type, payload) => {
                // æœ¬åœ°ä¹è§‚æ›´æ–°
                if (type === 'msg') {
                    setMessages(prev => [...prev, { ...payload, self: true }]);
                    localforage.setItem('yike_msgs', [...messages, { ...payload, self: true }]);
                } else if (type === 'todo') {
                    setTodos(prev => [...prev, { ...payload, self: true }]);
                    localforage.setItem('yike_todos', [...todos, { ...payload, self: true }]);
                } else if (type === 'anniversary') {
                    setAnniversary(payload);
                    localStorage.setItem('yike_anniversary', payload);
                }

                // å‘é€ç»™å¯¹ç«¯
                if (conn && conn.open) {
                    conn.send({ type, payload });
                }
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 2500);
            };

            // ================= é¡µé¢æ¸²æŸ“ =================

            // åŠ è½½ä¸­
            if (view === 'loading') {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-bg">
                        <div className="w-12 h-12 rounded-full border-4 border-pink border-t-transparent animate-spin mb-4"></div>
                        <p className="text-textLight">æ­£åœ¨æ­å»ºå°çª...</p>
                    </div>
                );
            }

            // ç™»å½•é¡µ
            if (view === 'login') {
                return (
                    <LoginView 
                        onCreate={(id) => {
                            setMyId(id);
                            setPartnerId('');
                            localStorage.setItem('yike_myId', id);
                            localStorage.setItem('yike_partnerId', '');
                            setView('login');
                            initPeer(id, null, 'create');
                        }}
                        onJoin={(id, pid) => {
                            setMyId(id);
                            setPartnerId(pid);
                            localStorage.setItem('yike_myId', id);
                            localStorage.setItem('yike_partnerId', pid);
                            setView('home');
                            initPeer(id, pid, 'join');
                        }}
                        myId={myId}
                    />
                );
            }

            // é¦–é¡µ
            const days = getDays(anniversary);
            const allItems = [
                ...messages.map(m => ({ ...m, kind: 'msg' })),
                ...todos.map(t => ({ ...t, kind: 'todo' }))
            ].sort((a, b) => b.ts - a.ts);

            return (
                <div className="h-full flex flex-col bg-bg relative overflow-hidden">
                    {/* èƒŒæ™¯è£…é¥° */}
                    <div className="absolute inset-0 pointer-events-none overflow-hidden">
                        <div className="absolute top-[-20%] right-[-10%] w-[80%] h-[80%] rounded-full bg-pink/20 blur-[100px]"></div>
                        <div className="absolute bottom-[-20%] left-[-10%] w-[80%] h-[80%] rounded-full bg-blue/20 blur-[100px]"></div>
                    </div>

                    {/* é¡¶éƒ¨æ  */}
                    <header className="relative z-10 px-6 pt-6 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className={`w-2.5 h-2.5 rounded-full ${connStatus === 'connected' ? 'bg-green-400' : connStatus === 'connecting' ? 'bg-yellow-400 anim-pulse' : 'bg-gray-300'}`}></div>
                            <span className="text-xs text-textLight">{connStatus === 'connected' ? 'åœ¨çº¿' : 'è¿æ¥ä¸­'}</span>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-2 text-textLight hover:bg-white/50 rounded-full">
                            <Icon.Setting />
                        </button>
                    </header>

                    {/* çºªå¿µæ—¥å¡ç‰‡ */}
                    <div className="px-6 pt-2 pb-4 relative z-10">
                        <div className="glass rounded-3xl p-5 flex items-center justify-between shadow-sm">
                            <div>
                                <p className="text-xs text-textLight mb-1">æˆ‘ä»¬ç›¸çˆ±</p>
                                <div className="text-4xl font-bold text-text">
                                    {days} <span className="text-lg font-normal text-textLight">å¤©</span>
                                </div>
                            </div>
                            <div className="w-12 h-12 rounded-full bg-pink/20 flex items-center justify-center text-pink">
                                <Icon.Heart />
                            </div>
                        </div>
                    </div>

                    {/* å†…å®¹åŒº */}
                    <main className="flex-1 overflow-y-auto hide-scrollbar px-4 pb-28 relative z-0">
                        {/* ä¸»é¡µ Timeline */}
                        {tab === 'home' && (
                            <div className="space-y-3 pt-2">
                                {allItems.map((item, i) => (
                                    <div key={i} className={item.kind === 'msg' ? 'anim-slide' : 'anim-slide'}>
                                        {item.kind === 'msg' ? (
                                            <MsgCard msg={item} />
                                        ) : (
                                            <TodoCardMini todo={item} />
                                        )}
                                    </div>
                                ))}
                                {allItems.length === 0 && (
                                    <div className="text-center mt-16 text-textLight opacity-50">
                                        <div className="text-4xl mb-2">ğŸŒ±</div>
                                        <p className="text-sm">å°çªè¿˜æ˜¯ç©ºçš„</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* æ ‘æ´ Tab */}
                        {tab === 'msg' && <TreeHoleView messages={messages} onSend={(text) => {
                            send('msg', { id: uid(), text, ts: Date.now() });
                        }} />}

                        {/* å¾…åŠ Tab */}
                        {tab === 'todo' && <TodoView todos={todos} onAdd={(text) => {
                            send('todo', { id: uid(), text, done: false, ts: Date.now() });
                        }} />}
                    </main>

                    {/* åº•éƒ¨å¯¼èˆª */}
                    <nav className="absolute bottom-6 left-6 right-6 z-30">
                        <div className="glass rounded-full p-2 flex justify-between items-center shadow-lg">
                            <NavBtn icon={<Icon.List />} active={tab === 'todo'} onClick={() => setTab('todo')} />
                            <NavBtn icon={<Icon.Msg />} active={tab === 'msg'} onClick={() => setTab('msg')} />
                            
                            <button onClick={() => setTab('home')} className={`w-14 h-14 -mt-4 rounded-full flex items-center justify-center shadow-md transition-all ${tab === 'home' ? 'bg-pink text-white scale-110' : 'bg-white text-pink'}`}>
                                <Icon.Home />
                            </button>
                            
                            <div className="w-10"></div>
                            <div className="w-10"></div>
                        </div>
                    </nav>

                    {/* è®¾ç½®å¼¹çª— */}
                    {showSettings && (
                        <SettingsView 
                            anniversary={anniversary} 
                            onSave={(ts) => {
                                send('anniversary', ts);
                                setShowSettings(false);
                            }}
                            onClose={() => setShowSettings(false)}
                        />
                    )}

                    {/* Toast */}
                    {toast && (
                        <div className="fixed top-28 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-5 py-2 rounded-full shadow-lg text-sm font-bold text-text z-50 anim-slide">
                            {toast}
                        </div>
                    )}
                </div>
            );
        }

        // ================= ç™»å½•ç»„ä»¶ =================
        function LoginView({ onCreate, onJoin, myId }) {
            const [mode, setMode] = useState(null); // null, create, join
            const [inputCode, setInputCode] = useState('');

            if (mode === 'create' && myId) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-bg p-6 anim-fade">
                        <h1 className="text-5xl font-bold text-pink mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                        <p className="text-textLight mb-8 text-sm">æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                        
                        <div className="w-full bg-white rounded-2xl p-6 text-center shadow-sm">
                            <p className="text-xs text-textLight mb-3">åˆ†äº«è¿™ä¸ªæš—å·ç»™ TA</p>
                            <div onClick={() => {navigator.clipboard.writeText(myId); alert('æš—å·å·²å¤åˆ¶')}} className="text-xl font-mono font-bold text-pink break-all cursor-pointer p-3 bg-pink/10 rounded-xl mb-2">
                                {myId}
                            </div>
                            <p className="text-xs text-textLight">ç‚¹å‡»æš—å·å¤åˆ¶</p>
                        </div>
                        
                        <div className="mt-8 flex items-center gap-2 text-sm text-textLight">
                            <div className={`w-2 h-2 rounded-full ${myId ? 'bg-yellow-400 anim-pulse' : 'bg-gray-300'}`}></div>
                            {myId ? 'ç­‰å¾… TA è¾“å…¥æš—å·...' : 'ç”Ÿæˆä¸­...'}
                        </div>
                        
                        <button onClick={() => setMode(null)} className="mt-6 text-sm text-textLight underline">è¿”å›</button>
                    </div>
                );
            }

            if (mode === 'join') {
                return (
                    <div className="h-full flex flex-col justify-center bg-bg p-6 anim-slide">
                        <h1 className="text-3xl font-bold text-text mb-8 text-center">è¾“å…¥æš—å·</h1>
                        <div className="bg-white rounded-2xl p-4 shadow-sm mb-4">
                            <input 
                                className="w-full text-center text-lg font-mono outline-none" 
                                placeholder="ç²˜è´´å¯¹æ–¹å‘æ¥çš„æš—å·"
                                value={inputCode}
                                onChange={e => setInputCode(e.target.value)}
                            />
                        </div>
                        <button onClick={() => {
                            if (!inputCode) return alert('è¯·è¾“å…¥æš—å·');
                            const id = 'yike_' + uid();
                            onJoin(id, inputCode);
                        }} className="w-full py-4 bg-pink text-white rounded-2xl font-bold shadow-lg shadow-pink/30 active:scale-95 transition-transform">
                            ç‰µæ‰‹ TA
                        </button>
                        <button onClick={() => setMode(null)} className="mt-4 text-center text-sm text-textLight">è¿”å›</button>
                    </div>
                );
            }

            // åˆå§‹é€‰æ‹©é¡µ
            return (
                <div className="h-full flex flex-col items-center justify-center bg-bg p-6 anim-fade">
                    <h1 className="text-5xl font-bold text-pink mb-2" style={{fontFamily: 'Nunito'}}>Yike</h1>
                    <p className="text-textLight mb-12 text-sm">æƒ…ä¾£çš„æ•°å­—ç§˜å¯†å°çª</p>
                    
                    <button onClick={() => {
                        const id = 'yike_' + uid();
                        onCreate(id);
                    }} className="w-full py-4 bg-white text-text rounded-2xl font-bold shadow-sm mb-4 active:scale-95 transition-transform">
                        åˆ›å»ºå°çª
                    </button>
                    <button onClick={() => setMode('join')} className="w-full py-4 bg-pink text-white rounded-2xl font-bold shadow-lg shadow-pink/30 active:scale-95 transition-transform">
                        è¾“å…¥æš—å·ç‰µæ‰‹
                    </button>
                </div>
            );
        }

        // ================= æ ‘æ´ç»„ä»¶ =================
        function TreeHoleView({ messages, onSend }) {
            const [text, setText] = useState('');

            const handleSend = () => {
                if (!text.trim()) return;
                onSend(text);
                setText('');
            };

            return (
                <div className="flex flex-col h-full pb-24">
                    <div className="flex-1 overflow-y-auto hide-scrollbar space-y-3">
                        {messages.map(m => (
                            <MsgCard key={m.id} msg={m} />
                        ))}
                        {messages.length === 0 && (
                            <div className="text-center mt-16 text-textLight opacity-50 text-sm">æ ‘æ´ç©ºç©ºè¡è¡...</div>
                        )}
                    </div>
                    
                    <div className="fixed bottom-6 left-6 right-6 z-20">
                        <div className="glass rounded-full p-2 flex items-center shadow-md">
                            <input 
                                className="flex-1 bg-transparent px-4 py-2 outline-none text-sm"
                                placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
                                value={text}
                                onChange={e => setText(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                            />
                            <button onClick={handleSend} className="w-10 h-10 rounded-full bg-pink text-white flex items-center justify-center active:scale-90 transition-transform">
                                <Icon.Send />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ================= å¾…åŠç»„ä»¶ =================
        function TodoView({ todos, onAdd }) {
            const [text, setText] = useState('');

            const handleAdd = () => {
                if (!text.trim()) return;
                onAdd(text);
                setText('');
            };

            const activeTodos = todos.filter(t => !t.done);
            const doneTodos = todos.filter(t => t.done);

            return (
                <div className="space-y-4 pb-28">
                    <div className="flex gap-2">
                        <input 
                            className="flex-1 bg-white p-3 rounded-xl outline-none text-sm shadow-sm"
                            placeholder="æ·»åŠ å°äº‹..."
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleAdd()}
                        />
                        <button onClick={handleAdd} className="w-12 h-12 rounded-xl bg-blue text-white flex items-center justify-center active:scale-90">
                            <Icon.Plus />
                        </button>
                    </div>
                    
                    <div className="space-y-2">
                        {activeTodos.map(t => (
                            <div key={t.id} className="flex items-center gap-3 bg-white/60 p-3 rounded-xl border border-white/50">
                                <div className="w-5 h-5 rounded-full border-2 border-textLight/30"></div>
                                <span className="text-sm text-text">{t.text}</span>
                            </div>
                        ))}
                    </div>
                    
                    {doneTodos.length > 0 && (
                        <div className="pt-4">
                            <p className="text-xs text-textLight mb-2">å·²å®Œæˆ</p>
                            {doneTodos.map(t => (
                                <div key={t.id} className="flex items-center gap-3 p-3 bg-white/30 rounded-xl opacity-60">
                                    <div className="w-5 h-5 rounded-full bg-green flex items-center justify-center"><Icon.Check /></div>
                                    <span className="text-sm line-through text-textLight">{t.text}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // ================= é€šç”¨ç»„ä»¶ =================
        function NavBtn({ icon, active, onClick }) {
            return (
                <button onClick={onClick} className={`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${active ? 'bg-white shadow-sm text-pink' : 'text-textLight hover:bg-white/50'}`}>
                    {icon}
                </button>
            );
        }

        function MsgCard({ msg }) {
            return (
                <div className={`flex ${msg.self ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] p-3 rounded-2xl shadow-sm text-sm ${msg.self ? 'bg-pink text-white rounded-br-none' : 'bg-white text-text rounded-bl-none'}`}>
                        {msg.text}
                        <div className={`text-[10px] mt-1 ${msg.self ? 'text-white/70' : 'text-textLight/70'}`}>{fmtDate(msg.ts)}</div>
                    </div>
                </div>
            );
        }

        function TodoCardMini({ todo }) {
            return (
                <div className={`flex items-center gap-2 p-2 rounded-lg text-xs ${todo.done ? 'bg-white/20 line-through text-textLight' : 'bg-yellow/30 text-text'}`}>
                    <div className="w-1.5 h-1.5 rounded-full bg-current"></div>
                    <span>{todo.text}</span>
                </div>
            );
        }

        function SettingsView({ anniversary, onSave, onClose }) {
            const [date, setDate] = useState(anniversary ? new Date(anniversary).toISOString().split('T')[0] : '');

            return (
                <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
                    <div className="bg-bg w-full max-w-[420px] h-[70vh] sm:h-auto sm:rounded-t-3xl sm:rounded-b-3xl p-6 anim-slide">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-text">å°çªè®¾ç½®</h2>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white text-textLight flex items-center justify-center">âœ•</button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-sm font-bold text-textLight block mb-2">çºªå¿µæ—¥</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 rounded-xl bg-white border border-gray-100 outline-none text-text"
                                    value={date}
                                    onChange={e => setDate(e.target.value)}
                                />
                                <p className="text-xs text-textLight mt-1">è®¾ç½®æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©</p>
                            </div>
                            
                            <button 
                                onClick={() => onSave(date ? new Date(date).getTime() : Date.now())}
                                className="w-full py-4 bg-pink text-white rounded-2xl font-bold shadow-lg shadow-pink/30 active:scale-95 mt-4"
                            >
                                ä¿å­˜
                            </button>
                            
                            <button 
                                onClick={() => { if(confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) { localforage.clear().then(() => window.location.reload()); } }}
                                className="w-full py-3 text-xs text-red-400 underline mt-4"
                            >
                                æ¸…ç©ºæ‰€æœ‰æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // æ¸²æŸ“
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
